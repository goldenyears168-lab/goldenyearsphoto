{
  "version": 3,
  "sources": ["../bundle-dSuY5c/checked-fetch.js", "../bundle-dSuY5c/middleware-loader.entry.ts", "wrangler-modules-watch:wrangler:modules-watch", "../bundle-dSuY5c/middleware-insertion-facade.js", "../bundle-Ryusmq/checked-fetch.js", "../../../node_modules/@google/generative-ai/dist/index.mjs", "../../../functions/api/lib/llm.ts", "../../../functions/api/lib/knowledge.ts", "../../../functions/api/lib/contextManager.ts", "../../../functions/api/lib/responseTemplates.ts", "../../../functions/api/lib/pipeline.ts", "../../../functions/api/nodes/01-validate-request.ts", "../../../functions/api/nodes/02-initialize-services.ts", "../../../functions/api/nodes/03-context-management.ts", "../../../functions/api/nodes/04-intent-extraction.ts", "../../../functions/api/nodes/05-state-transition.ts", "../../../functions/api/nodes/06-special-intents.ts", "../../../functions/api/nodes/07-faq-check.ts", "../../../functions/api/nodes/08-llm-generation.ts", "../../../functions/api/nodes/09-build-response.ts", "../../../functions/api/nodes/99-error-handler.ts", "../../../functions/api/nodes/index.ts", "../../../functions/api/chat-pipeline.ts", "../../../functions/api/chat.ts", "../../../functions/api/faq-menu.ts", "../pages-PSJ4Kd/functionsRoutes-0.37336205855784055.mjs", "../bundle-Ryusmq/middleware-loader.entry.ts", "../bundle-Ryusmq/middleware-insertion-facade.js", "../../../node_modules/wrangler/templates/pages-template-worker.ts", "../../../node_modules/wrangler/node_modules/path-to-regexp/src/index.ts", "../../../node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../../../node_modules/wrangler/templates/middleware/common.ts", "../../../node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../../../node_modules/wrangler/templates/middleware/common.ts"],
  "sourceRoot": "/Users/jackm4/Documents/GitHub/goldenyearsphoto/.wrangler/tmp/dev-lAPI5l",
  "sourcesContent": ["const urls = new Set();\n\nfunction checkURL(request, init) {\n\tconst url =\n\t\trequest instanceof URL\n\t\t\t? request\n\t\t\t: new URL(\n\t\t\t\t\t(typeof request === \"string\"\n\t\t\t\t\t\t? new Request(request, init)\n\t\t\t\t\t\t: request\n\t\t\t\t\t).url\n\t\t\t\t);\n\tif (url.port && url.port !== \"443\" && url.protocol === \"https:\") {\n\t\tif (!urls.has(url.toString())) {\n\t\t\turls.add(url.toString());\n\t\t\tconsole.warn(\n\t\t\t\t`WARNING: known issue with \\`fetch()\\` requests to custom HTTPS ports in published Workers:\\n` +\n\t\t\t\t\t` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \\`wrangler deploy\\` command.\\n`\n\t\t\t);\n\t\t}\n\t}\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\tconst [request, init] = argArray;\n\t\tcheckURL(request, init);\n\t\treturn Reflect.apply(target, thisArg, argArray);\n\t},\n});\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/.wrangler/tmp/bundle-dSuY5c/middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/node_modules/wrangler/templates/middleware/common.ts\";\nimport type { WorkerEntrypointConstructor } from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/.wrangler/tmp/bundle-dSuY5c/middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/.wrangler/tmp/bundle-dSuY5c/middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n", "", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/.wrangler/tmp/pages-PSJ4Kd/functionsWorker-0.45657729076384224.mjs\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/.wrangler/tmp/pages-PSJ4Kd/functionsWorker-0.45657729076384224.mjs\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "const urls = new Set();\n\nfunction checkURL(request, init) {\n\tconst url =\n\t\trequest instanceof URL\n\t\t\t? request\n\t\t\t: new URL(\n\t\t\t\t\t(typeof request === \"string\"\n\t\t\t\t\t\t? new Request(request, init)\n\t\t\t\t\t\t: request\n\t\t\t\t\t).url\n\t\t\t\t);\n\tif (url.port && url.port !== \"443\" && url.protocol === \"https:\") {\n\t\tif (!urls.has(url.toString())) {\n\t\t\turls.add(url.toString());\n\t\t\tconsole.warn(\n\t\t\t\t`WARNING: known issue with \\`fetch()\\` requests to custom HTTPS ports in published Workers:\\n` +\n\t\t\t\t\t` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \\`wrangler deploy\\` command.\\n`\n\t\t\t);\n\t\t}\n\t}\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\tconst [request, init] = argArray;\n\t\tcheckURL(request, init);\n\t\treturn Reflect.apply(target, thisArg, argArray);\n\t},\n});\n", "/**\n * Contains the list of OpenAPI data types\n * as defined by https://swagger.io/docs/specification/data-models/data-types/\n * @public\n */\nvar SchemaType;\n(function (SchemaType) {\n    /** String type. */\n    SchemaType[\"STRING\"] = \"string\";\n    /** Number type. */\n    SchemaType[\"NUMBER\"] = \"number\";\n    /** Integer type. */\n    SchemaType[\"INTEGER\"] = \"integer\";\n    /** Boolean type. */\n    SchemaType[\"BOOLEAN\"] = \"boolean\";\n    /** Array type. */\n    SchemaType[\"ARRAY\"] = \"array\";\n    /** Object type. */\n    SchemaType[\"OBJECT\"] = \"object\";\n})(SchemaType || (SchemaType = {}));\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * @public\n */\nvar ExecutableCodeLanguage;\n(function (ExecutableCodeLanguage) {\n    ExecutableCodeLanguage[\"LANGUAGE_UNSPECIFIED\"] = \"language_unspecified\";\n    ExecutableCodeLanguage[\"PYTHON\"] = \"python\";\n})(ExecutableCodeLanguage || (ExecutableCodeLanguage = {}));\n/**\n * Possible outcomes of code execution.\n * @public\n */\nvar Outcome;\n(function (Outcome) {\n    /**\n     * Unspecified status. This value should not be used.\n     */\n    Outcome[\"OUTCOME_UNSPECIFIED\"] = \"outcome_unspecified\";\n    /**\n     * Code execution completed successfully.\n     */\n    Outcome[\"OUTCOME_OK\"] = \"outcome_ok\";\n    /**\n     * Code execution finished but with a failure. `stderr` should contain the\n     * reason.\n     */\n    Outcome[\"OUTCOME_FAILED\"] = \"outcome_failed\";\n    /**\n     * Code execution ran for too long, and was cancelled. There may or may not\n     * be a partial output present.\n     */\n    Outcome[\"OUTCOME_DEADLINE_EXCEEDED\"] = \"outcome_deadline_exceeded\";\n})(Outcome || (Outcome = {}));\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Possible roles.\n * @public\n */\nconst POSSIBLE_ROLES = [\"user\", \"model\", \"function\", \"system\"];\n/**\n * Harm categories that would cause prompts or candidates to be blocked.\n * @public\n */\nvar HarmCategory;\n(function (HarmCategory) {\n    HarmCategory[\"HARM_CATEGORY_UNSPECIFIED\"] = \"HARM_CATEGORY_UNSPECIFIED\";\n    HarmCategory[\"HARM_CATEGORY_HATE_SPEECH\"] = \"HARM_CATEGORY_HATE_SPEECH\";\n    HarmCategory[\"HARM_CATEGORY_SEXUALLY_EXPLICIT\"] = \"HARM_CATEGORY_SEXUALLY_EXPLICIT\";\n    HarmCategory[\"HARM_CATEGORY_HARASSMENT\"] = \"HARM_CATEGORY_HARASSMENT\";\n    HarmCategory[\"HARM_CATEGORY_DANGEROUS_CONTENT\"] = \"HARM_CATEGORY_DANGEROUS_CONTENT\";\n})(HarmCategory || (HarmCategory = {}));\n/**\n * Threshold above which a prompt or candidate will be blocked.\n * @public\n */\nvar HarmBlockThreshold;\n(function (HarmBlockThreshold) {\n    // Threshold is unspecified.\n    HarmBlockThreshold[\"HARM_BLOCK_THRESHOLD_UNSPECIFIED\"] = \"HARM_BLOCK_THRESHOLD_UNSPECIFIED\";\n    // Content with NEGLIGIBLE will be allowed.\n    HarmBlockThreshold[\"BLOCK_LOW_AND_ABOVE\"] = \"BLOCK_LOW_AND_ABOVE\";\n    // Content with NEGLIGIBLE and LOW will be allowed.\n    HarmBlockThreshold[\"BLOCK_MEDIUM_AND_ABOVE\"] = \"BLOCK_MEDIUM_AND_ABOVE\";\n    // Content with NEGLIGIBLE, LOW, and MEDIUM will be allowed.\n    HarmBlockThreshold[\"BLOCK_ONLY_HIGH\"] = \"BLOCK_ONLY_HIGH\";\n    // All content will be allowed.\n    HarmBlockThreshold[\"BLOCK_NONE\"] = \"BLOCK_NONE\";\n})(HarmBlockThreshold || (HarmBlockThreshold = {}));\n/**\n * Probability that a prompt or candidate matches a harm category.\n * @public\n */\nvar HarmProbability;\n(function (HarmProbability) {\n    // Probability is unspecified.\n    HarmProbability[\"HARM_PROBABILITY_UNSPECIFIED\"] = \"HARM_PROBABILITY_UNSPECIFIED\";\n    // Content has a negligible chance of being unsafe.\n    HarmProbability[\"NEGLIGIBLE\"] = \"NEGLIGIBLE\";\n    // Content has a low chance of being unsafe.\n    HarmProbability[\"LOW\"] = \"LOW\";\n    // Content has a medium chance of being unsafe.\n    HarmProbability[\"MEDIUM\"] = \"MEDIUM\";\n    // Content has a high chance of being unsafe.\n    HarmProbability[\"HIGH\"] = \"HIGH\";\n})(HarmProbability || (HarmProbability = {}));\n/**\n * Reason that a prompt was blocked.\n * @public\n */\nvar BlockReason;\n(function (BlockReason) {\n    // A blocked reason was not specified.\n    BlockReason[\"BLOCKED_REASON_UNSPECIFIED\"] = \"BLOCKED_REASON_UNSPECIFIED\";\n    // Content was blocked by safety settings.\n    BlockReason[\"SAFETY\"] = \"SAFETY\";\n    // Content was blocked, but the reason is uncategorized.\n    BlockReason[\"OTHER\"] = \"OTHER\";\n})(BlockReason || (BlockReason = {}));\n/**\n * Reason that a candidate finished.\n * @public\n */\nvar FinishReason;\n(function (FinishReason) {\n    // Default value. This value is unused.\n    FinishReason[\"FINISH_REASON_UNSPECIFIED\"] = \"FINISH_REASON_UNSPECIFIED\";\n    // Natural stop point of the model or provided stop sequence.\n    FinishReason[\"STOP\"] = \"STOP\";\n    // The maximum number of tokens as specified in the request was reached.\n    FinishReason[\"MAX_TOKENS\"] = \"MAX_TOKENS\";\n    // The candidate content was flagged for safety reasons.\n    FinishReason[\"SAFETY\"] = \"SAFETY\";\n    // The candidate content was flagged for recitation reasons.\n    FinishReason[\"RECITATION\"] = \"RECITATION\";\n    // The candidate content was flagged for using an unsupported language.\n    FinishReason[\"LANGUAGE\"] = \"LANGUAGE\";\n    // Unknown reason.\n    FinishReason[\"OTHER\"] = \"OTHER\";\n})(FinishReason || (FinishReason = {}));\n/**\n * Task type for embedding content.\n * @public\n */\nvar TaskType;\n(function (TaskType) {\n    TaskType[\"TASK_TYPE_UNSPECIFIED\"] = \"TASK_TYPE_UNSPECIFIED\";\n    TaskType[\"RETRIEVAL_QUERY\"] = \"RETRIEVAL_QUERY\";\n    TaskType[\"RETRIEVAL_DOCUMENT\"] = \"RETRIEVAL_DOCUMENT\";\n    TaskType[\"SEMANTIC_SIMILARITY\"] = \"SEMANTIC_SIMILARITY\";\n    TaskType[\"CLASSIFICATION\"] = \"CLASSIFICATION\";\n    TaskType[\"CLUSTERING\"] = \"CLUSTERING\";\n})(TaskType || (TaskType = {}));\n/**\n * @public\n */\nvar FunctionCallingMode;\n(function (FunctionCallingMode) {\n    // Unspecified function calling mode. This value should not be used.\n    FunctionCallingMode[\"MODE_UNSPECIFIED\"] = \"MODE_UNSPECIFIED\";\n    // Default model behavior, model decides to predict either a function call\n    // or a natural language repspose.\n    FunctionCallingMode[\"AUTO\"] = \"AUTO\";\n    // Model is constrained to always predicting a function call only.\n    // If \"allowed_function_names\" are set, the predicted function call will be\n    // limited to any one of \"allowed_function_names\", else the predicted\n    // function call will be any one of the provided \"function_declarations\".\n    FunctionCallingMode[\"ANY\"] = \"ANY\";\n    // Model will not predict any function call. Model behavior is same as when\n    // not passing any function declarations.\n    FunctionCallingMode[\"NONE\"] = \"NONE\";\n})(FunctionCallingMode || (FunctionCallingMode = {}));\n/**\n * The mode of the predictor to be used in dynamic retrieval.\n * @public\n */\nvar DynamicRetrievalMode;\n(function (DynamicRetrievalMode) {\n    // Unspecified function calling mode. This value should not be used.\n    DynamicRetrievalMode[\"MODE_UNSPECIFIED\"] = \"MODE_UNSPECIFIED\";\n    // Run retrieval only when system decides it is necessary.\n    DynamicRetrievalMode[\"MODE_DYNAMIC\"] = \"MODE_DYNAMIC\";\n})(DynamicRetrievalMode || (DynamicRetrievalMode = {}));\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Basic error type for this SDK.\n * @public\n */\nclass GoogleGenerativeAIError extends Error {\n    constructor(message) {\n        super(`[GoogleGenerativeAI Error]: ${message}`);\n    }\n}\n/**\n * Errors in the contents of a response from the model. This includes parsing\n * errors, or responses including a safety block reason.\n * @public\n */\nclass GoogleGenerativeAIResponseError extends GoogleGenerativeAIError {\n    constructor(message, response) {\n        super(message);\n        this.response = response;\n    }\n}\n/**\n * Error class covering HTTP errors when calling the server. Includes HTTP\n * status, statusText, and optional details, if provided in the server response.\n * @public\n */\nclass GoogleGenerativeAIFetchError extends GoogleGenerativeAIError {\n    constructor(message, status, statusText, errorDetails) {\n        super(message);\n        this.status = status;\n        this.statusText = statusText;\n        this.errorDetails = errorDetails;\n    }\n}\n/**\n * Errors in the contents of a request originating from user input.\n * @public\n */\nclass GoogleGenerativeAIRequestInputError extends GoogleGenerativeAIError {\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nconst DEFAULT_BASE_URL = \"https://generativelanguage.googleapis.com\";\nconst DEFAULT_API_VERSION = \"v1beta\";\n/**\n * We can't `require` package.json if this runs on web. We will use rollup to\n * swap in the version number here at build time.\n */\nconst PACKAGE_VERSION = \"0.21.0\";\nconst PACKAGE_LOG_HEADER = \"genai-js\";\nvar Task;\n(function (Task) {\n    Task[\"GENERATE_CONTENT\"] = \"generateContent\";\n    Task[\"STREAM_GENERATE_CONTENT\"] = \"streamGenerateContent\";\n    Task[\"COUNT_TOKENS\"] = \"countTokens\";\n    Task[\"EMBED_CONTENT\"] = \"embedContent\";\n    Task[\"BATCH_EMBED_CONTENTS\"] = \"batchEmbedContents\";\n})(Task || (Task = {}));\nclass RequestUrl {\n    constructor(model, task, apiKey, stream, requestOptions) {\n        this.model = model;\n        this.task = task;\n        this.apiKey = apiKey;\n        this.stream = stream;\n        this.requestOptions = requestOptions;\n    }\n    toString() {\n        var _a, _b;\n        const apiVersion = ((_a = this.requestOptions) === null || _a === void 0 ? void 0 : _a.apiVersion) || DEFAULT_API_VERSION;\n        const baseUrl = ((_b = this.requestOptions) === null || _b === void 0 ? void 0 : _b.baseUrl) || DEFAULT_BASE_URL;\n        let url = `${baseUrl}/${apiVersion}/${this.model}:${this.task}`;\n        if (this.stream) {\n            url += \"?alt=sse\";\n        }\n        return url;\n    }\n}\n/**\n * Simple, but may become more complex if we add more versions to log.\n */\nfunction getClientHeaders(requestOptions) {\n    const clientHeaders = [];\n    if (requestOptions === null || requestOptions === void 0 ? void 0 : requestOptions.apiClient) {\n        clientHeaders.push(requestOptions.apiClient);\n    }\n    clientHeaders.push(`${PACKAGE_LOG_HEADER}/${PACKAGE_VERSION}`);\n    return clientHeaders.join(\" \");\n}\nasync function getHeaders(url) {\n    var _a;\n    const headers = new Headers();\n    headers.append(\"Content-Type\", \"application/json\");\n    headers.append(\"x-goog-api-client\", getClientHeaders(url.requestOptions));\n    headers.append(\"x-goog-api-key\", url.apiKey);\n    let customHeaders = (_a = url.requestOptions) === null || _a === void 0 ? void 0 : _a.customHeaders;\n    if (customHeaders) {\n        if (!(customHeaders instanceof Headers)) {\n            try {\n                customHeaders = new Headers(customHeaders);\n            }\n            catch (e) {\n                throw new GoogleGenerativeAIRequestInputError(`unable to convert customHeaders value ${JSON.stringify(customHeaders)} to Headers: ${e.message}`);\n            }\n        }\n        for (const [headerName, headerValue] of customHeaders.entries()) {\n            if (headerName === \"x-goog-api-key\") {\n                throw new GoogleGenerativeAIRequestInputError(`Cannot set reserved header name ${headerName}`);\n            }\n            else if (headerName === \"x-goog-api-client\") {\n                throw new GoogleGenerativeAIRequestInputError(`Header name ${headerName} can only be set using the apiClient field`);\n            }\n            headers.append(headerName, headerValue);\n        }\n    }\n    return headers;\n}\nasync function constructModelRequest(model, task, apiKey, stream, body, requestOptions) {\n    const url = new RequestUrl(model, task, apiKey, stream, requestOptions);\n    return {\n        url: url.toString(),\n        fetchOptions: Object.assign(Object.assign({}, buildFetchOptions(requestOptions)), { method: \"POST\", headers: await getHeaders(url), body }),\n    };\n}\nasync function makeModelRequest(model, task, apiKey, stream, body, requestOptions = {}, \n// Allows this to be stubbed for tests\nfetchFn = fetch) {\n    const { url, fetchOptions } = await constructModelRequest(model, task, apiKey, stream, body, requestOptions);\n    return makeRequest(url, fetchOptions, fetchFn);\n}\nasync function makeRequest(url, fetchOptions, fetchFn = fetch) {\n    let response;\n    try {\n        response = await fetchFn(url, fetchOptions);\n    }\n    catch (e) {\n        handleResponseError(e, url);\n    }\n    if (!response.ok) {\n        await handleResponseNotOk(response, url);\n    }\n    return response;\n}\nfunction handleResponseError(e, url) {\n    let err = e;\n    if (!(e instanceof GoogleGenerativeAIFetchError ||\n        e instanceof GoogleGenerativeAIRequestInputError)) {\n        err = new GoogleGenerativeAIError(`Error fetching from ${url.toString()}: ${e.message}`);\n        err.stack = e.stack;\n    }\n    throw err;\n}\nasync function handleResponseNotOk(response, url) {\n    let message = \"\";\n    let errorDetails;\n    try {\n        const json = await response.json();\n        message = json.error.message;\n        if (json.error.details) {\n            message += ` ${JSON.stringify(json.error.details)}`;\n            errorDetails = json.error.details;\n        }\n    }\n    catch (e) {\n        // ignored\n    }\n    throw new GoogleGenerativeAIFetchError(`Error fetching from ${url.toString()}: [${response.status} ${response.statusText}] ${message}`, response.status, response.statusText, errorDetails);\n}\n/**\n * Generates the request options to be passed to the fetch API.\n * @param requestOptions - The user-defined request options.\n * @returns The generated request options.\n */\nfunction buildFetchOptions(requestOptions) {\n    const fetchOptions = {};\n    if ((requestOptions === null || requestOptions === void 0 ? void 0 : requestOptions.signal) !== undefined || (requestOptions === null || requestOptions === void 0 ? void 0 : requestOptions.timeout) >= 0) {\n        const controller = new AbortController();\n        if ((requestOptions === null || requestOptions === void 0 ? void 0 : requestOptions.timeout) >= 0) {\n            setTimeout(() => controller.abort(), requestOptions.timeout);\n        }\n        if (requestOptions === null || requestOptions === void 0 ? void 0 : requestOptions.signal) {\n            requestOptions.signal.addEventListener(\"abort\", () => {\n                controller.abort();\n            });\n        }\n        fetchOptions.signal = controller.signal;\n    }\n    return fetchOptions;\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Adds convenience helper methods to a response object, including stream\n * chunks (as long as each chunk is a complete GenerateContentResponse JSON).\n */\nfunction addHelpers(response) {\n    response.text = () => {\n        if (response.candidates && response.candidates.length > 0) {\n            if (response.candidates.length > 1) {\n                console.warn(`This response had ${response.candidates.length} ` +\n                    `candidates. Returning text from the first candidate only. ` +\n                    `Access response.candidates directly to use the other candidates.`);\n            }\n            if (hadBadFinishReason(response.candidates[0])) {\n                throw new GoogleGenerativeAIResponseError(`${formatBlockErrorMessage(response)}`, response);\n            }\n            return getText(response);\n        }\n        else if (response.promptFeedback) {\n            throw new GoogleGenerativeAIResponseError(`Text not available. ${formatBlockErrorMessage(response)}`, response);\n        }\n        return \"\";\n    };\n    /**\n     * TODO: remove at next major version\n     */\n    response.functionCall = () => {\n        if (response.candidates && response.candidates.length > 0) {\n            if (response.candidates.length > 1) {\n                console.warn(`This response had ${response.candidates.length} ` +\n                    `candidates. Returning function calls from the first candidate only. ` +\n                    `Access response.candidates directly to use the other candidates.`);\n            }\n            if (hadBadFinishReason(response.candidates[0])) {\n                throw new GoogleGenerativeAIResponseError(`${formatBlockErrorMessage(response)}`, response);\n            }\n            console.warn(`response.functionCall() is deprecated. ` +\n                `Use response.functionCalls() instead.`);\n            return getFunctionCalls(response)[0];\n        }\n        else if (response.promptFeedback) {\n            throw new GoogleGenerativeAIResponseError(`Function call not available. ${formatBlockErrorMessage(response)}`, response);\n        }\n        return undefined;\n    };\n    response.functionCalls = () => {\n        if (response.candidates && response.candidates.length > 0) {\n            if (response.candidates.length > 1) {\n                console.warn(`This response had ${response.candidates.length} ` +\n                    `candidates. Returning function calls from the first candidate only. ` +\n                    `Access response.candidates directly to use the other candidates.`);\n            }\n            if (hadBadFinishReason(response.candidates[0])) {\n                throw new GoogleGenerativeAIResponseError(`${formatBlockErrorMessage(response)}`, response);\n            }\n            return getFunctionCalls(response);\n        }\n        else if (response.promptFeedback) {\n            throw new GoogleGenerativeAIResponseError(`Function call not available. ${formatBlockErrorMessage(response)}`, response);\n        }\n        return undefined;\n    };\n    return response;\n}\n/**\n * Returns all text found in all parts of first candidate.\n */\nfunction getText(response) {\n    var _a, _b, _c, _d;\n    const textStrings = [];\n    if ((_b = (_a = response.candidates) === null || _a === void 0 ? void 0 : _a[0].content) === null || _b === void 0 ? void 0 : _b.parts) {\n        for (const part of (_d = (_c = response.candidates) === null || _c === void 0 ? void 0 : _c[0].content) === null || _d === void 0 ? void 0 : _d.parts) {\n            if (part.text) {\n                textStrings.push(part.text);\n            }\n            if (part.executableCode) {\n                textStrings.push(\"\\n```\" +\n                    part.executableCode.language +\n                    \"\\n\" +\n                    part.executableCode.code +\n                    \"\\n```\\n\");\n            }\n            if (part.codeExecutionResult) {\n                textStrings.push(\"\\n```\\n\" + part.codeExecutionResult.output + \"\\n```\\n\");\n            }\n        }\n    }\n    if (textStrings.length > 0) {\n        return textStrings.join(\"\");\n    }\n    else {\n        return \"\";\n    }\n}\n/**\n * Returns functionCall of first candidate.\n */\nfunction getFunctionCalls(response) {\n    var _a, _b, _c, _d;\n    const functionCalls = [];\n    if ((_b = (_a = response.candidates) === null || _a === void 0 ? void 0 : _a[0].content) === null || _b === void 0 ? void 0 : _b.parts) {\n        for (const part of (_d = (_c = response.candidates) === null || _c === void 0 ? void 0 : _c[0].content) === null || _d === void 0 ? void 0 : _d.parts) {\n            if (part.functionCall) {\n                functionCalls.push(part.functionCall);\n            }\n        }\n    }\n    if (functionCalls.length > 0) {\n        return functionCalls;\n    }\n    else {\n        return undefined;\n    }\n}\nconst badFinishReasons = [\n    FinishReason.RECITATION,\n    FinishReason.SAFETY,\n    FinishReason.LANGUAGE,\n];\nfunction hadBadFinishReason(candidate) {\n    return (!!candidate.finishReason &&\n        badFinishReasons.includes(candidate.finishReason));\n}\nfunction formatBlockErrorMessage(response) {\n    var _a, _b, _c;\n    let message = \"\";\n    if ((!response.candidates || response.candidates.length === 0) &&\n        response.promptFeedback) {\n        message += \"Response was blocked\";\n        if ((_a = response.promptFeedback) === null || _a === void 0 ? void 0 : _a.blockReason) {\n            message += ` due to ${response.promptFeedback.blockReason}`;\n        }\n        if ((_b = response.promptFeedback) === null || _b === void 0 ? void 0 : _b.blockReasonMessage) {\n            message += `: ${response.promptFeedback.blockReasonMessage}`;\n        }\n    }\n    else if ((_c = response.candidates) === null || _c === void 0 ? void 0 : _c[0]) {\n        const firstCandidate = response.candidates[0];\n        if (hadBadFinishReason(firstCandidate)) {\n            message += `Candidate was blocked due to ${firstCandidate.finishReason}`;\n            if (firstCandidate.finishMessage) {\n                message += `: ${firstCandidate.finishMessage}`;\n            }\n        }\n    }\n    return message;\n}\n\n/******************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise, SuppressedError, Symbol */\r\n\r\n\r\nfunction __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nfunction __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\ntypeof SuppressedError === \"function\" ? SuppressedError : function (error, suppressed, message) {\r\n    var e = new Error(message);\r\n    return e.name = \"SuppressedError\", e.error = error, e.suppressed = suppressed, e;\r\n};\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nconst responseLineRE = /^data\\: (.*)(?:\\n\\n|\\r\\r|\\r\\n\\r\\n)/;\n/**\n * Process a response.body stream from the backend and return an\n * iterator that provides one complete GenerateContentResponse at a time\n * and a promise that resolves with a single aggregated\n * GenerateContentResponse.\n *\n * @param response - Response from a fetch call\n */\nfunction processStream(response) {\n    const inputStream = response.body.pipeThrough(new TextDecoderStream(\"utf8\", { fatal: true }));\n    const responseStream = getResponseStream(inputStream);\n    const [stream1, stream2] = responseStream.tee();\n    return {\n        stream: generateResponseSequence(stream1),\n        response: getResponsePromise(stream2),\n    };\n}\nasync function getResponsePromise(stream) {\n    const allResponses = [];\n    const reader = stream.getReader();\n    while (true) {\n        const { done, value } = await reader.read();\n        if (done) {\n            return addHelpers(aggregateResponses(allResponses));\n        }\n        allResponses.push(value);\n    }\n}\nfunction generateResponseSequence(stream) {\n    return __asyncGenerator(this, arguments, function* generateResponseSequence_1() {\n        const reader = stream.getReader();\n        while (true) {\n            const { value, done } = yield __await(reader.read());\n            if (done) {\n                break;\n            }\n            yield yield __await(addHelpers(value));\n        }\n    });\n}\n/**\n * Reads a raw stream from the fetch response and join incomplete\n * chunks, returning a new stream that provides a single complete\n * GenerateContentResponse in each iteration.\n */\nfunction getResponseStream(inputStream) {\n    const reader = inputStream.getReader();\n    const stream = new ReadableStream({\n        start(controller) {\n            let currentText = \"\";\n            return pump();\n            function pump() {\n                return reader.read().then(({ value, done }) => {\n                    if (done) {\n                        if (currentText.trim()) {\n                            controller.error(new GoogleGenerativeAIError(\"Failed to parse stream\"));\n                            return;\n                        }\n                        controller.close();\n                        return;\n                    }\n                    currentText += value;\n                    let match = currentText.match(responseLineRE);\n                    let parsedResponse;\n                    while (match) {\n                        try {\n                            parsedResponse = JSON.parse(match[1]);\n                        }\n                        catch (e) {\n                            controller.error(new GoogleGenerativeAIError(`Error parsing JSON response: \"${match[1]}\"`));\n                            return;\n                        }\n                        controller.enqueue(parsedResponse);\n                        currentText = currentText.substring(match[0].length);\n                        match = currentText.match(responseLineRE);\n                    }\n                    return pump();\n                });\n            }\n        },\n    });\n    return stream;\n}\n/**\n * Aggregates an array of `GenerateContentResponse`s into a single\n * GenerateContentResponse.\n */\nfunction aggregateResponses(responses) {\n    const lastResponse = responses[responses.length - 1];\n    const aggregatedResponse = {\n        promptFeedback: lastResponse === null || lastResponse === void 0 ? void 0 : lastResponse.promptFeedback,\n    };\n    for (const response of responses) {\n        if (response.candidates) {\n            for (const candidate of response.candidates) {\n                const i = candidate.index;\n                if (!aggregatedResponse.candidates) {\n                    aggregatedResponse.candidates = [];\n                }\n                if (!aggregatedResponse.candidates[i]) {\n                    aggregatedResponse.candidates[i] = {\n                        index: candidate.index,\n                    };\n                }\n                // Keep overwriting, the last one will be final\n                aggregatedResponse.candidates[i].citationMetadata =\n                    candidate.citationMetadata;\n                aggregatedResponse.candidates[i].groundingMetadata =\n                    candidate.groundingMetadata;\n                aggregatedResponse.candidates[i].finishReason = candidate.finishReason;\n                aggregatedResponse.candidates[i].finishMessage =\n                    candidate.finishMessage;\n                aggregatedResponse.candidates[i].safetyRatings =\n                    candidate.safetyRatings;\n                /**\n                 * Candidates should always have content and parts, but this handles\n                 * possible malformed responses.\n                 */\n                if (candidate.content && candidate.content.parts) {\n                    if (!aggregatedResponse.candidates[i].content) {\n                        aggregatedResponse.candidates[i].content = {\n                            role: candidate.content.role || \"user\",\n                            parts: [],\n                        };\n                    }\n                    const newPart = {};\n                    for (const part of candidate.content.parts) {\n                        if (part.text) {\n                            newPart.text = part.text;\n                        }\n                        if (part.functionCall) {\n                            newPart.functionCall = part.functionCall;\n                        }\n                        if (part.executableCode) {\n                            newPart.executableCode = part.executableCode;\n                        }\n                        if (part.codeExecutionResult) {\n                            newPart.codeExecutionResult = part.codeExecutionResult;\n                        }\n                        if (Object.keys(newPart).length === 0) {\n                            newPart.text = \"\";\n                        }\n                        aggregatedResponse.candidates[i].content.parts.push(newPart);\n                    }\n                }\n            }\n        }\n        if (response.usageMetadata) {\n            aggregatedResponse.usageMetadata = response.usageMetadata;\n        }\n    }\n    return aggregatedResponse;\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nasync function generateContentStream(apiKey, model, params, requestOptions) {\n    const response = await makeModelRequest(model, Task.STREAM_GENERATE_CONTENT, apiKey, \n    /* stream */ true, JSON.stringify(params), requestOptions);\n    return processStream(response);\n}\nasync function generateContent(apiKey, model, params, requestOptions) {\n    const response = await makeModelRequest(model, Task.GENERATE_CONTENT, apiKey, \n    /* stream */ false, JSON.stringify(params), requestOptions);\n    const responseJson = await response.json();\n    const enhancedResponse = addHelpers(responseJson);\n    return {\n        response: enhancedResponse,\n    };\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nfunction formatSystemInstruction(input) {\n    // null or undefined\n    if (input == null) {\n        return undefined;\n    }\n    else if (typeof input === \"string\") {\n        return { role: \"system\", parts: [{ text: input }] };\n    }\n    else if (input.text) {\n        return { role: \"system\", parts: [input] };\n    }\n    else if (input.parts) {\n        if (!input.role) {\n            return { role: \"system\", parts: input.parts };\n        }\n        else {\n            return input;\n        }\n    }\n}\nfunction formatNewContent(request) {\n    let newParts = [];\n    if (typeof request === \"string\") {\n        newParts = [{ text: request }];\n    }\n    else {\n        for (const partOrString of request) {\n            if (typeof partOrString === \"string\") {\n                newParts.push({ text: partOrString });\n            }\n            else {\n                newParts.push(partOrString);\n            }\n        }\n    }\n    return assignRoleToPartsAndValidateSendMessageRequest(newParts);\n}\n/**\n * When multiple Part types (i.e. FunctionResponsePart and TextPart) are\n * passed in a single Part array, we may need to assign different roles to each\n * part. Currently only FunctionResponsePart requires a role other than 'user'.\n * @private\n * @param parts Array of parts to pass to the model\n * @returns Array of content items\n */\nfunction assignRoleToPartsAndValidateSendMessageRequest(parts) {\n    const userContent = { role: \"user\", parts: [] };\n    const functionContent = { role: \"function\", parts: [] };\n    let hasUserContent = false;\n    let hasFunctionContent = false;\n    for (const part of parts) {\n        if (\"functionResponse\" in part) {\n            functionContent.parts.push(part);\n            hasFunctionContent = true;\n        }\n        else {\n            userContent.parts.push(part);\n            hasUserContent = true;\n        }\n    }\n    if (hasUserContent && hasFunctionContent) {\n        throw new GoogleGenerativeAIError(\"Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.\");\n    }\n    if (!hasUserContent && !hasFunctionContent) {\n        throw new GoogleGenerativeAIError(\"No content is provided for sending chat message.\");\n    }\n    if (hasUserContent) {\n        return userContent;\n    }\n    return functionContent;\n}\nfunction formatCountTokensInput(params, modelParams) {\n    var _a;\n    let formattedGenerateContentRequest = {\n        model: modelParams === null || modelParams === void 0 ? void 0 : modelParams.model,\n        generationConfig: modelParams === null || modelParams === void 0 ? void 0 : modelParams.generationConfig,\n        safetySettings: modelParams === null || modelParams === void 0 ? void 0 : modelParams.safetySettings,\n        tools: modelParams === null || modelParams === void 0 ? void 0 : modelParams.tools,\n        toolConfig: modelParams === null || modelParams === void 0 ? void 0 : modelParams.toolConfig,\n        systemInstruction: modelParams === null || modelParams === void 0 ? void 0 : modelParams.systemInstruction,\n        cachedContent: (_a = modelParams === null || modelParams === void 0 ? void 0 : modelParams.cachedContent) === null || _a === void 0 ? void 0 : _a.name,\n        contents: [],\n    };\n    const containsGenerateContentRequest = params.generateContentRequest != null;\n    if (params.contents) {\n        if (containsGenerateContentRequest) {\n            throw new GoogleGenerativeAIRequestInputError(\"CountTokensRequest must have one of contents or generateContentRequest, not both.\");\n        }\n        formattedGenerateContentRequest.contents = params.contents;\n    }\n    else if (containsGenerateContentRequest) {\n        formattedGenerateContentRequest = Object.assign(Object.assign({}, formattedGenerateContentRequest), params.generateContentRequest);\n    }\n    else {\n        // Array or string\n        const content = formatNewContent(params);\n        formattedGenerateContentRequest.contents = [content];\n    }\n    return { generateContentRequest: formattedGenerateContentRequest };\n}\nfunction formatGenerateContentInput(params) {\n    let formattedRequest;\n    if (params.contents) {\n        formattedRequest = params;\n    }\n    else {\n        // Array or string\n        const content = formatNewContent(params);\n        formattedRequest = { contents: [content] };\n    }\n    if (params.systemInstruction) {\n        formattedRequest.systemInstruction = formatSystemInstruction(params.systemInstruction);\n    }\n    return formattedRequest;\n}\nfunction formatEmbedContentInput(params) {\n    if (typeof params === \"string\" || Array.isArray(params)) {\n        const content = formatNewContent(params);\n        return { content };\n    }\n    return params;\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n// https://ai.google.dev/api/rest/v1beta/Content#part\nconst VALID_PART_FIELDS = [\n    \"text\",\n    \"inlineData\",\n    \"functionCall\",\n    \"functionResponse\",\n    \"executableCode\",\n    \"codeExecutionResult\",\n];\nconst VALID_PARTS_PER_ROLE = {\n    user: [\"text\", \"inlineData\"],\n    function: [\"functionResponse\"],\n    model: [\"text\", \"functionCall\", \"executableCode\", \"codeExecutionResult\"],\n    // System instructions shouldn't be in history anyway.\n    system: [\"text\"],\n};\nfunction validateChatHistory(history) {\n    let prevContent = false;\n    for (const currContent of history) {\n        const { role, parts } = currContent;\n        if (!prevContent && role !== \"user\") {\n            throw new GoogleGenerativeAIError(`First content should be with role 'user', got ${role}`);\n        }\n        if (!POSSIBLE_ROLES.includes(role)) {\n            throw new GoogleGenerativeAIError(`Each item should include role field. Got ${role} but valid roles are: ${JSON.stringify(POSSIBLE_ROLES)}`);\n        }\n        if (!Array.isArray(parts)) {\n            throw new GoogleGenerativeAIError(\"Content should have 'parts' property with an array of Parts\");\n        }\n        if (parts.length === 0) {\n            throw new GoogleGenerativeAIError(\"Each Content should have at least one part\");\n        }\n        const countFields = {\n            text: 0,\n            inlineData: 0,\n            functionCall: 0,\n            functionResponse: 0,\n            fileData: 0,\n            executableCode: 0,\n            codeExecutionResult: 0,\n        };\n        for (const part of parts) {\n            for (const key of VALID_PART_FIELDS) {\n                if (key in part) {\n                    countFields[key] += 1;\n                }\n            }\n        }\n        const validParts = VALID_PARTS_PER_ROLE[role];\n        for (const key of VALID_PART_FIELDS) {\n            if (!validParts.includes(key) && countFields[key] > 0) {\n                throw new GoogleGenerativeAIError(`Content with role '${role}' can't contain '${key}' part`);\n            }\n        }\n        prevContent = true;\n    }\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Do not log a message for this error.\n */\nconst SILENT_ERROR = \"SILENT_ERROR\";\n/**\n * ChatSession class that enables sending chat messages and stores\n * history of sent and received messages so far.\n *\n * @public\n */\nclass ChatSession {\n    constructor(apiKey, model, params, _requestOptions = {}) {\n        this.model = model;\n        this.params = params;\n        this._requestOptions = _requestOptions;\n        this._history = [];\n        this._sendPromise = Promise.resolve();\n        this._apiKey = apiKey;\n        if (params === null || params === void 0 ? void 0 : params.history) {\n            validateChatHistory(params.history);\n            this._history = params.history;\n        }\n    }\n    /**\n     * Gets the chat history so far. Blocked prompts are not added to history.\n     * Blocked candidates are not added to history, nor are the prompts that\n     * generated them.\n     */\n    async getHistory() {\n        await this._sendPromise;\n        return this._history;\n    }\n    /**\n     * Sends a chat message and receives a non-streaming\n     * {@link GenerateContentResult}.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async sendMessage(request, requestOptions = {}) {\n        var _a, _b, _c, _d, _e, _f;\n        await this._sendPromise;\n        const newContent = formatNewContent(request);\n        const generateContentRequest = {\n            safetySettings: (_a = this.params) === null || _a === void 0 ? void 0 : _a.safetySettings,\n            generationConfig: (_b = this.params) === null || _b === void 0 ? void 0 : _b.generationConfig,\n            tools: (_c = this.params) === null || _c === void 0 ? void 0 : _c.tools,\n            toolConfig: (_d = this.params) === null || _d === void 0 ? void 0 : _d.toolConfig,\n            systemInstruction: (_e = this.params) === null || _e === void 0 ? void 0 : _e.systemInstruction,\n            cachedContent: (_f = this.params) === null || _f === void 0 ? void 0 : _f.cachedContent,\n            contents: [...this._history, newContent],\n        };\n        const chatSessionRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        let finalResult;\n        // Add onto the chain.\n        this._sendPromise = this._sendPromise\n            .then(() => generateContent(this._apiKey, this.model, generateContentRequest, chatSessionRequestOptions))\n            .then((result) => {\n            var _a;\n            if (result.response.candidates &&\n                result.response.candidates.length > 0) {\n                this._history.push(newContent);\n                const responseContent = Object.assign({ parts: [], \n                    // Response seems to come back without a role set.\n                    role: \"model\" }, (_a = result.response.candidates) === null || _a === void 0 ? void 0 : _a[0].content);\n                this._history.push(responseContent);\n            }\n            else {\n                const blockErrorMessage = formatBlockErrorMessage(result.response);\n                if (blockErrorMessage) {\n                    console.warn(`sendMessage() was unsuccessful. ${blockErrorMessage}. Inspect response object for details.`);\n                }\n            }\n            finalResult = result;\n        });\n        await this._sendPromise;\n        return finalResult;\n    }\n    /**\n     * Sends a chat message and receives the response as a\n     * {@link GenerateContentStreamResult} containing an iterable stream\n     * and a response promise.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async sendMessageStream(request, requestOptions = {}) {\n        var _a, _b, _c, _d, _e, _f;\n        await this._sendPromise;\n        const newContent = formatNewContent(request);\n        const generateContentRequest = {\n            safetySettings: (_a = this.params) === null || _a === void 0 ? void 0 : _a.safetySettings,\n            generationConfig: (_b = this.params) === null || _b === void 0 ? void 0 : _b.generationConfig,\n            tools: (_c = this.params) === null || _c === void 0 ? void 0 : _c.tools,\n            toolConfig: (_d = this.params) === null || _d === void 0 ? void 0 : _d.toolConfig,\n            systemInstruction: (_e = this.params) === null || _e === void 0 ? void 0 : _e.systemInstruction,\n            cachedContent: (_f = this.params) === null || _f === void 0 ? void 0 : _f.cachedContent,\n            contents: [...this._history, newContent],\n        };\n        const chatSessionRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        const streamPromise = generateContentStream(this._apiKey, this.model, generateContentRequest, chatSessionRequestOptions);\n        // Add onto the chain.\n        this._sendPromise = this._sendPromise\n            .then(() => streamPromise)\n            // This must be handled to avoid unhandled rejection, but jump\n            // to the final catch block with a label to not log this error.\n            .catch((_ignored) => {\n            throw new Error(SILENT_ERROR);\n        })\n            .then((streamResult) => streamResult.response)\n            .then((response) => {\n            if (response.candidates && response.candidates.length > 0) {\n                this._history.push(newContent);\n                const responseContent = Object.assign({}, response.candidates[0].content);\n                // Response seems to come back without a role set.\n                if (!responseContent.role) {\n                    responseContent.role = \"model\";\n                }\n                this._history.push(responseContent);\n            }\n            else {\n                const blockErrorMessage = formatBlockErrorMessage(response);\n                if (blockErrorMessage) {\n                    console.warn(`sendMessageStream() was unsuccessful. ${blockErrorMessage}. Inspect response object for details.`);\n                }\n            }\n        })\n            .catch((e) => {\n            // Errors in streamPromise are already catchable by the user as\n            // streamPromise is returned.\n            // Avoid duplicating the error message in logs.\n            if (e.message !== SILENT_ERROR) {\n                // Users do not have access to _sendPromise to catch errors\n                // downstream from streamPromise, so they should not throw.\n                console.error(e);\n            }\n        });\n        return streamPromise;\n    }\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nasync function countTokens(apiKey, model, params, singleRequestOptions) {\n    const response = await makeModelRequest(model, Task.COUNT_TOKENS, apiKey, false, JSON.stringify(params), singleRequestOptions);\n    return response.json();\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nasync function embedContent(apiKey, model, params, requestOptions) {\n    const response = await makeModelRequest(model, Task.EMBED_CONTENT, apiKey, false, JSON.stringify(params), requestOptions);\n    return response.json();\n}\nasync function batchEmbedContents(apiKey, model, params, requestOptions) {\n    const requestsWithModel = params.requests.map((request) => {\n        return Object.assign(Object.assign({}, request), { model });\n    });\n    const response = await makeModelRequest(model, Task.BATCH_EMBED_CONTENTS, apiKey, false, JSON.stringify({ requests: requestsWithModel }), requestOptions);\n    return response.json();\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Class for generative model APIs.\n * @public\n */\nclass GenerativeModel {\n    constructor(apiKey, modelParams, _requestOptions = {}) {\n        this.apiKey = apiKey;\n        this._requestOptions = _requestOptions;\n        if (modelParams.model.includes(\"/\")) {\n            // Models may be named \"models/model-name\" or \"tunedModels/model-name\"\n            this.model = modelParams.model;\n        }\n        else {\n            // If path is not included, assume it's a non-tuned model.\n            this.model = `models/${modelParams.model}`;\n        }\n        this.generationConfig = modelParams.generationConfig || {};\n        this.safetySettings = modelParams.safetySettings || [];\n        this.tools = modelParams.tools;\n        this.toolConfig = modelParams.toolConfig;\n        this.systemInstruction = formatSystemInstruction(modelParams.systemInstruction);\n        this.cachedContent = modelParams.cachedContent;\n    }\n    /**\n     * Makes a single non-streaming call to the model\n     * and returns an object containing a single {@link GenerateContentResponse}.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async generateContent(request, requestOptions = {}) {\n        var _a;\n        const formattedParams = formatGenerateContentInput(request);\n        const generativeModelRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        return generateContent(this.apiKey, this.model, Object.assign({ generationConfig: this.generationConfig, safetySettings: this.safetySettings, tools: this.tools, toolConfig: this.toolConfig, systemInstruction: this.systemInstruction, cachedContent: (_a = this.cachedContent) === null || _a === void 0 ? void 0 : _a.name }, formattedParams), generativeModelRequestOptions);\n    }\n    /**\n     * Makes a single streaming call to the model and returns an object\n     * containing an iterable stream that iterates over all chunks in the\n     * streaming response as well as a promise that returns the final\n     * aggregated response.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async generateContentStream(request, requestOptions = {}) {\n        var _a;\n        const formattedParams = formatGenerateContentInput(request);\n        const generativeModelRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        return generateContentStream(this.apiKey, this.model, Object.assign({ generationConfig: this.generationConfig, safetySettings: this.safetySettings, tools: this.tools, toolConfig: this.toolConfig, systemInstruction: this.systemInstruction, cachedContent: (_a = this.cachedContent) === null || _a === void 0 ? void 0 : _a.name }, formattedParams), generativeModelRequestOptions);\n    }\n    /**\n     * Gets a new {@link ChatSession} instance which can be used for\n     * multi-turn chats.\n     */\n    startChat(startChatParams) {\n        var _a;\n        return new ChatSession(this.apiKey, this.model, Object.assign({ generationConfig: this.generationConfig, safetySettings: this.safetySettings, tools: this.tools, toolConfig: this.toolConfig, systemInstruction: this.systemInstruction, cachedContent: (_a = this.cachedContent) === null || _a === void 0 ? void 0 : _a.name }, startChatParams), this._requestOptions);\n    }\n    /**\n     * Counts the tokens in the provided request.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async countTokens(request, requestOptions = {}) {\n        const formattedParams = formatCountTokensInput(request, {\n            model: this.model,\n            generationConfig: this.generationConfig,\n            safetySettings: this.safetySettings,\n            tools: this.tools,\n            toolConfig: this.toolConfig,\n            systemInstruction: this.systemInstruction,\n            cachedContent: this.cachedContent,\n        });\n        const generativeModelRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        return countTokens(this.apiKey, this.model, formattedParams, generativeModelRequestOptions);\n    }\n    /**\n     * Embeds the provided content.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async embedContent(request, requestOptions = {}) {\n        const formattedParams = formatEmbedContentInput(request);\n        const generativeModelRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        return embedContent(this.apiKey, this.model, formattedParams, generativeModelRequestOptions);\n    }\n    /**\n     * Embeds an array of {@link EmbedContentRequest}s.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async batchEmbedContents(batchEmbedContentRequest, requestOptions = {}) {\n        const generativeModelRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        return batchEmbedContents(this.apiKey, this.model, batchEmbedContentRequest, generativeModelRequestOptions);\n    }\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Top-level class for this SDK\n * @public\n */\nclass GoogleGenerativeAI {\n    constructor(apiKey) {\n        this.apiKey = apiKey;\n    }\n    /**\n     * Gets a {@link GenerativeModel} instance for the provided model name.\n     */\n    getGenerativeModel(modelParams, requestOptions) {\n        if (!modelParams.model) {\n            throw new GoogleGenerativeAIError(`Must provide a model name. ` +\n                `Example: genai.getGenerativeModel({ model: 'my-model-name' })`);\n        }\n        return new GenerativeModel(this.apiKey, modelParams, requestOptions);\n    }\n    /**\n     * Creates a {@link GenerativeModel} instance from provided content cache.\n     */\n    getGenerativeModelFromCachedContent(cachedContent, modelParams, requestOptions) {\n        if (!cachedContent.name) {\n            throw new GoogleGenerativeAIRequestInputError(\"Cached content must contain a `name` field.\");\n        }\n        if (!cachedContent.model) {\n            throw new GoogleGenerativeAIRequestInputError(\"Cached content must contain a `model` field.\");\n        }\n        /**\n         * Not checking tools and toolConfig for now as it would require a deep\n         * equality comparison and isn't likely to be a common case.\n         */\n        const disallowedDuplicates = [\"model\", \"systemInstruction\"];\n        for (const key of disallowedDuplicates) {\n            if ((modelParams === null || modelParams === void 0 ? void 0 : modelParams[key]) &&\n                cachedContent[key] &&\n                (modelParams === null || modelParams === void 0 ? void 0 : modelParams[key]) !== cachedContent[key]) {\n                if (key === \"model\") {\n                    const modelParamsComp = modelParams.model.startsWith(\"models/\")\n                        ? modelParams.model.replace(\"models/\", \"\")\n                        : modelParams.model;\n                    const cachedContentComp = cachedContent.model.startsWith(\"models/\")\n                        ? cachedContent.model.replace(\"models/\", \"\")\n                        : cachedContent.model;\n                    if (modelParamsComp === cachedContentComp) {\n                        continue;\n                    }\n                }\n                throw new GoogleGenerativeAIRequestInputError(`Different value for \"${key}\" specified in modelParams` +\n                    ` (${modelParams[key]}) and cachedContent (${cachedContent[key]})`);\n            }\n        }\n        const modelParamsFromCache = Object.assign(Object.assign({}, modelParams), { model: cachedContent.model, tools: cachedContent.tools, toolConfig: cachedContent.toolConfig, systemInstruction: cachedContent.systemInstruction, cachedContent });\n        return new GenerativeModel(this.apiKey, modelParamsFromCache, requestOptions);\n    }\n}\n\nexport { BlockReason, ChatSession, DynamicRetrievalMode, ExecutableCodeLanguage, FinishReason, FunctionCallingMode, GenerativeModel, GoogleGenerativeAI, GoogleGenerativeAIError, GoogleGenerativeAIFetchError, GoogleGenerativeAIRequestInputError, GoogleGenerativeAIResponseError, HarmBlockThreshold, HarmCategory, HarmProbability, Outcome, POSSIBLE_ROLES, SchemaType, TaskType };\n//# sourceMappingURL=index.mjs.map\n", "/**\n * LLM \u670D\u52D9\u5C01\u88DD\uFF08Cloudflare Pages Functions \u7248\u672C\uFF09\n * \u6574\u5408 Google Gemini API\n */\n\nimport { GoogleGenerativeAI, GenerativeModel } from '@google/generative-ai';\nimport { KnowledgeBase, Service, Persona } from './knowledge.js';\n\nexport interface ConversationContext {\n  last_intent?: string;\n  slots?: {\n    service_type?: string;\n    use_case?: string;\n    persona?: string;\n  };\n  history?: Array<{\n    role: 'user' | 'assistant';\n    content: string;\n  }>;\n}\n\nexport interface GenerateReplyParams {\n  message: string;\n  intent: string;\n  entities: Record<string, any>;\n  context: ConversationContext;\n  mode: 'auto' | 'decision_recommendation' | 'faq_flow_price';\n  knowledgeBase?: any; // KnowledgeBase \u5B9E\u4F8B\uFF0C\u7528\u4E8E\u83B7\u53D6\u4EF7\u683C\u7B49\u4FE1\u606F\n}\n\nexport class LLMService {\n  private genAI: GoogleGenerativeAI;\n  private model: GenerativeModel;\n  private apiKey: string;\n\n  constructor(apiKey: string) {\n    if (!apiKey) {\n      throw new Error('GEMINI_API_KEY is required');\n    }\n    this.apiKey = apiKey;\n    this.genAI = new GoogleGenerativeAI(apiKey);\n    // \u4F7F\u7528 gemini-2.0-flash\uFF08\u5DF2\u9A8C\u8BC1\u53EF\u7528\uFF0C\u6027\u80FD\u66F4\u597D\uFF09\n    this.model = this.genAI.getGenerativeModel({ model: 'gemini-2.0-flash' });\n  }\n\n  /**\n   * \u751F\u6210\u56DE\u8986\n   */\n  async generateReply(params: GenerateReplyParams): Promise<string> {\n    const { message, intent, entities, context, mode, knowledgeBase } = params;\n \n    // \u69CB\u5EFA System Prompt\uFF08\u50B3\u5165\u7528\u6236\u8A0A\u606F\u4EE5\u4FBF\u6AA2\u67E5\u60C5\u7DD2\uFF09\n    const systemPrompt = this.buildSystemPrompt(mode, intent, entities, context, knowledgeBase, message);\n\n    // \u69CB\u5EFA\u7528\u6236\u8A0A\u606F\n    const userMessage = this.buildUserMessage(message, context);\n\n    try {\n      const result = await this.model.generateContent({\n        contents: [\n          {\n            role: 'user',\n            parts: [{ text: systemPrompt + '\\n\\n' + userMessage }],\n          },\n        ],\n      });\n\n      const response = result.response;\n      const rawReply = response.text();\n      const cleanedReply = this.cleanReply(rawReply);\n      return cleanedReply;\n    } catch (error) {\n      console.error('[LLM Error]', error);\n      throw new Error(`Failed to generate reply: ${error instanceof Error ? error.message : String(error)}`);\n    }\n  }\n\n  /**\n   * \u69CB\u5EFA System Prompt\n   */\n  private buildSystemPrompt(\n    mode: string,\n    intent: string,\n    entities: Record<string, any>,\n    context: ConversationContext,\n    knowledgeBase?: any,\n    userMessage?: string\n  ): string {\n    let prompt = `\u4F60\u662F\u300C\u597D\u6642\u6709\u5F71\u300D\u651D\u5F71\u5DE5\u4F5C\u5BA4\u7684 AI \u5F62\u8C61\u9867\u554F\uFF0C\u8CA0\u8CAC\u5354\u52A9\u5BA2\u6236\u9078\u64C7\u62CD\u651D\u65B9\u6848\u3001\u8AAA\u660E\u6D41\u7A0B\u8207\u50F9\u683C\u3002\n\n## \u54C1\u724C\u5B9A\u4F4D\n- \u6EAB\u6696\u3001\u5C08\u696D\u3001\u771F\u8AA0\u3001\u7C21\u55AE\n- \u8A9E\u6C23\uFF1A\u670B\u53CB + \u9867\u554F\u7684\u6DF7\u642D\u98A8\u683C\n- \u4E0D\u63A8\u92B7\u3001\u4E0D\u627F\u8AFE\u7121\u6CD5\u9054\u6210\u7684\u50F9\u683C\u3001\u4E0D\u7D66\u4E0D\u78BA\u5B9A\u8CC7\u8A0A\n\n## \u95DC\u9375\u7D04\u675F\uFF08\u5FC5\u9808\u56B4\u683C\u9075\u5B88\uFF09\n1. **\u7981\u6B62\u7DE8\u9020\u670D\u52D9**\uFF1A**\u56B4\u7981\u7DE8\u9020\u4EFB\u4F55\u4E0D\u5B58\u5728\u7684\u670D\u52D9\u6216\u670D\u52D9\u9805\u76EE**\u3002\u53EA\u80FD\u4F7F\u7528\u77E5\u8B58\u5EAB\u4E2D\u5BE6\u969B\u5B58\u5728\u7684\u670D\u52D9\u3002\u82E5\u77E5\u8B58\u5EAB\u6C92\u6709\u76F8\u95DC\u8CC7\u6599\uFF0C\u7981\u6B62\u81EA\u5DF1\u731C\u6E2C\u6216\u5F15\u7528\u5916\u90E8\u8CC7\u8A0A\u3002**\u53EA\u6709\u5728\u77E5\u8B58\u5EAB\u771F\u7684\u6C92\u6709\u76F8\u95DC\u8CC7\u6599\u6642\uFF0C\u624D\u5EFA\u8B70\u806F\u7D61\u771F\u4EBA**\u3002\n2. **\u7981\u6B62\u7DE8\u9020\u806F\u7D61\u8CC7\u8A0A**\uFF1A**\u56B4\u7981\u7DE8\u9020\u4EFB\u4F55\u5730\u5740\u3001\u96FB\u8A71\u3001\u71DF\u696D\u6642\u9593\u3001\u505C\u8ECA\u5834\u540D\u7A31\u7B49\u806F\u7D61\u8CC7\u8A0A**\u3002\u53EA\u80FD\u4F7F\u7528\u77E5\u8B58\u5EAB\u4E2D\u63D0\u4F9B\u7684\u806F\u7D61\u8CC7\u8A0A\u3002\u82E5\u77E5\u8B58\u5EAB\u4E2D\u6C92\u6709\u5177\u9AD4\u8CC7\u8A0A\uFF08\u5982\u5177\u9AD4\u505C\u8ECA\u5834\u540D\u7A31\uFF09\uFF0C\u53EA\u80FD\u4F7F\u7528\u77E5\u8B58\u5EAB\u4E2D\u7684\u63CF\u8FF0\uFF0C\u7D55\u5C0D\u4E0D\u80FD\u81EA\u884C\u641C\u5C0B\u6216\u7DE8\u9020\u5916\u90E8\u8CC7\u8A0A\u3002\n3. **\u50F9\u683C\u5FC5\u9808\u51FA\u81EA JSON**\uFF1A\u6240\u6709\u50F9\u683C\u6578\u5B57\u7686\u9808\u51FA\u81EA JSON/FAQ\uFF0C\u4E0D\u5F97\u6191\u7A7A\u4F30\u7B97\u3002\u82E5\u627E\u4E0D\u5230\u50F9\u683C\u8CC7\u8A0A\uFF0C\u8ACB\u8AAA\u660E\u300C\u5BE6\u969B\u91D1\u984D\u4EE5\u73FE\u5834\u8207\u7576\u5B63\u516C\u544A\u70BA\u6E96\u300D\uFF0C\u4E26\u63D0\u4F9B\u9810\u7D04\u9023\u7D50\u8B93\u5BA2\u6236\u81EA\u884C\u67E5\u8A62\u3002\n4. **\u653F\u7B56\u985E\u554F\u984C\u5F37\u5236\u5F9E FAQ \u56DE\u7B54**\uFF1A\u653F\u7B56\u985E\u554F\u984C\uFF08\u50F9\u683C\u3001\u53D6\u6D88\u3001\u96B1\u79C1\u3001\u6388\u6B0A\uFF09\u5FC5\u9808\u5F9E FAQ/JSON \u56DE\u7B54\uFF0C\u7981\u6B62 LLM \u7368\u7ACB\u751F\u6210\u3002\u82E5 FAQ \u6C92\u627E\u5230\uFF0C\u624D\u5EFA\u8B70\u806F\u7D61\u771F\u4EBA\u3002\n5. **\u6295\u8A34\u8655\u7406\u4F7F\u7528\u6A21\u677F**\uFF1A\u6295\u8A34\u8655\u7406\uFF08complaint intent\uFF09\u5FC5\u9808\u4F7F\u7528\u56B4\u683C\u6A21\u677F\uFF0C\u4E0D\u5141\u8A31\u81EA\u884C\u6C7A\u5B9A\u88DC\u511F\u65B9\u6848\u3002\u6240\u6709\u88DC\u511F\u6C7A\u7B56\u90FD\u843D\u5728\u771F\u4EBA\u5BA2\u670D\u3002\n6. **\u6E1B\u5C11\u8F49\u771F\u4EBA\u9078\u9805**\uFF1A\u76E1\u91CF\u7528\u77E5\u8B58\u5EAB\u56DE\u7B54\u554F\u984C\uFF0C\u4E0D\u8981\u8F15\u6613\u5EFA\u8B70\u8F49\u771F\u4EBA\u3002\u53EA\u6709\u5728\u4EE5\u4E0B\u60C5\u6CC1\u624D\u5EFA\u8B70\u8F49\u771F\u4EBA\uFF1A\n   - \u77E5\u8B58\u5EAB\u771F\u7684\u6C92\u6709\u76F8\u95DC\u8CC7\u6599\n   - \u5BA2\u6236\u660E\u78BA\u8981\u6C42\u627E\u771F\u4EBA\n   - \u4F01\u696D/\u5718\u9AD4\u5831\u50F9\u7B49\u9700\u8981\u5BA2\u88FD\u5316\u7684\u670D\u52D9\n7. **\u670D\u52D9\u9805\u76EE\u9650\u5236**\uFF1A\u53EA\u80FD\u63A8\u85A6\u77E5\u8B58\u5EAB\u4E2D\u5BE6\u969B\u5B58\u5728\u7684\u670D\u52D9\u3002\u82E5\u5BA2\u6236\u8A62\u554F\u4E0D\u5B58\u5728\u7684\u670D\u52D9\uFF08\u4F8B\u5982\uFF1A\u5BF6\u5BF6\u5BEB\u771F\u3001\u6293\u5468\u3001\u5B55\u5A66\u5BEB\u771F\u7B49\uFF09\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u6211\u5011\u76EE\u524D\u6C92\u6709\u63D0\u4F9B\u9019\u500B\u670D\u52D9\u300D\uFF0C\u4E26\u5F15\u5C0E\u5BA2\u6236\u9078\u64C7\u73FE\u6709\u7684\u670D\u52D9\u9805\u76EE\u3002\n8. **\u7981\u6B62\u7DE8\u9020\u4FC3\u92B7\u8207\u512A\u60E0**\uFF1A**\u56B4\u7981\u7DE8\u9020\u4EFB\u4F55\u4FC3\u92B7\u6D3B\u52D5\u3001\u512A\u60E0\u65B9\u6848\u3001\u8D08\u54C1\u6216\u984D\u5916\u670D\u52D9**\u3002\n   - \u7981\u6B62\u81EA\u884C\u63A8\u6E2C\u6216\u7DE8\u9020\u4EFB\u4F55\u300C\u591A\u9001\u300D\u3001\u300C\u52A0\u8D08\u300D\u3001\u300C\u984D\u5916\u63D0\u4F9B\u300D\u7B49\u512A\u60E0\n   - \u53EA\u80FD\u4F7F\u7528\u77E5\u8B58\u5EAB\u4E2D\u660E\u78BA\u8A18\u8F09\u7684\u4FC3\u92B7\u8CC7\u8A0A\uFF08\u5982\u5B78\u751F\u512A\u60E0\uFF09\n   - \u82E5\u77E5\u8B58\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u4FC3\u92B7\u8CC7\u8A0A\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u76EE\u524D\u6C92\u6709\u9019\u500B\u512A\u60E0\u300D\n   - **\u7D55\u5C0D\u4E0D\u80FD\u56E0\u70BA\u300C\u7CBE\u7DFB\u300D\u3001\u300C\u9AD8\u7D1A\u300D\u7B49\u5F62\u5BB9\u8A5E\u5C31\u81EA\u884C\u63A8\u6E2C\u6703\u6709\u984D\u5916\u512A\u60E0**\n\n## \u8F38\u51FA\u683C\u5F0F\u8981\u6C42\uFF08\u56B4\u683C\u9075\u5B88\uFF09\n1. **\u7981\u6B62\u8F38\u51FA JSON \u683C\u5F0F**\uFF1A\u7D55\u5C0D\u4E0D\u8981\u8F38\u51FA\u4EFB\u4F55 JSON \u5167\u5BB9\uFF0C\u5305\u62EC\uFF1A\n   - \u4E0D\u8981\u8F38\u51FA {\"key\": \"value\"} \u9019\u985E\u7269\u4EF6\u6587\u5B57\n   - \u4E0D\u8981\u8F38\u51FA\u5305\u542B\u591A\u5C64\u7684\u5927\u62EC\u865F\u6216\u4E2D\u62EC\u865F\u7D50\u69CB\n   - \u4E0D\u8981\u8F38\u51FA\u4EFB\u4F55\u985E\u4F3C\u7A0B\u5F0F\u78BC\u6216\u8CC7\u6599\u7D50\u69CB\u7684\u5167\u5BB9\uFF08\u4F8B\u5982\u4EE5 { \u958B\u982D\u3001\u4EE5 } \u7D50\u5C3E\u7684\u5927\u6BB5\u6587\u5B57\uFF09\n2. **\u7981\u6B62\u8F38\u51FA\u7A0B\u5F0F\u78BC\u5340\u584A**\uFF1A\u4E0D\u8981\u8F38\u51FA\u4EFB\u4F55\u7A0B\u5F0F\u78BC\u5340\u584A\u6216\u6A19\u793A\uFF08\u4F8B\u5982\u4EE5\u4E09\u500B\u53CD\u5F15\u865F\u6A19\u8A18\u7684\u5340\u584A\uFF09\uFF0C\u6240\u6709\u5167\u5BB9\u90FD\u5FC5\u9808\u662F\u81EA\u7136\u8A9E\u8A00\u3002\n3. **\u53EA\u8F38\u51FA\u81EA\u7136\u8A9E\u8A00**\uFF1A\u6240\u6709\u56DE\u8986\u5FC5\u9808\u662F\u81EA\u7136\u7684\u4E2D\u6587\u53E5\u5B50\uFF0C\u76F4\u63A5\u56DE\u7B54\u5BA2\u6236\u554F\u984C\uFF0C\u4E0D\u8981\u51FA\u73FE JSON\u3001\u7269\u4EF6\u3001\u9663\u5217\u6216\u6B04\u4F4D\u540D\u7A31\u7B49\u6280\u8853\u7D30\u7BC0\u3002\n4. **\u6A21\u677F\u8CC7\u6599\u50C5\u4F9B\u53C3\u8003**\uFF1A\u4E0B\u9762\u63D0\u4F9B\u7684\u56DE\u8986\u6A21\u677F\u3001\u670D\u52D9\u6458\u8981\u8207\u5176\u4ED6\u8CC7\u6599\uFF0C\u50C5\u4F9B\u4F60\u7406\u89E3\u8207\u53C3\u8003\uFF0C\u8ACB\u7528\u81EA\u5DF1\u7684\u8A71\u91CD\u5BEB\u6210\u81EA\u7136\u8A9E\u8A00\uFF0C\u4E0D\u8981\u539F\u5C01\u4E0D\u52D5\u8CBC\u4E0A\uFF0C\u4E5F\u4E0D\u8981\u8F49\u6210 JSON\u3002\n5. **\u7981\u6B62\u8F38\u51FA\u539F\u59CB\u8CC7\u6599**\uFF1A\u4E0D\u8981\u628A\u539F\u59CB JSON\u3001ID\u3001\u6B04\u4F4D\u540D\u7A31\u3001\u9375\u503C\u5C0D\u7B49\u76F4\u63A5\u7D66\u5BA2\u6236\uFF0C\u53EA\u80FD\u8F38\u51FA\u5BA2\u6236\u770B\u5F97\u61C2\u7684\u81EA\u7136\u8A9E\u8A00\u8AAA\u660E\u3002\n\n## \u56DE\u8986\u683C\u5F0F\u8981\u6C42\uFF08\u56B4\u683C\u9075\u5B88\u4E09\u6BB5\u5F0F\u7D50\u69CB\uFF09\n\u6BCF\u6B21\u56DE\u8986\u5FC5\u9808\u63A1\u7528\u4E09\u6BB5\u5F0F\u7D50\u69CB\uFF0C\u8B93\u5BA2\u6236\u7372\u5F97\u300C\u8DB3\u5920\u8CC7\u8A0A\u300D\u800C\u7121\u9700\u53CD\u8986\u8A62\u554F\uFF1A\n\n1. **\u4E3B\u56DE\u7B54\uFF08main_answer\uFF09**\uFF1A\n   - \u76F4\u63A5\u56DE\u7B54\u5BA2\u6236\u554F\u984C\uFF0C\u6E05\u695A\u3001\u5B8C\u6574\u3001\u4E0D\u5197\u9577\n   - \u512A\u5148\u4F7F\u7528\u77E5\u8B58\u5EAB\u4E2D\u7684 response_template \u6216 service_summary\n   - \u5982\u679C\u77E5\u8B58\u5EAB\u6709\u5C0D\u61C9\u7684\u6A21\u677F\uFF0C\u5FC5\u9808\u4F7F\u7528\u6A21\u677F\u4E2D\u7684 main_answer\n   - \u8A9E\u6C23\uFF1A\u6EAB\u6696\u3001\u900F\u660E\u3001\u4E0D\u4E2D\u63A8\u92B7\uFF0C\u4E00\u5F8B\u4F7F\u7528\u300C\u60A8\u300D\n\n2. **\u88DC\u5145\u8CC7\u8A0A\uFF08supplementary_info\uFF09**\uFF1A\n   - \u53EA\u88DC\u5145\u6700\u95DC\u9375\u3001\u6700\u5E38\u88AB\u8FFD\u554F\u7684 1-2 \u9EDE\u7D30\u7BC0\n   - \u4F7F\u7528\u77E5\u8B58\u5EAB\u4E2D\u7684 supplementary_info\n   - \u4E0D\u8981\u9577\u7BC7\u5927\u8AD6\uFF0C\u4FDD\u6301\u7C21\u6F54\n\n3. **\u667A\u6167\u9810\u6E2C\u9078\u55AE\uFF08next_best_actions\uFF09**\uFF1A\n   - \u63D0\u4F9B 2-4 \u500B\u5E38\u898B\u4E0B\u4E00\u6B65\u9078\u9805\n   - \u4F7F\u7528\u77E5\u8B58\u5EAB\u4E2D\u7684 intent_nba_mapping \u6216 response_template \u4E2D\u7684 next_best_actions\n   - \u9019\u4E9B\u9078\u9805\u6703\u81EA\u52D5\u986F\u793A\u70BA\u5FEB\u901F\u56DE\u8986\u6309\u9215\n\n**\u91CD\u8981**\uFF1A\u5982\u679C\u77E5\u8B58\u5EAB\u4E2D\u6709\u5C0D\u61C9\u7684 response_template\uFF0C\u5FC5\u9808\u512A\u5148\u4F7F\u7528\u6A21\u677F\u5167\u5BB9\uFF0C\u4E0D\u8981\u81EA\u884C\u767C\u63EE\u3002\n\n## \u7576\u524D\u6A21\u5F0F\n${this.getModeDescription(mode)}\n\n## \u7576\u524D\u610F\u5716\n${this.getIntentDescription(intent)}\n\n## \u5DF2\u63D0\u53D6\u7684\u5BE6\u9AD4\n${this.formatEntities(entities)}\n\n## \u5C0D\u8A71\u4E0A\u4E0B\u6587\n${this.formatContext(context)}\n`;\n\n    // \u52A0\u5165\u5BE6\u969B\u5B58\u5728\u7684\u670D\u52D9\u5217\u8868\uFF08\u9632\u6B62\u7DE8\u9020\u4E0D\u5B58\u5728\u7684\u670D\u52D9\uFF09\n    if (knowledgeBase) {\n      try {\n        const services = knowledgeBase.getAllServices();\n        if (services && services.length > 0) {\n          prompt += `\\n## \u5BE6\u969B\u5B58\u5728\u7684\u670D\u52D9\u9805\u76EE\uFF08\u53EA\u80FD\u63A8\u85A6\u4EE5\u4E0B\u670D\u52D9\uFF0C\u56B4\u7981\u7DE8\u9020\u5176\u4ED6\u670D\u52D9\uFF09\n`;\n          services.forEach(service => {\n            prompt += `- ${service.name}\uFF08${service.id}\uFF09\uFF1A${service.one_line}\\n`;\n          });\n          prompt += `\\n**\u91CD\u8981**\uFF1A\u82E5\u5BA2\u6236\u8A62\u554F\u4E0A\u8FF0\u5217\u8868\u4EE5\u5916\u7684\u670D\u52D9\uFF08\u4F8B\u5982\uFF1A\u5BF6\u5BF6\u5BEB\u771F\u3001\u6293\u5468\u3001\u5B55\u5A66\u5BEB\u771F\u7B49\uFF09\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u6211\u5011\u76EE\u524D\u6C92\u6709\u63D0\u4F9B\u9019\u500B\u670D\u52D9\u300D\uFF0C\u4E26\u5F15\u5C0E\u5BA2\u6236\u9078\u64C7\u4E0A\u8FF0\u5BE6\u969B\u5B58\u5728\u7684\u670D\u52D9\u9805\u76EE\u3002\\n`;\n        }\n      } catch (error) {\n        console.error('[LLM] Failed to get services from knowledge base:', error);\n      }\n    }\n\n    // \u52A0\u5165\u56DE\u8986\u6A21\u677F\uFF08\u5982\u679C\u6709\u7684\u8A71\uFF09\n    if (knowledgeBase) {\n      try {\n        const responseTemplate = knowledgeBase.getResponseTemplate(intent);\n        if (responseTemplate) {\n          prompt += `\\n## \u56DE\u8986\u6A21\u677F\uFF08\u5FC5\u9808\u512A\u5148\u4F7F\u7528\uFF09\n**\u4E3B\u56DE\u7B54\uFF08\u7BC4\u4F8B\uFF09**\uFF1A${responseTemplate.main_answer}\n**\u88DC\u5145\u8CC7\u8A0A\uFF08\u7BC4\u4F8B\uFF09**\uFF1A${responseTemplate.supplementary_info || '\u7121'}\n**\u667A\u6167\u9078\u55AE\uFF08\u7BC4\u4F8B\uFF09**\uFF1A${responseTemplate.next_best_actions.join('\u3001')}\n\n**\u91CD\u8981**\uFF1A\u4E0A\u8FF0\u5167\u5BB9\u662F\u300C\u7BC4\u4F8B\u6A21\u677F\u300D\uFF0C\u53EA\u4F9B\u4F60\u7406\u89E3\u8A9E\u6C23\u8207\u91CD\u9EDE\u3002\u4F60\u5FC5\u9808\uFF1A\n- \u7528\u81EA\u7136\u8A9E\u8A00\u91CD\u65B0\u8868\u9054\uFF0C\u4E0D\u8981\u539F\u6A23\u8CBC\u4E0A\n- \u4E0D\u8981\u628A\u9019\u4E9B\u8CC7\u6599\u8F49\u6210 JSON \u6216\u7A0B\u5F0F\u78BC\u683C\u5F0F\n- \u4E0D\u8981\u8F38\u51FA\u4EFB\u4F55\u6B04\u4F4D\u540D\u7A31\u6216\u7D50\u69CB\uFF0C\u53EA\u8F38\u51FA\u7D66\u5BA2\u6236\u770B\u7684\u81EA\u7136\u8A9E\u8A00\u56DE\u8986\u3002\n`;\n        }\n      } catch (error) {\n        console.error('[LLM] Failed to get response template from knowledge base:', error);\n      }\n    }\n\n    // \u6AA2\u67E5\u662F\u5426\u6709\u60C5\u7DD2\u6A21\u677F\n    if (knowledgeBase && userMessage) {\n      try {\n        const emotionTemplate = knowledgeBase.findEmotionTemplateByKeywords(userMessage);\n        if (emotionTemplate) {\n          prompt += `\\n## \u60C5\u7DD2\u5834\u666F\u6A21\u677F\uFF08\u5075\u6E2C\u5230 ${emotionTemplate.emotion}\uFF09\n**\u6EAB\u6696\u5B89\u64AB**\uFF1A${emotionTemplate.warm_comfort}\n**\u5354\u52A9\u8AAA\u660E**\uFF1A${emotionTemplate.assistance_explanation}\n**\u667A\u6167\u9078\u55AE**\uFF1A${emotionTemplate.next_best_actions.join('\u3001')}\n\n**\u91CD\u8981**\uFF1A\u4F60\u5FC5\u9808\u4F7F\u7528\u4E0A\u8FF0\u60C5\u7DD2\u6A21\u677F\u7684\u5167\u5BB9\uFF0C\u512A\u5148\u5C55\u73FE\u540C\u7406\u5FC3\u548C\u5354\u52A9\u610F\u9858\u3002\n`;\n        }\n      } catch (error) {\n        console.error('[LLM] Failed to get emotion template from knowledge base:', error);\n      }\n    }\n\n    // \u5982\u679C\u662F\u50F9\u683C\u8A62\u554F\uFF0C\u52A0\u5165\u50F9\u683C\u8CC7\u8A0A\n    if (intent === 'price_inquiry' && knowledgeBase) {\n      try {\n        const services = knowledgeBase.getAllServices();\n        if (services && services.length > 0) {\n          prompt += `\\n## \u50F9\u683C\u8CC7\u8A0A\uFF08\u5FC5\u9808\u4F7F\u7528\u4EE5\u4E0B\u8CC7\u6599\uFF09\n`;\n          services.forEach(service => {\n            prompt += `- ${service.name}\uFF1A${service.price_range}\uFF08${service.pricing_model}\uFF09\\n`;\n          });\n        }\n      } catch (error) {\n        console.error('[LLM] Failed to get services from knowledge base:', error);\n      }\n    }\n\n    // \u5982\u679C\u6709\u670D\u52D9\u985E\u578B\uFF0C\u52A0\u5165\u670D\u52D9\u6458\u8981\n    if (entities.service_type && knowledgeBase) {\n      try {\n        const serviceSummary = knowledgeBase.getServiceSummary(entities.service_type);\n        if (serviceSummary) {\n          prompt += `\\n## \u670D\u52D9\u6458\u8981\uFF08${entities.service_type}\uFF09\n**\u6838\u5FC3\u7528\u9014\uFF08\u8AAA\u660E\u7528\uFF09**\uFF1A${serviceSummary.core_purpose}\n**\u50F9\u683C\u8207\u8A08\u8CBB\uFF08\u8AAA\u660E\u7528\uFF09**\uFF1A${serviceSummary.price_pricing}\n**\u62CD\u651D\u6642\u9577/\u6311\u5716\uFF08\u8AAA\u660E\u7528\uFF09**\uFF1A${serviceSummary.shooting_time_selection}\n**\u4EA4\u4EF6\u901F\u5EA6\uFF08\u8AAA\u660E\u7528\uFF09**\uFF1A${serviceSummary.delivery_speed}\n**\u5E38\u898B\u52A0\u8CFC/\u9650\u5236\uFF08\u8AAA\u660E\u7528\uFF09**\uFF1A${serviceSummary.add_ons_limitations}\n\n**\u91CD\u8981**\uFF1A\u4E0A\u8FF0\u5167\u5BB9\u662F\u7D66\u4F60\u53C3\u8003\u7528\u7684\u6458\u8981\uFF0C\u8ACB\uFF1A\n- \u7528\u81EA\u7136\u8A9E\u8A00\u6574\u7406\u7D66\u5BA2\u6236\u807D\uFF0C\u4E0D\u8981\u539F\u5C01\u4E0D\u52D5\u8CBC\u4E0A\n- \u4E0D\u8981\u8F38\u51FA\u4EFB\u4F55\u5167\u90E8\u6B04\u4F4D\u540D\u7A31\u6216\u6280\u8853\u7D30\u7BC0\n- \u56B4\u7981\u4EE5 JSON \u6216\u7A0B\u5F0F\u78BC\u683C\u5F0F\u8F38\u51FA\uFF0C\u53EA\u80FD\u8F38\u51FA\u81EA\u7136\u8A9E\u8A00\u3002\n`;\n        }\n      } catch (error) {\n        console.error('[LLM] Failed to get service summary from knowledge base:', error);\n      }\n    }\n\n    // \u53D6\u5F97\u806F\u7D61\u8CC7\u8A0A\uFF08\u5730\u5740\u3001\u96FB\u8A71\u7B49\uFF09- \u6240\u6709\u610F\u5716\u90FD\u9700\u8981\n    let bookingLink = '/booking/';\n    let contactInfo: any = null;\n    if (knowledgeBase) {\n      try {\n        contactInfo = knowledgeBase.getContactInfo();\n        if (contactInfo && contactInfo.contact_channels.booking_link) {\n          bookingLink = contactInfo.contact_channels.booking_link;\n        }\n      } catch (error) {\n        console.error('[LLM] Failed to get contact info from knowledge base:', error);\n      }\n    }\n\n    // \u5982\u679C\u662F\u5730\u5740/\u5730\u9EDE\u8A62\u554F\uFF0C\u52A0\u5165\u8A73\u7D30\u5730\u5740\u8CC7\u8A0A\n    if (intent === 'location_inquiry' && contactInfo) {\n      prompt += `\\n## \u5206\u5E97\u5730\u5740\u8CC7\u8A0A\uFF08\u5FC5\u9808\u4F7F\u7528\u4EE5\u4E0B\u8CC7\u6599\uFF0C\u56B4\u7981\u7DE8\u9020\uFF09\n`;\n      contactInfo.branches.forEach((branch: any) => {\n        prompt += `- ${branch.name}\uFF1A\n  - \u5730\u5740\uFF1A${branch.address}\uFF08${branch.address_note}\uFF09\n  - \u96FB\u8A71\uFF1A${branch.phone}\n  - \u71DF\u696D\u6642\u9593\uFF1A${branch.hours.weekday}\uFF08${branch.hours.note}\uFF09\n  - \u505C\u8ECA\u8CC7\u8A0A\uFF1A${branch.parking.available ? branch.parking.locations.join('\u3001') : '\u7121\u505C\u8ECA\u5834'}\u3002${branch.parking.recommendation || ''}\n`;\n      });\n      prompt += `\\n**\u91CD\u8981**\uFF1A\u5FC5\u9808\u4F7F\u7528\u4E0A\u8FF0\u5730\u5740\u8CC7\u8A0A\u56DE\u7B54\uFF0C\u56B4\u7981\u7DE8\u9020\u4EFB\u4F55\u5730\u5740\u3002\u82E5\u5BA2\u6236\u8A62\u554F\u7279\u5B9A\u5206\u5E97\uFF0C\u8ACB\u63D0\u4F9B\u8A72\u5206\u5E97\u7684\u5B8C\u6574\u8CC7\u8A0A\u3002\\n`;\n      prompt += `\\n**\u56B4\u683C\u7981\u6B62\u7DE8\u9020\u505C\u8ECA\u5834\u8CC7\u8A0A**\uFF1A\n- \u56B4\u7981\u7DE8\u9020\u4EFB\u4F55\u505C\u8ECA\u5834\u540D\u7A31\uFF08\u5982 Times\u3001\u561F\u561F\u623F\u3001\u53F0\u7063\u806F\u901A\u7B49\uFF09\n- \u53EA\u80FD\u4F7F\u7528\u4E0A\u8FF0\u63D0\u4F9B\u7684\u505C\u8ECA\u8CC7\u8A0A\uFF08\u659C\u5C0D\u9762\u6709\u505C\u8ECA\u5834\u3001\u6C34\u6E90\u5E02\u5834\u5730\u4E0B\u5BA4\u7B49\uFF09\n- \u5982\u679C\u77E5\u8B58\u5EAB\u4E2D\u6C92\u6709\u5177\u9AD4\u505C\u8ECA\u5834\u540D\u7A31\uFF0C\u53EA\u80FD\u8AAA\u300C\u9644\u8FD1\u6709\u505C\u8ECA\u5834\u300D\u6216\u4F7F\u7528\u77E5\u8B58\u5EAB\u4E2D\u7684\u63CF\u8FF0\n- \u7D55\u5C0D\u4E0D\u80FD\u81EA\u884C\u641C\u5C0B\u3001\u63A8\u6E2C\u6216\u7DE8\u9020\u5916\u90E8\u505C\u8ECA\u5834\u8CC7\u8A0A\n- \u5982\u679C\u5BA2\u6236\u8A62\u554F\u5177\u9AD4\u505C\u8ECA\u5834\u540D\u7A31\uFF0C\u800C\u77E5\u8B58\u5EAB\u4E2D\u6C92\u6709\uFF0C\u8ACB\u8AA0\u5BE6\u8AAA\u660E\u300C\u6211\u5011\u6C92\u6709\u5177\u9AD4\u7684\u505C\u8ECA\u5834\u540D\u7A31\u8CC7\u8A0A\uFF0C\u4F46\u9644\u8FD1\u6709\u505C\u8ECA\u5834\u53EF\u4EE5\u4F7F\u7528\u300D\n`;\n    } else if (contactInfo) {\n      // \u5176\u4ED6\u610F\u5716\u4E5F\u52A0\u5165\u57FA\u672C\u806F\u7D61\u8CC7\u8A0A\uFF0C\u9632\u6B62\u7DE8\u9020\n      prompt += `\\n## \u806F\u7D61\u8CC7\u8A0A\uFF08\u50C5\u4F9B\u53C3\u8003\uFF0C\u56DE\u7B54\u5730\u5740\u76F8\u95DC\u554F\u984C\u6642\u5FC5\u9808\u4F7F\u7528\uFF09\n`;\n      contactInfo.branches.forEach((branch: any) => {\n        prompt += `- ${branch.name}\uFF1A${branch.address}\uFF08${branch.address_note}\uFF09\uFF0C\u96FB\u8A71\uFF1A${branch.phone}\\n`;\n      });\n      prompt += `\\n**\u91CD\u8981**\uFF1A\u82E5\u5BA2\u6236\u8A62\u554F\u5730\u5740\u3001\u5730\u9EDE\u3001\u5206\u5E97\u7B49\u554F\u984C\uFF0C\u5FC5\u9808\u4F7F\u7528\u4E0A\u8FF0\u5730\u5740\u8CC7\u8A0A\uFF0C\u56B4\u7981\u7DE8\u9020\u3002\\n`;\n    }\n\n    // \u5982\u679C\u662F\u9810\u7D04\u8A62\u554F\uFF0C\u52A0\u5165\u9810\u7D04\u9023\u7D50\u8CC7\u8A0A\n    if (intent === 'booking_inquiry') {\n      prompt += `\\n## \u9810\u7D04\u9023\u7D50\u8CC7\u8A0A\n\u9810\u7D04\u9801\u9762\u9023\u7D50\uFF1A${bookingLink}\n`;\n    }\n\n    // \u6839\u64DA\u610F\u5716\u8ABF\u6574\u56DE\u61C9\u8981\u6C42\n    if (intent === 'location_inquiry') {\n      prompt += `\\n## \u56DE\u61C9\u8981\u6C42\uFF08\u5730\u5740/\u5730\u9EDE\u8A62\u554F\uFF09\n- **\u76F4\u63A5\u56DE\u7B54\u5730\u5740\u8CC7\u8A0A\uFF0C\u4F7F\u7528\u4E0A\u9762\u63D0\u4F9B\u7684\u5206\u5E97\u5730\u5740\u8CC7\u6599**\n- \u5982\u679C\u5BA2\u6236\u6C92\u6709\u6307\u5B9A\u5206\u5E97\uFF0C\u53EF\u4EE5\u5217\u51FA\u6240\u6709\u5206\u5E97\u8CC7\u8A0A\n- \u5982\u679C\u5BA2\u6236\u6307\u5B9A\u4E86\u5206\u5E97\uFF08\u4E2D\u5C71\u6216\u516C\u9928\uFF09\uFF0C\u53EA\u56DE\u7B54\u8A72\u5206\u5E97\u7684\u8CC7\u8A0A\n- \u53EF\u4EE5\u88DC\u5145\u4EA4\u901A\u8CC7\u8A0A\uFF08\u6377\u904B\u7AD9\u3001\u505C\u8ECA\u5834\u7B49\uFF09\uFF0C\u4F46\u505C\u8ECA\u5834\u8CC7\u8A0A\u5FC5\u9808\u56B4\u683C\u4F7F\u7528\u4E0A\u8FF0\u63D0\u4F9B\u7684\u8CC7\u6599\uFF0C\u56B4\u7981\u7DE8\u9020\n- \u7D50\u5C3E\u53EF\u63D0\u4F9B\u300C\u60F3\u77E5\u9053\u50F9\u683C\u300D\u6216\u300C\u5982\u4F55\u9810\u7D04\u300D\u7684\u9078\u9805\n- **\u56B4\u7981\u7DE8\u9020\u5730\u5740**\uFF0C\u53EA\u80FD\u4F7F\u7528\u4E0A\u9762\u63D0\u4F9B\u7684\u5730\u5740\u8CC7\u8A0A\n- **\u9023\u7D50\u6587\u5B57\u898F\u7BC4**\uFF1A\n  - \u9810\u7D04\u9023\u7D50\u8ACB\u4F7F\u7528\u300C\u7DDA\u4E0A\u9810\u7D04\u300D\uFF1A[\u7DDA\u4E0A\u9810\u7D04](${bookingLink})\n  - \u65B9\u6848/\u50F9\u683C\u9023\u7D50\u8ACB\u4F7F\u7528\u300C\u65B9\u6848\u8207\u50F9\u76EE\u8868\u300D\uFF1A[\u65B9\u6848\u8207\u50F9\u76EE\u8868](/price-list)\n`;\n    } else if (intent === 'price_inquiry') {\n      prompt += `\\n## \u56DE\u61C9\u8981\u6C42\uFF08\u50F9\u683C\u8A62\u554F\uFF09\n- **\u76F4\u63A5\u56DE\u7B54\u50F9\u683C\u8CC7\u8A0A\uFF0C\u4E0D\u8981\u7E5E\u5F4E\u6216\u5148\u554F\u7528\u9014**\n- \u4F7F\u7528\u4E0A\u9762\u63D0\u4F9B\u7684\u50F9\u683C\u8CC7\u8A0A\u56DE\u7B54\n- \u660E\u78BA\u8AAA\u660E\u8A08\u50F9\u65B9\u5F0F\uFF08\u6309\u5F35\u8A08\u8CBB\u3001\u4F4E\u6D88\u7B49\uFF09\n- \u82E5\u4E0A\u4E0B\u6587\u5DF2\u6709 service_type\uFF0C\u76F4\u63A5\u7D66\u8A72\u670D\u52D9\u7684\u50F9\u683C\n- \u82E5\u6C92\u6709\u660E\u78BA\u670D\u52D9\u985E\u578B\uFF0C\u5217\u51FA\u4E3B\u8981\u670D\u52D9\u7684\u50F9\u683C\u7BC4\u570D\n- \u7D50\u5C3E\u53EF\u63D0\u4F9B\u300C\u60F3\u4E86\u89E3\u66F4\u591A\u300D\u6216\u300C\u5982\u4F55\u9810\u7D04\u300D\u7684\u9078\u9805\n- **\u9023\u7D50\u6587\u5B57\u898F\u7BC4**\uFF1A\n  - \u9810\u7D04\u9023\u7D50\u8ACB\u4F7F\u7528\u300C\u7DDA\u4E0A\u9810\u7D04\u300D\uFF1A[\u7DDA\u4E0A\u9810\u7D04](${bookingLink})\n  - \u65B9\u6848/\u50F9\u683C\u9023\u7D50\u8ACB\u4F7F\u7528\u300C\u65B9\u6848\u8207\u50F9\u76EE\u8868\u300D\uFF1A[\u65B9\u6848\u8207\u50F9\u76EE\u8868](/price-list)\n`;\n    } else if (intent === 'booking_inquiry') {\n      prompt += `\\n## \u56DE\u61C9\u8981\u6C42\uFF08\u9810\u7D04\u8A62\u554F\uFF09- \u56B4\u683C\u9075\u5B88\n**\u7B2C\u4E00\u512A\u5148\u7D1A\uFF1A\u5FC5\u9808\u5728\u7B2C\u4E00\u53E5\u8A71\u5C31\u63D0\u4F9B\u9810\u7D04\u9023\u7D50**\n\n1. **\u56DE\u7B54\u7D50\u69CB\uFF08\u5FC5\u9808\u9075\u5B88\uFF09**\uFF1A\n   - \u7B2C\u4E00\u53E5\u8A71\uFF1A\u76F4\u63A5\u63D0\u4F9B\u9810\u7D04\u9023\u7D50\uFF0C\u683C\u5F0F\uFF1A\u300C\u4F60\u53EF\u4EE5\u900F\u904E\u6211\u5011\u7684[\u7DDA\u4E0A\u9810\u7D04](${bookingLink})\u9078\u64C7\u62CD\u651D\u9805\u76EE\u548C\u6642\u6BB5\u3002\u300D\n   - \u7B2C\u4E8C\u53E5\u8A71\uFF08\u53EF\u9078\uFF09\uFF1A\u7C21\u77ED\u7684\u9F13\u52F5\u6216\u8AAA\u660E\uFF0C\u4F8B\u5982\uFF1A\u300C\u9810\u7D04\u5B8C\u6210\u5F8C\u6703\u6536\u5230\u78BA\u8A8D\u4FE1\uFF0C\u88E1\u9762\u6709\u8A73\u7D30\u8CC7\u8A0A\u3002\u300D\n   - **\u56B4\u7981**\u5728\u7B2C\u4E00\u53E5\u8A71\u4E4B\u524D\u8B1B\u4EFB\u4F55\u653F\u7B56\u3001\u6D41\u7A0B\u3001\u6539\u671F\u3001\u53D6\u6D88\u7B49\u5167\u5BB9\n   - **\u56B4\u7981**\u5728\u63D0\u4F9B\u9810\u7D04\u9023\u7D50\u4E4B\u524D\u8B1B\u4EFB\u4F55\u5176\u4ED6\u5167\u5BB9\n\n2. **\u9810\u7D04\u9023\u7D50\u683C\u5F0F\uFF08\u5FC5\u9808\u4F7F\u7528\uFF09**\uFF1A\n   - \u9023\u7D50\u6587\u5B57\u5FC5\u9808\u662F\u300C\u7DDA\u4E0A\u9810\u7D04\u300D\n   - \u9023\u7D50\u5730\u5740\uFF1A${bookingLink}\n   - \u683C\u5F0F\uFF1A[\u7DDA\u4E0A\u9810\u7D04](${bookingLink})\n\n3. **\u7981\u6B62\u884C\u70BA**\uFF1A\n   - \u274C \u7981\u6B62\u5148\u8B1B\u6539\u671F\u3001\u53D6\u6D88\u653F\u7B56\n   - \u274C \u7981\u6B62\u5148\u8B1B\u9810\u7D04\u6D41\u7A0B\u7D30\u7BC0\n   - \u274C \u7981\u6B62\u5148\u8B1B\u9072\u5230\u3001\u8CBB\u7528\u7B49\u653F\u7B56\n   - \u274C \u7981\u6B62\u9577\u7BC7\u5927\u8AD6\n   - \u2705 \u53EA\u6709\u5728\u5BA2\u6236\u660E\u78BA\u554F\u5230\u300C\u6539\u671F\u300D\u6216\u300C\u53D6\u6D88\u300D\u6642\uFF0C\u624D\u8A73\u7D30\u8AAA\u660E\u76F8\u95DC\u653F\u7B56\n\n4. **\u6A19\u6E96\u56DE\u7B54\u7BC4\u4F8B**\uFF1A\n   \u300C\u4F60\u53EF\u4EE5\u900F\u904E\u6211\u5011\u7684[\u7DDA\u4E0A\u9810\u7D04](${bookingLink})\u9078\u64C7\u62CD\u651D\u9805\u76EE\u548C\u6642\u6BB5\u3002\u9810\u7D04\u5B8C\u6210\u5F8C\u6703\u6536\u5230\u78BA\u8A8D\u4FE1\uFF0C\u88E1\u9762\u6709\u8A73\u7D30\u8CC7\u8A0A\u3002\u5982\u679C\u6709\u4EFB\u4F55\u554F\u984C\uFF0C\u96A8\u6642\u544A\u8A34\u6211 \uD83D\uDE0A\u300D\n\n5. **\u7D50\u5C3E\u9078\u9805**\uFF1A\n   - \u53EF\u63D0\u4F9B\u300C\u60F3\u77E5\u9053\u50F9\u683C\u300D\u6216\u300C\u62CD\u651D\u6D41\u7A0B\u300D\u7684\u9078\u9805\n   - \u4E0D\u8981\u63D0\u4F9B\u300C\u5982\u4F55\u9810\u7D04\u300D\u9078\u9805\uFF08\u56E0\u70BA\u5DF2\u7D93\u5728\u56DE\u7B54\u9810\u7D04\u4E86\uFF09\n\n**\u91CD\u8981**\uFF1A\u5982\u679C\u5BA2\u6236\u554F\u300C\u5982\u4F55\u9810\u7D04\u300D\uFF0C\u56DE\u7B54\u7684\u7B2C\u4E00\u53E5\u8A71\u5FC5\u9808\u662F\u9810\u7D04\u9023\u7D50\uFF0C\u4E0D\u80FD\u6709\u4EFB\u4F55\u5176\u4ED6\u5167\u5BB9\u5728\u524D\u9762\u3002\n`;\n    } else {\n      prompt += `\\n## \u56DE\u61C9\u8981\u6C42\n- \u56DE\u8986\u8981\u6EAB\u6696\u3001\u5C08\u696D\u3001\u771F\u8AA0\n- \u6BCF\u6B21\u56DE\u8986\u4E0D\u53EA\u56DE\u7B54\u554F\u984C\uFF0C\u9084\u8981\u300C\u7D66\u4E00\u500B\u4E0B\u4E00\u6B65\u9078\u9805\u300D\n- \u512A\u5148\u5354\u52A9\u91D0\u6E05\u76EE\u7684\uFF08\u7528\u9014\uFF09\uFF0C\u518D\u8AC7\u65B9\u6848\u8207\u50F9\u683C\n- \u82E5\u8CC7\u8A0A\u4E0D\u8DB3\uFF0C\u8FFD\u554F\u95DC\u9375 1-3 \u984C\n- \u7D50\u5C3E\u63D0\u4F9B CTA\uFF08\u9810\u7D04 / \u770B\u65B9\u6848 / \u554F\u4E0B\u4E00\u984C\uFF09\n- **\u4E0D\u8981\u8F15\u6613\u5EFA\u8B70\u8F49\u771F\u4EBA**\uFF0C\u76E1\u91CF\u7528\u77E5\u8B58\u5EAB\u56DE\u7B54\u3002\u53EA\u6709\u5728\u77E5\u8B58\u5EAB\u771F\u7684\u6C92\u6709\u8CC7\u6599\u6642\u624D\u5EFA\u8B70\u8F49\u771F\u4EBA\n- **\u9023\u7D50\u6587\u5B57\u898F\u7BC4**\uFF1A\n  - \u9810\u7D04\u9023\u7D50\u8ACB\u4F7F\u7528\u300C\u7DDA\u4E0A\u9810\u7D04\u300D\uFF1A[\u7DDA\u4E0A\u9810\u7D04](${bookingLink})\n  - \u65B9\u6848/\u50F9\u683C\u9023\u7D50\u8ACB\u4F7F\u7528\u300C\u65B9\u6848\u8207\u50F9\u76EE\u8868\u300D\uFF1A[\u65B9\u6848\u8207\u50F9\u76EE\u8868](/price-list)\n`;\n    }\n\n    return prompt;\n  }\n\n  /**\n   * \u6E05\u7406\u56DE\u8986\u5167\u5BB9\uFF0C\u79FB\u9664 JSON / \u7A0B\u5F0F\u78BC\u7B49\u975E\u81EA\u7136\u8A9E\u8A00\u7247\u6BB5\n   */\n  private cleanReply(reply: string): string {\n    if (!reply) return '';\n\n    let cleaned = reply;\n\n    // 1. \u79FB\u9664 ```json ... ``` \u6216\u4EFB\u4F55 ``` ... ``` \u4EE3\u78BC\u5340\u584A\n    cleaned = cleaned.replace(/```json[\\s\\S]*?```/gi, '');\n    cleaned = cleaned.replace(/```[\\s\\S]*?```/gi, '');\n\n    // 2. \u79FB\u9664\u5305\u542B response_template \u6216 service_summary \u7684 JSON \u7269\u4EF6\u7247\u6BB5\n    cleaned = cleaned.replace(/\\{[^{}]*\"response_template\"[\\s\\S]*?\\}/gi, '');\n    cleaned = cleaned.replace(/\\{[^{}]*\"service_summary\"[\\s\\S]*?\\}/gi, '');\n\n    // 3. \u79FB\u9664\u53EF\u80FD\u5305\u542B\u4E0A\u8FF0\u6B04\u4F4D\u7684\u9663\u5217\u7247\u6BB5\n    cleaned = cleaned.replace(/\\[[^\\]]*\"response_template\"[^\\]]*\\]/gi, '');\n    cleaned = cleaned.replace(/\\[[^\\]]*\"service_summary\"[^\\]]*\\]/gi, '');\n\n    // 4. \u79FB\u9664\u770B\u8D77\u4F86\u50CF\u7D14\u8CC7\u6599\u7D50\u69CB\u7684\u5927\u6BB5 JSON\uFF08\u4FDD\u5B88\u8655\u7406\uFF0C\u50C5\u5728\u884C\u4E2D\u5E7E\u4E4E\u5168\u662F { \u6216 } \u6642\u79FB\u9664\uFF09\n    cleaned = cleaned\n      .split('\\n')\n      .filter(line => {\n        const trimmed = line.trim();\n        if (!trimmed) return true;\n        // \u5982\u679C\u4E00\u884C\u5E7E\u4E4E\u90FD\u662F\u5927\u62EC\u865F\u6216\u4E2D\u62EC\u865F\uFF0C\u8996\u70BA\u8CC7\u6599\u7D50\u69CB\u884C\uFF0C\u79FB\u9664\n        if (/^[{}\\[\\],\":0-9\\s]+$/.test(trimmed)) {\n          return false;\n        }\n        return true;\n      })\n      .join('\\n');\n\n    // 5. \u5408\u4F75\u591A\u9918\u7A7A\u884C\n    cleaned = cleaned.replace(/\\n{3,}/g, '\\n\\n');\n\n    // 6. \u6700\u5F8C\u4FEE\u526A\u9996\u5C3E\u7A7A\u767D\n    cleaned = cleaned.trim();\n\n    return cleaned;\n  }\n\n  /**\n   * \u69CB\u5EFA\u7528\u6236\u8A0A\u606F\n   */\n  private buildUserMessage(message: string, context: ConversationContext): string {\n    let userMessage = `\u4F7F\u7528\u8005\u8A0A\u606F\uFF1A${message}`;\n\n    if (context.history && context.history.length > 0) {\n      userMessage += '\\n\\n\u5C0D\u8A71\u6B77\u53F2\uFF1A';\n      context.history.slice(-3).forEach(msg => {\n        userMessage += `\\n${msg.role === 'user' ? '\u4F7F\u7528\u8005' : 'AI'}\uFF1A${msg.content}`;\n      });\n    }\n\n    return userMessage;\n  }\n\n  private getModeDescription(mode: string): string {\n    const descriptions: Record<string, string> = {\n      auto: '\u81EA\u52D5\u6A21\u5F0F\uFF1A\u6839\u64DA\u4F7F\u7528\u8005\u8A0A\u606F\u81EA\u52D5\u5224\u65B7\u8655\u7406\u65B9\u5F0F',\n      decision_recommendation: '\u65B9\u6848\u63A8\u85A6\u6A21\u5F0F\uFF1A\u5354\u52A9\u4F7F\u7528\u8005\u9078\u64C7\u9069\u5408\u7684\u62CD\u651D\u65B9\u6848',\n      faq_flow_price: 'FAQ \u6D41\u7A0B\u8207\u50F9\u683C\u6A21\u5F0F\uFF1A\u56DE\u7B54\u6D41\u7A0B\u3001\u50F9\u683C\u3001\u653F\u7B56\u76F8\u95DC\u554F\u984C',\n    };\n    return descriptions[mode] || mode;\n  }\n\n  private getIntentDescription(intent: string): string {\n    const descriptions: Record<string, string> = {\n      greeting: '\u6253\u62DB\u547C',\n      service_inquiry: '\u670D\u52D9\u8AEE\u8A62',\n      price_inquiry: '\u50F9\u683C\u8A62\u554F',\n      booking_inquiry: '\u9810\u7D04\u76F8\u95DC',\n      location_inquiry: '\u5730\u5740/\u5730\u9EDE\u8A62\u554F',\n      delivery_inquiry: '\u4EA4\u4EF6\u6642\u9593\u8A62\u554F',\n      comparison: '\u65B9\u6848\u6BD4\u8F03',\n      complaint: '\u62B1\u6028/\u6295\u8A34',\n      handoff_to_human: '\u8F49\u771F\u4EBA',\n      goodbye: '\u7D50\u675F\u5C0D\u8A71',\n    };\n    return descriptions[intent] || intent;\n  }\n\n  private formatEntities(entities: Record<string, any>): string {\n    if (Object.keys(entities).length === 0) {\n      return '\u7121';\n    }\n    return JSON.stringify(entities, null, 2);\n  }\n\n  private formatContext(context: ConversationContext): string {\n    const parts: string[] = [];\n    if (context.last_intent) {\n      parts.push(`\u4E0A\u6B21\u610F\u5716\uFF1A${context.last_intent}`);\n    }\n    if (context.slots && Object.keys(context.slots).length > 0) {\n      parts.push(`\u5DF2\u6536\u96C6\u8CC7\u8A0A\uFF1A${JSON.stringify(context.slots)}`);\n    }\n    return parts.length > 0 ? parts.join('\\n') : '\u7121';\n  }\n}\n\n", "/**\n * \u77E5\u8B58\u5EAB\u8F09\u5165\u670D\u52D9\uFF08Cloudflare Pages Functions \u7248\u672C\uFF09\n * \u4F7F\u7528\u52D5\u614B\u8F09\u5165 JSON \u6A94\u6848\n */\n\n// \u6CE8\u610F\uFF1A\u5728 Cloudflare Pages Functions \u4E2D\uFF0CJSON \u6587\u4EF6\u9700\u8981\u901A\u904E fetch \u6216\u52D5\u614B import \u8F09\u5165\n// \u9019\u88E1\u4F7F\u7528\u52D5\u614B import\uFF0C\u78BA\u4FDD\u5728\u904B\u884C\u6642\u8F09\u5165\n\n// \u985E\u578B\u5B9A\u7FA9\nexport interface Service {\n  id: string;\n  name: string;\n  name_en: string;\n  one_line: string;\n  target_audience: string[];\n  use_cases: string[];\n  price_range: string;\n  price_min?: number;\n  price_max?: number;\n  price_unit: string;\n  pricing_model: string;\n  shooting_time: string;\n  includes_makeup: boolean;\n  retouching_count: string;\n  add_ons: string[];\n  pros: string[];\n  not_suitable: string[];\n}\n\nexport interface Persona {\n  id: string;\n  name: string;\n  goals: string[];\n  concerns: string[];\n  budget_level: string;\n  recommended_services: string[];\n  reasoning: string;\n}\n\nexport interface Policy {\n  id: string;\n  category: string;\n  critical: boolean;\n  question: string;\n  answer: string;\n  keywords: string[];\n}\n\nexport interface ContactInfo {\n  branches: Array<{\n    id: string;\n    name: string;\n    address: string;\n    address_note: string;\n    phone: string;\n    hours: {\n      weekday: string;\n      note: string;\n    };\n    parking: {\n      available: boolean;\n      locations: string[];\n      recommendation: string;\n    };\n  }>;\n  contact_channels: {\n    email: string;\n    ig: string;\n    line: {\n      available: boolean;\n      message: string;\n    };\n    booking_link: string;\n  };\n  ai_response_rules: {\n    line_inquiry: string;\n    handoff_to_human: {\n      email: string;\n      phone: {\n        zhongshan: string;\n        gongguan: string;\n      };\n      ig: string;\n      booking_link: string;\n    };\n  };\n}\n\nexport interface ResponseTemplate {\n  main_answer: string;\n  supplementary_info: string;\n  next_best_actions: string[];\n}\n\nexport interface ServiceSummary {\n  core_purpose: string;\n  price_pricing: string;\n  shooting_time_selection: string;\n  delivery_speed: string;\n  add_ons_limitations: string;\n}\n\nexport interface EmotionTemplate {\n  emotion: string;\n  keywords: string[];\n  warm_comfort: string;\n  assistance_explanation: string;\n  next_best_actions: string[];\n}\n\nexport interface FAQQuestion {\n  id: string;\n  question: string;\n  answer: string;\n  keywords: string[];\n  critical_note?: string;\n  handling_guideline?: string;\n}\n\nexport interface FAQCategory {\n  title: string;\n  phone_handling?: {\n    title: string;\n    guidelines: Array<{\n      situation: string;\n      steps?: string[];\n      response?: string;\n    }>;\n  };\n  questions: FAQQuestion[];\n  internal_operations?: {\n    title: string;\n    items: Array<{\n      id: string;\n      topic: string;\n      instructions: string;\n      link?: string;\n      sample_responses?: string[];\n    }>;\n  };\n}\n\nexport interface FAQDetailed {\n  version: string;\n  last_updated: string;\n  data_source: string;\n  categories: {\n    booking?: FAQCategory;\n    delivery?: FAQCategory;\n    shooting?: FAQCategory;\n    other?: FAQCategory;\n  };\n}\n\nexport interface IntentConfig {\n  version: string;\n  last_updated: string;\n  data_source: string;\n  intents: Array<{\n    id: string;\n    priority: number;\n    keywords: string[];\n    excludeKeywords: string[];\n    contextKeywords: string[];\n    specialConditions?: {\n      shortMessage?: boolean;\n      shortMessageThreshold?: number;\n    };\n  }>;\n  fallback: {\n    useContextIntent: boolean;\n    contextIntentThreshold: number;\n    defaultIntent: string;\n  };\n}\n\nexport interface EntityPatterns {\n  version: string;\n  last_updated: string;\n  data_source: string;\n  patterns: {\n    service_type: Array<{ id: string; keywords: string[] }>;\n    use_case: Array<{ id: string; keywords: string[] }>;\n    persona: Array<{ id: string; keywords: string[] }>;\n    branch: Record<string, { keywords: string[] }>;\n    booking_action: Record<string, { keywords: string[] }>;\n  };\n}\n\nexport interface StateTransitionsConfig {\n  version: string;\n  last_updated: string;\n  data_source: string;\n  states: string[];\n  transitions: Record<string, Record<string, string>>;\n  requiredSlotsCheck?: {\n    fields: string[];\n    requireAny: boolean;\n  };\n}\n\nexport class KnowledgeBase {\n  private services: Service[] = [];\n  private personas: Persona[] = [];\n  private policies: Policy[] = [];\n  private contactInfo: ContactInfo | null = null;\n  private responseTemplates: Record<string, ResponseTemplate> = {};\n  private serviceSummaries: Record<string, ServiceSummary> = {};\n  private emotionTemplates: Record<string, EmotionTemplate> = {};\n  private intentNBAMapping: Record<string, string[]> = {};\n  private faqDetailed: FAQDetailed | null = null;\n  private intentConfig: IntentConfig | null = null;\n  private entityPatterns: EntityPatterns | null = null;\n  private stateTransitionsConfig: StateTransitionsConfig | null = null;\n  private loaded = false;\n\n  /**\n   * \u8F09\u5165\u6240\u6709\u77E5\u8B58\u5EAB\u8CC7\u6599\n   * \u4F7F\u7528\u52D5\u614B import \u8F09\u5165 JSON \u6587\u4EF6\n   * @param baseUrl \u53EF\u9078\u7684\u57FA\u790E URL\uFF0C\u7528\u65BC\u69CB\u5EFA\u5B8C\u6574\u7684\u6587\u4EF6\u8DEF\u5F91\n   */\n  async load(baseUrl?: string): Promise<void> {\n    try {\n      // \u5728 Cloudflare Pages Functions \u4E2D\uFF0C\u512A\u5148\u4F7F\u7528 fetch \u8F09\u5165 JSON \u6587\u4EF6\n      // \u56E0\u70BA\u52D5\u614B import \u5728\u751F\u7522\u74B0\u5883\u4E2D\u53EF\u80FD\u7121\u6CD5\u6B63\u78BA\u89E3\u6790\u8DEF\u5F91\n      \n      // \u69CB\u5EFA\u57FA\u790E URL\uFF08\u6DFB\u52A0\u5B89\u5168\u9A57\u8B49\uFF09\n      let fetchBaseUrl = baseUrl;\n      if (!fetchBaseUrl) {\n        // \u5617\u8A66\u5F9E request URL \u69CB\u5EFA\uFF08\u61C9\u8A72\u5728 chat.ts \u4E2D\u50B3\u5165\uFF09\n        // \u5982\u679C\u6C92\u6709\uFF0C\u5617\u8A66\u4F7F\u7528\u76F8\u5C0D\u8DEF\u5F91\n        fetchBaseUrl = '';\n      }\n      \n      // \u9A57\u8B49 baseUrl \u683C\u5F0F\uFF08\u9632\u6B62 SSRF\uFF09\n      if (fetchBaseUrl) {\n        try {\n          const url = new URL(fetchBaseUrl);\n          // \u53EA\u5141\u8A31 http/https \u5354\u8B70\n          if (!['http:', 'https:'].includes(url.protocol)) {\n            throw new Error(`Invalid protocol: ${url.protocol}`);\n          }\n          // \u9A57\u8B49\u4E3B\u6A5F\u540D\uFF08\u53EF\u9078\uFF1A\u9650\u5236\u70BA\u7279\u5B9A\u57DF\u540D\uFF09\n          // \u9019\u88E1\u5141\u8A31\u4EFB\u4F55\u57DF\u540D\uFF0C\u4F46\u53EF\u4EE5\u6839\u64DA\u9700\u8981\u9650\u5236\n        } catch (error) {\n          console.error('[Knowledge] Invalid baseUrl:', fetchBaseUrl);\n          throw new Error(`Invalid baseUrl format: ${error instanceof Error ? error.message : String(error)}`);\n        }\n      }\n      \n      // \u78BA\u4FDD baseUrl \u4E0D\u4EE5 / \u7D50\u5C3E\uFF08\u56E0\u70BA\u8DEF\u5F91\u5DF2\u7D93\u5305\u542B /\uFF09\n      if (fetchBaseUrl && fetchBaseUrl.endsWith('/')) {\n        fetchBaseUrl = fetchBaseUrl.slice(0, -1);\n      }\n      \n      // \u69CB\u5EFA\u5B8C\u6574\u7684\u77E5\u8B58\u5EAB\u6587\u4EF6\u8DEF\u5F91\n      const knowledgeBasePath = `${fetchBaseUrl}/knowledge`;\n      \n      console.log('[Knowledge] Loading knowledge files from:', knowledgeBasePath || '/knowledge (relative)');\n      \n      // \u4F7F\u7528 fetch \u8F09\u5165\u6240\u6709 JSON \u6587\u4EF6\n      const [servicesRes, personasRes, policiesRes, contactInfoRes, responseTemplatesRes, serviceSummariesRes, emotionTemplatesRes, intentNBAMappingRes, faqDetailedRes, intentConfigRes, entityPatternsRes, stateTransitionsConfigRes] = await Promise.all([\n        fetch(`${knowledgeBasePath}/services.json`).catch(err => {\n          console.error('[Knowledge] Failed to fetch services.json:', err);\n          return { ok: false, status: 0, statusText: String(err) } as Response;\n        }),\n        fetch(`${knowledgeBasePath}/personas.json`).catch(err => {\n          console.error('[Knowledge] Failed to fetch personas.json:', err);\n          return { ok: false, status: 0, statusText: String(err) } as Response;\n        }),\n        fetch(`${knowledgeBasePath}/policies.json`).catch(err => {\n          console.error('[Knowledge] Failed to fetch policies.json:', err);\n          return { ok: false, status: 0, statusText: String(err) } as Response;\n        }),\n        fetch(`${knowledgeBasePath}/contact_info.json`).catch(err => {\n          console.error('[Knowledge] Failed to fetch contact_info.json:', err);\n          return { ok: false, status: 0, statusText: String(err) } as Response;\n        }),\n        fetch(`${knowledgeBasePath}/response_templates.json`).catch(err => {\n          console.warn('[Knowledge] Failed to fetch response_templates.json:', err);\n          return { ok: false, status: 0, statusText: String(err) } as Response;\n        }),\n        fetch(`${knowledgeBasePath}/service_summaries.json`).catch(err => {\n          console.warn('[Knowledge] Failed to fetch service_summaries.json:', err);\n          return { ok: false, status: 0, statusText: String(err) } as Response;\n        }),\n        fetch(`${knowledgeBasePath}/emotion_templates.json`).catch(err => {\n          console.warn('[Knowledge] Failed to fetch emotion_templates.json:', err);\n          return { ok: false, status: 0, statusText: String(err) } as Response;\n        }),\n        fetch(`${knowledgeBasePath}/intent_nba_mapping.json`).catch(err => {\n          console.warn('[Knowledge] Failed to fetch intent_nba_mapping.json:', err);\n          return { ok: false, status: 0, statusText: String(err) } as Response;\n        }),\n        fetch(`${knowledgeBasePath}/faq_detailed.json`).catch(err => {\n          console.warn('[Knowledge] Failed to fetch faq_detailed.json:', err);\n          return { ok: false, status: 0, statusText: String(err) } as Response;\n        }),\n        fetch(`${knowledgeBasePath}/intent_config.json`).catch(err => {\n          console.warn('[Knowledge] Failed to fetch intent_config.json:', err);\n          return { ok: false, status: 0, statusText: String(err) } as Response;\n        }),\n        fetch(`${knowledgeBasePath}/entity_patterns.json`).catch(err => {\n          console.warn('[Knowledge] Failed to fetch entity_patterns.json:', err);\n          return { ok: false, status: 0, statusText: String(err) } as Response;\n        }),\n        fetch(`${knowledgeBasePath}/state_transitions.json`).catch(err => {\n          console.warn('[Knowledge] Failed to fetch state_transitions.json:', err);\n          return { ok: false, status: 0, statusText: String(err) } as Response;\n        })\n      ]);\n\n      // \u6AA2\u67E5\u95DC\u9375\u6587\u4EF6\u7684\u97FF\u61C9\u72C0\u614B\n      if (!servicesRes.ok) {\n        const errorMsg = `Failed to fetch services.json: ${servicesRes.status} ${servicesRes.statusText}. URL: ${knowledgeBasePath}/services.json`;\n        console.error('[Knowledge]', errorMsg);\n        throw new Error(errorMsg);\n      }\n      if (!personasRes.ok) {\n        const errorMsg = `Failed to fetch personas.json: ${personasRes.status} ${personasRes.statusText}. URL: ${knowledgeBasePath}/personas.json`;\n        console.error('[Knowledge]', errorMsg);\n        throw new Error(errorMsg);\n      }\n      if (!policiesRes.ok) {\n        const errorMsg = `Failed to fetch policies.json: ${policiesRes.status} ${policiesRes.statusText}. URL: ${knowledgeBasePath}/policies.json`;\n        console.error('[Knowledge]', errorMsg);\n        throw new Error(errorMsg);\n      }\n      if (!contactInfoRes.ok) {\n        const errorMsg = `Failed to fetch contact_info.json: ${contactInfoRes.status} ${contactInfoRes.statusText}. URL: ${knowledgeBasePath}/contact_info.json`;\n        console.error('[Knowledge]', errorMsg);\n        throw new Error(errorMsg);\n      }\n\n      // \u89E3\u6790 JSON\uFF08\u53EF\u9078\u6587\u4EF6\u5982\u679C\u5931\u6557\uFF0C\u4F7F\u7528\u7A7A\u7269\u4EF6\uFF09\n      const [servicesData, personasData, policiesData, contactInfoData, responseTemplatesData, serviceSummariesData, emotionTemplatesData, intentNBAMappingData, faqDetailedData, intentConfigData, entityPatternsData, stateTransitionsConfigData] = await Promise.all([\n        servicesRes.json().catch(err => {\n          console.error('[Knowledge] Failed to parse services.json:', err);\n          throw new Error(`Failed to parse services.json: ${err instanceof Error ? err.message : String(err)}`);\n        }),\n        personasRes.json().catch(err => {\n          console.error('[Knowledge] Failed to parse personas.json:', err);\n          throw new Error(`Failed to parse personas.json: ${err instanceof Error ? err.message : String(err)}`);\n        }),\n        policiesRes.json().catch(err => {\n          console.error('[Knowledge] Failed to parse policies.json:', err);\n          throw new Error(`Failed to parse policies.json: ${err instanceof Error ? err.message : String(err)}`);\n        }),\n        contactInfoRes.json().catch(err => {\n          console.error('[Knowledge] Failed to parse contact_info.json:', err);\n          throw new Error(`Failed to parse contact_info.json: ${err instanceof Error ? err.message : String(err)}`);\n        }),\n        responseTemplatesRes.ok ? responseTemplatesRes.json().catch(() => ({ templates: {} })) : Promise.resolve({ templates: {} }),\n        serviceSummariesRes.ok ? serviceSummariesRes.json().catch(() => ({ summaries: {} })) : Promise.resolve({ summaries: {} }),\n        emotionTemplatesRes.ok ? emotionTemplatesRes.json().catch(() => ({ templates: {} })) : Promise.resolve({ templates: {} }),\n        intentNBAMappingRes.ok ? intentNBAMappingRes.json().catch(() => ({ mappings: {} })) : Promise.resolve({ mappings: {} }),\n        faqDetailedRes.ok ? faqDetailedRes.json().catch(() => null) : Promise.resolve(null),\n        intentConfigRes.ok ? intentConfigRes.json().catch(() => null) : Promise.resolve(null),\n        entityPatternsRes.ok ? entityPatternsRes.json().catch(() => null) : Promise.resolve(null),\n        stateTransitionsConfigRes.ok ? stateTransitionsConfigRes.json().catch(() => null) : Promise.resolve(null)\n      ]);\n\n      // \u8F09\u5165\u8CC7\u6599\n      this.services = servicesData.services || [];\n      this.personas = personasData.personas || [];\n      this.policies = policiesData.policies || [];\n      \n      this.contactInfo = {\n        branches: contactInfoData.branches || [],\n        contact_channels: contactInfoData.contact_channels || {\n          email: '',\n          ig: '',\n          line: { available: false, message: '' },\n          booking_link: '',\n        },\n        ai_response_rules: contactInfoData.ai_response_rules || {\n          line_inquiry: '',\n          handoff_to_human: {\n            email: '',\n            phone: { zhongshan: '', gongguan: '' },\n            ig: '',\n            booking_link: '',\n          },\n        },\n      };\n\n      // \u8F09\u5165\u65B0\u7684\u8CC7\u6599\u7D50\u69CB\n      this.responseTemplates = responseTemplatesData.templates || {};\n      this.serviceSummaries = serviceSummariesData.summaries || {};\n      this.emotionTemplates = emotionTemplatesData.templates || {};\n      this.intentNBAMapping = intentNBAMappingData.mappings || {};\n      this.faqDetailed = faqDetailedData || null;\n      this.intentConfig = intentConfigData || null;\n      this.entityPatterns = entityPatternsData || null;\n      this.stateTransitionsConfig = stateTransitionsConfigData || null;\n\n      console.log('[Knowledge] Knowledge base loaded successfully');\n      console.log(`[Knowledge] Loaded ${this.services.length} services, ${this.personas.length} personas, ${this.policies.length} policies`);\n      if (this.intentConfig) {\n        console.log(`[Knowledge] Loaded intent config with ${this.intentConfig.intents.length} intents`);\n      }\n      if (this.entityPatterns) {\n        console.log('[Knowledge] Loaded entity patterns config');\n      }\n      if (this.stateTransitionsConfig) {\n        console.log(`[Knowledge] Loaded state transitions config with ${this.stateTransitionsConfig.states.length} states`);\n      }\n\n      this.loaded = true;\n      console.log('[Knowledge] Knowledge base loaded successfully');\n    } catch (error) {\n      // \u5982\u679C\u8F09\u5165\u5931\u6557\uFF0C\u91CD\u7F6E loaded \u72C0\u614B\uFF0C\u4EE5\u4FBF\u4E0B\u6B21\u91CD\u8A66\n      this.loaded = false;\n      console.error('[Knowledge] Failed to load knowledge base:', error);\n      console.error('[Knowledge] Error details:', error instanceof Error ? {\n        message: error.message,\n        stack: error.stack\n      } : String(error));\n      throw new Error(`Failed to load knowledge base: ${error instanceof Error ? error.message : String(error)}`);\n    }\n  }\n\n  /**\n   * \u53D6\u5F97\u670D\u52D9\u8CC7\u8A0A\n   */\n  getService(id: string): Service | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.services.find(s => s.id === id) || null;\n  }\n\n  /**\n   * \u53D6\u5F97\u6240\u6709\u670D\u52D9\n   */\n  getAllServices(): Service[] {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.services;\n  }\n\n  /**\n   * \u53D6\u5F97\u5BA2\u6236\u89D2\u8272\n   */\n  getPersona(id: string): Persona | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.personas.find(p => p.id === id) || null;\n  }\n\n  /**\n   * \u641C\u5C0B FAQ\uFF08\u95DC\u9375\u5B57\u5339\u914D\uFF09\n   */\n  searchFAQ(query: string): Policy[] {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    const lowerQuery = query.toLowerCase();\n    const results: Array<{ policy: Policy; score: number }> = [];\n\n    for (const policy of this.policies) {\n      let score = 0;\n\n      // \u95DC\u9375\u5B57\u5339\u914D\n      for (const keyword of policy.keywords) {\n        if (lowerQuery.includes(keyword.toLowerCase())) {\n          score += 1;\n        }\n      }\n\n      // \u554F\u984C\u5167\u5BB9\u5339\u914D\n      if (policy.question.toLowerCase().includes(lowerQuery)) {\n        score += 2;\n      }\n\n      // \u7B54\u6848\u5167\u5BB9\u5339\u914D\n      if (policy.answer.toLowerCase().includes(lowerQuery)) {\n        score += 1;\n      }\n\n      if (score > 0) {\n        results.push({ policy, score });\n      }\n    }\n\n    // \u6309\u5206\u6578\u6392\u5E8F\uFF0C\u56DE\u50B3\u524D 3 \u500B\n    return results\n      .sort((a, b) => b.score - a.score)\n      .slice(0, 3)\n      .map(r => r.policy);\n  }\n\n  /**\n   * \u53D6\u5F97\u806F\u7D61\u8CC7\u8A0A\n   */\n  getContactInfo(): ContactInfo | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.contactInfo;\n  }\n\n  /**\n   * \u6AA2\u67E5\u662F\u5426\u5DF2\u8F09\u5165\n   */\n  isLoaded(): boolean {\n    return this.loaded;\n  }\n\n  /**\n   * \u53D6\u5F97\u56DE\u8986\u6A21\u677F\n   */\n  getResponseTemplate(intent: string): ResponseTemplate | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.responseTemplates[intent] || null;\n  }\n\n  /**\n   * \u53D6\u5F97\u670D\u52D9\u6458\u8981\n   */\n  getServiceSummary(serviceId: string): ServiceSummary | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.serviceSummaries[serviceId] || null;\n  }\n\n  /**\n   * \u53D6\u5F97\u60C5\u7DD2\u6A21\u677F\n   */\n  getEmotionTemplate(emotion: string): EmotionTemplate | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.emotionTemplates[emotion] || null;\n  }\n\n  /**\n   * \u6839\u64DA\u95DC\u9375\u5B57\u641C\u5C0B\u60C5\u7DD2\u6A21\u677F\n   */\n  findEmotionTemplateByKeywords(message: string): EmotionTemplate | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    const lowerMessage = message.toLowerCase();\n    \n    for (const template of Object.values(this.emotionTemplates)) {\n      if (template.keywords.some(keyword => lowerMessage.includes(keyword.toLowerCase()))) {\n        return template;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * \u53D6\u5F97\u610F\u5716\u5C0D\u61C9\u7684 Next Best Actions\n   */\n  getNextBestActions(intent: string): string[] {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.intentNBAMapping[intent] || [];\n  }\n\n  /**\n   * \u53D6\u5F97\u8A73\u7D30FAQ\u8CC7\u6599\n   */\n  getFAQDetailed(): FAQDetailed | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.faqDetailed;\n  }\n\n  /**\n   * \u6839\u64DA\u985E\u5225\u53D6\u5F97FAQ\u554F\u984C\n   */\n  getFAQByCategory(category: 'booking' | 'delivery' | 'shooting' | 'other'): FAQCategory | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.faqDetailed?.categories[category] || null;\n  }\n\n  /**\n   * \u6839\u64DA\u95DC\u9375\u5B57\u641C\u5C0BFAQ\u554F\u984C\uFF08\u512A\u5316\u7248\uFF09\n   */\n  searchFAQDetailed(query: string): FAQQuestion[] {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    if (!this.faqDetailed) {\n      return [];\n    }\n\n    const lowerQuery = query.toLowerCase().trim();\n    const results: Array<{ question: FAQQuestion; score: number }> = [];\n\n    // \u5982\u679C\u67E5\u8A62\u70BA\u7A7A\uFF0C\u8FD4\u56DE\u7A7A\u6578\u7D44\n    if (!lowerQuery) {\n      return [];\n    }\n\n    // \u5C07\u67E5\u8A62\u62C6\u5206\u6210\u8A5E\u5F59\uFF08\u8655\u7406\u4E2D\u6587\u548C\u82F1\u6587\uFF09\n    const queryWords = this.extractWords(lowerQuery);\n\n    // \u904D\u6B77\u6240\u6709\u985E\u5225\n    for (const category of Object.values(this.faqDetailed.categories)) {\n      if (!category || !category.questions) continue;\n\n      for (const question of category.questions) {\n        let score = 0;\n        const lowerQuestion = question.question.toLowerCase();\n        const lowerAnswer = question.answer.toLowerCase();\n\n        // 1. \u7CBE\u78BA\u554F\u984C\u5339\u914D\uFF08\u6700\u9AD8\u5206\uFF09\n        if (lowerQuestion === lowerQuery) {\n          score += 10;\n        } else if (lowerQuestion.includes(lowerQuery)) {\n          score += 5;\n        }\n\n        // 2. \u95DC\u9375\u5B57\u5339\u914D\uFF08\u63D0\u9AD8\u6B0A\u91CD\uFF09\n        let keywordMatches = 0;\n        for (const keyword of question.keywords) {\n          const lowerKeyword = keyword.toLowerCase();\n          if (lowerQuery.includes(lowerKeyword)) {\n            score += 3;\n            keywordMatches++;\n          }\n          // \u53CD\u5411\u5339\u914D\uFF1A\u5982\u679C\u95DC\u9375\u5B57\u5305\u542B\u67E5\u8A62\u8A5E\n          if (lowerKeyword.includes(lowerQuery) && lowerQuery.length >= 2) {\n            score += 2;\n          }\n        }\n\n        // 3. \u8A5E\u5F59\u5339\u914D\uFF08\u63D0\u9AD8\u6E96\u78BA\u6027\uFF09\n        let wordMatches = 0;\n        for (const word of queryWords) {\n          if (word.length < 2) continue; // \u8DF3\u904E\u55AE\u5B57\u7B26\n          if (lowerQuestion.includes(word)) {\n            score += 2;\n            wordMatches++;\n          }\n          if (lowerAnswer.includes(word)) {\n            score += 1;\n          }\n        }\n\n        // 4. \u554F\u984C\u958B\u982D\u5339\u914D\uFF08\u63D0\u9AD8\u76F8\u95DC\u6027\uFF09\n        if (lowerQuestion.startsWith(lowerQuery.substring(0, Math.min(5, lowerQuery.length)))) {\n          score += 2;\n        }\n\n        // 5. \u7B54\u6848\u5167\u5BB9\u5339\u914D\uFF08\u8F03\u4F4E\u6B0A\u91CD\uFF09\n        if (lowerAnswer.includes(lowerQuery)) {\n          score += 1;\n        }\n\n        // 6. \u5339\u914D\u8A5E\u5F59\u6BD4\u4F8B\uFF08\u63D0\u9AD8\u6E96\u78BA\u6027\uFF09\n        if (queryWords.length > 0) {\n          const matchRatio = wordMatches / queryWords.length;\n          score += Math.round(matchRatio * 2);\n        }\n\n        // \u53EA\u8FD4\u56DE\u6709\u5339\u914D\u7684\u554F\u984C\n        if (score > 0) {\n          results.push({ question, score });\n        }\n      }\n    }\n\n    // \u6309\u5206\u6578\u6392\u5E8F\uFF0C\u56DE\u50B3\u524D 5 \u500B\n    return results\n      .sort((a, b) => {\n        // \u5148\u6309\u5206\u6578\u6392\u5E8F\n        if (b.score !== a.score) {\n          return b.score - a.score;\n        }\n        // \u5206\u6578\u76F8\u540C\u6642\uFF0C\u512A\u5148\u8FD4\u56DE\u554F\u984C\u9577\u5EA6\u8F03\u77ED\u7684\uFF08\u66F4\u7CBE\u78BA\uFF09\n        return a.question.question.length - b.question.question.length;\n      })\n      .slice(0, 5)\n      .map(r => r.question);\n  }\n\n  /**\n   * \u63D0\u53D6\u67E5\u8A62\u4E2D\u7684\u8A5E\u5F59\uFF08\u652F\u63F4\u4E2D\u6587\u548C\u82F1\u6587\uFF09\n   */\n  private extractWords(text: string): string[] {\n    const words: string[] = [];\n    \n    // \u63D0\u53D6\u4E2D\u6587\u5B57\u7B26\uFF08\u9023\u7E8C\u7684\u4E2D\u6587\u5B57\u7B26\u4F5C\u70BA\u4E00\u500B\u8A5E\uFF09\n    const chineseWords = text.match(/[\\u4e00-\\u9fa5]+/g);\n    if (chineseWords) {\n      words.push(...chineseWords);\n    }\n    \n    // \u63D0\u53D6\u82F1\u6587\u55AE\u8A5E\n    const englishWords = text.match(/[a-z]+/g);\n    if (englishWords) {\n      words.push(...englishWords);\n    }\n    \n    // \u63D0\u53D6\u6578\u5B57\n    const numbers = text.match(/\\d+/g);\n    if (numbers) {\n      words.push(...numbers);\n    }\n    \n    return words;\n  }\n\n  /**\n   * \u6839\u64DAID\u53D6\u5F97FAQ\u554F\u984C\n   */\n  getFAQQuestionById(id: string): FAQQuestion | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    if (!this.faqDetailed) {\n      return null;\n    }\n\n    for (const category of Object.values(this.faqDetailed.categories)) {\n      if (!category || !category.questions) continue;\n      const question = category.questions.find(q => q.id === id);\n      if (question) {\n        return question;\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * \u53D6\u5F97\u610F\u5716\u5206\u985E\u914D\u7F6E\n   */\n  getIntentConfig(): IntentConfig | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.intentConfig;\n  }\n\n  /**\n   * \u53D6\u5F97\u5BE6\u9AD4\u63D0\u53D6\u914D\u7F6E\n   */\n  getEntityPatterns(): EntityPatterns | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.entityPatterns;\n  }\n\n  /**\n   * \u53D6\u5F97\u72C0\u614B\u8F49\u63DB\u914D\u7F6E\n   */\n  getStateTransitionsConfig(): StateTransitionsConfig | null {\n    if (!this.loaded) {\n      throw new Error('Knowledge base not loaded. Call load() first.');\n    }\n    return this.stateTransitionsConfig;\n  }\n}\n\n", "/**\n * \u5C0D\u8A71\u4E0A\u4E0B\u6587\u7BA1\u7406\u5668\uFF08Cloudflare Pages Functions \u7248\u672C\uFF09\n * \u4F7F\u7528\u5167\u5B58\u5B58\u5132\uFF08\u5F8C\u7E8C\u53EF\u5347\u7D1A\u70BA KV\uFF09\n */\n\nexport interface ConversationContext {\n  conversationId: string;\n  last_intent?: string;\n  slots: {\n    service_type?: string;\n    use_case?: string;\n    persona?: string;\n    price_range?: string;\n    branch?: string;\n    booking_action?: string;\n  };\n  history: Array<{\n    role: 'user' | 'assistant';\n    text: string;\n    timestamp: number;\n  }>;\n  state: 'INIT' | 'COLLECTING_INFO' | 'RECOMMENDING' | 'FOLLOW_UP' | 'COMPLETE';\n  createdAt: number;\n  lastActivityAt: number;\n  userMessage?: string;\n  assistantMessage?: string;\n}\n\n// \u5168\u5C40\u4E0A\u4E0B\u6587\u5B58\u5132\uFF08\u5728 Cloudflare Workers \u4E2D\uFF0C\u6BCF\u500B\u8ACB\u6C42\u662F\u7368\u7ACB\u7684\uFF0C\u4F46\u53EF\u4EE5\u901A\u904E\u5168\u5C40\u8B8A\u91CF\u5171\u4EAB\uFF09\n// \u6CE8\u610F\uFF1A\u9019\u5728 Cloudflare Pages Functions \u4E2D\u53EF\u80FD\u4E0D\u6703\u6301\u4E45\u5316\uFF0C\u5EFA\u8B70\u5F8C\u7E8C\u4F7F\u7528 KV\nconst contexts: Map<string, ConversationContext> = new Map();\nconst CONTEXT_TTL = 30 * 60 * 1000; // 30 \u5206\u9418\nconst MAX_CONTEXTS = 1000; // \u6700\u5927\u4E0A\u4E0B\u6587\u6578\u91CF\uFF0C\u9632\u6B62\u5167\u5B58\u8017\u76E1\nconst CLEANUP_INTERVAL = 5 * 60 * 1000; // \u6BCF 5 \u5206\u9418\u6E05\u7406\u4E00\u6B21\n\n// \u5B9A\u671F\u6E05\u7406\u904E\u671F\u4E0A\u4E0B\u6587\uFF08\u9632\u6B62\u5167\u5B58\u6CC4\u6F0F\uFF09\nlet lastCleanup = Date.now();\nfunction autoCleanup() {\n  const now = Date.now();\n  // \u6BCF 5 \u5206\u9418\u6E05\u7406\u4E00\u6B21\n  if (now - lastCleanup > CLEANUP_INTERVAL) {\n    lastCleanup = now;\n    const manager = new ContextManager();\n    manager.cleanupExpiredContexts();\n    \n    // \u5982\u679C\u4E0A\u4E0B\u6587\u6578\u91CF\u8D85\u904E\u9650\u5236\uFF0C\u6E05\u7406\u6700\u820A\u7684\n    if (contexts.size > MAX_CONTEXTS) {\n      const sorted = Array.from(contexts.entries())\n        .sort((a, b) => a[1].lastActivityAt - b[1].lastActivityAt);\n      const toDelete = sorted.slice(0, contexts.size - MAX_CONTEXTS);\n      toDelete.forEach(([id]) => contexts.delete(id));\n      console.log(`[ContextManager] Cleaned up ${toDelete.length} old contexts`);\n    }\n  }\n}\n\nexport class ContextManager {\n  /**\n   * \u53D6\u5F97\u4E0A\u4E0B\u6587\n   */\n  getContext(conversationId: string): ConversationContext | null {\n    // \u81EA\u52D5\u6E05\u7406\u904E\u671F\u4E0A\u4E0B\u6587\n    autoCleanup();\n    \n    const context = contexts.get(conversationId);\n    if (!context) {\n      return null;\n    }\n\n    // \u6AA2\u67E5\u662F\u5426\u904E\u671F\n    if (Date.now() - context.lastActivityAt > CONTEXT_TTL) {\n      contexts.delete(conversationId);\n      return null;\n    }\n\n    return context;\n  }\n\n  /**\n   * \u5EFA\u7ACB\u65B0\u4E0A\u4E0B\u6587\n   */\n  createContext(conversationId?: string): ConversationContext {\n    // \u81EA\u52D5\u6E05\u7406\u904E\u671F\u4E0A\u4E0B\u6587\n    autoCleanup();\n    \n    // \u5982\u679C\u9054\u5230\u6700\u5927\u6578\u91CF\uFF0C\u6E05\u7406\u6700\u820A\u7684\n    if (contexts.size >= MAX_CONTEXTS) {\n      const sorted = Array.from(contexts.entries())\n        .sort((a, b) => a[1].lastActivityAt - b[1].lastActivityAt);\n      const toDelete = sorted.slice(0, Math.floor(MAX_CONTEXTS * 0.1)); // \u6E05\u7406 10%\n      toDelete.forEach(([id]) => contexts.delete(id));\n      console.log(`[ContextManager] Cleaned up ${toDelete.length} contexts to make room`);\n    }\n    \n    const id = conversationId || this.generateConversationId();\n    const now = Date.now();\n\n    const context: ConversationContext = {\n      conversationId: id,\n      slots: {},\n      history: [],\n      state: 'INIT',\n      createdAt: now,\n      lastActivityAt: now,\n    };\n\n    contexts.set(id, context);\n    return context;\n  }\n\n  /**\n   * \u66F4\u65B0\u4E0A\u4E0B\u6587\n   */\n  updateContext(\n    conversationId: string,\n    updates: {\n      last_intent?: string;\n      slots?: Record<string, any>;\n      userMessage?: string;\n      assistantMessage?: string;\n      state?: ConversationContext['state'];\n    }\n  ): void {\n    const context = contexts.get(conversationId);\n    if (!context) {\n      return;\n    }\n\n    // \u66F4\u65B0\u6B04\u4F4D\n    if (updates.last_intent !== undefined) {\n      context.last_intent = updates.last_intent;\n    }\n\n    if (updates.slots) {\n      context.slots = { ...context.slots, ...updates.slots };\n    }\n\n    if (updates.state) {\n      context.state = updates.state;\n    }\n\n    // \u66F4\u65B0\u6B77\u53F2\u8A18\u9304\n    if (updates.userMessage) {\n      context.history.push({\n        role: 'user',\n        text: updates.userMessage,\n        timestamp: Date.now(),\n      });\n    }\n\n    if (updates.assistantMessage) {\n      context.history.push({\n        role: 'assistant',\n        text: updates.assistantMessage,\n        timestamp: Date.now(),\n      });\n    }\n\n    // \u9650\u5236\u6B77\u53F2\u8A18\u9304\u9577\u5EA6\uFF08\u4FDD\u7559\u6700\u8FD1 20 \u689D\uFF09\n    if (context.history.length > 20) {\n      context.history = context.history.slice(-20);\n    }\n\n    context.lastActivityAt = Date.now();\n    contexts.set(conversationId, context);\n  }\n\n  /**\n   * \u751F\u6210\u5C0D\u8A71 ID\n   */\n  private generateConversationId(): string {\n    return `conv_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\n  }\n\n  /**\n   * \u6E05\u7406\u904E\u671F\u4E0A\u4E0B\u6587\uFF08\u53EF\u9078\uFF0C\u5728 Cloudflare \u4E2D\u53EF\u80FD\u4E0D\u9700\u8981\uFF09\n   */\n  cleanupExpiredContexts(): void {\n    const now = Date.now();\n    for (const [id, context] of contexts.entries()) {\n      if (now - context.lastActivityAt > CONTEXT_TTL) {\n        contexts.delete(id);\n      }\n    }\n  }\n\n  /**\n   * \u6AA2\u67E5\u662F\u5426\u6709\u8DB3\u5920\u7684\u8CC7\u8A0A\u9032\u884C\u63A8\u85A6\n   */\n  hasRequiredSlotsForRecommendation(context: ConversationContext): boolean {\n    // \u81F3\u5C11\u9700\u8981 service_type \u6216 use_case\n    return !!(context.slots.service_type || context.slots.use_case);\n  }\n\n  /**\n   * \u6839\u64DA\u610F\u5716\u548C\u7576\u524D\u72C0\u614B\u6C7A\u5B9A\u4E0B\u4E00\u500B\u72C0\u614B\uFF08\u914D\u7F6E\u9A45\u52D5\u7248\u672C\uFF09\n   * @param currentState \u7576\u524D\u72C0\u614B\n   * @param intent \u610F\u5716\n   * @param hasRequiredSlots \u662F\u5426\u6709\u5FC5\u9700\u7684 slots\n   * @param stateTransitionsConfig \u53EF\u9078\u7684\u72C0\u614B\u8F49\u63DB\u914D\u7F6E\uFF08\u5982\u679C\u63D0\u4F9B\u5247\u4F7F\u7528\u914D\u7F6E\uFF0C\u5426\u5247\u4F7F\u7528 fallback\uFF09\n   */\n  determineNextState(\n    currentState: ConversationContext['state'],\n    intent: string,\n    hasRequiredSlots: boolean,\n    stateTransitionsConfig?: {\n      transitions: Record<string, Record<string, string>>;\n      requiredSlotsCheck?: {\n        fields: string[];\n        requireAny: boolean;\n      };\n    }\n  ): ConversationContext['state'] {\n    // \u5982\u679C\u6C92\u6709\u914D\u7F6E\uFF0C\u4F7F\u7528 fallback \u908F\u8F2F\n    if (!stateTransitionsConfig || !stateTransitionsConfig.transitions) {\n      return this.determineNextStateFallback(currentState, intent, hasRequiredSlots);\n    }\n\n    const transitions = stateTransitionsConfig.transitions[currentState];\n    if (!transitions) {\n      // \u5982\u679C\u7576\u524D\u72C0\u614B\u6C92\u6709\u914D\u7F6E\uFF0C\u4FDD\u6301\u7576\u524D\u72C0\u614B\n      return currentState;\n    }\n\n    // \u512A\u5148\u6AA2\u67E5\u7279\u6B8A\u689D\u4EF6\uFF08hasRequiredSlots\uFF09\n    if (transitions.hasRequiredSlots && hasRequiredSlots) {\n      return transitions.hasRequiredSlots as ConversationContext['state'];\n    }\n\n    // \u6AA2\u67E5\u7CBE\u78BA\u5339\u914D\n    if (transitions[intent]) {\n      return transitions[intent] as ConversationContext['state'];\n    }\n\n    // \u6AA2\u67E5\u6A21\u5F0F\u5339\u914D\uFF08\u652F\u6301 | \u5206\u9694\u7684\u591A\u500B\u610F\u5716\uFF09\n    for (const [pattern, nextState] of Object.entries(transitions)) {\n      if (pattern === 'default' || pattern === 'hasRequiredSlots') continue;\n      if (pattern.includes('|')) {\n        const intentList = pattern.split('|');\n        if (intentList.includes(intent)) {\n          return nextState as ConversationContext['state'];\n        }\n      }\n    }\n\n    // \u4F7F\u7528\u9ED8\u8A8D\u8F49\u63DB\n    return (transitions.default || currentState) as ConversationContext['state'];\n  }\n\n  /**\n   * Fallback \u72C0\u614B\u8F49\u63DB\u908F\u8F2F\uFF08\u539F\u59CB\u786C\u7DE8\u78BC\u7248\u672C\uFF0C\u7528\u65BC\u914D\u7F6E\u7F3A\u5931\u6642\uFF09\n   */\n  private determineNextStateFallback(\n    currentState: ConversationContext['state'],\n    intent: string,\n    hasRequiredSlots: boolean\n  ): ConversationContext['state'] {\n    // \u72C0\u614B\u8F49\u63DB\u908F\u8F2F\uFF08fallback\uFF09\n    if (currentState === 'INIT') {\n      if (intent === 'greeting') {\n        return 'INIT';\n      } else if (intent === 'service_inquiry' || intent === 'price_inquiry') {\n        return 'COLLECTING_INFO';\n      } else if (intent === 'handoff_to_human' || intent === 'complaint') {\n        return 'COMPLETE';\n      }\n    } else if (currentState === 'COLLECTING_INFO') {\n      if (hasRequiredSlots) {\n        return 'RECOMMENDING';\n      } else if (intent === 'handoff_to_human' || intent === 'complaint') {\n        return 'COMPLETE';\n      }\n    } else if (currentState === 'RECOMMENDING') {\n      if (intent === 'goodbye' || intent === 'handoff_to_human') {\n        return 'COMPLETE';\n      } else if (intent === 'service_inquiry' || intent === 'comparison') {\n        return 'FOLLOW_UP';\n      }\n    } else if (currentState === 'FOLLOW_UP') {\n      if (intent === 'goodbye' || intent === 'handoff_to_human') {\n        return 'COMPLETE';\n      }\n    }\n\n    // \u9810\u8A2D\u4FDD\u6301\u7576\u524D\u72C0\u614B\n    return currentState;\n  }\n}\n\n", "/**\n * \u56DE\u61C9\u6A21\u677F\n * \u5305\u542B\u6295\u8A34\u8655\u7406\u3001\u8F49\u771F\u4EBA\u7B49\u6A19\u6E96\u5316\u56DE\u61C9\u6A21\u677F\n */\n\nimport { KnowledgeBase } from './knowledge.js';\n\n// \u6CE8\u610F\uFF1A\u9019\u500B\u51FD\u6578\u9700\u8981 knowledgeBase \u5BE6\u4F8B\uFF0C\u4F46\u5728\u6A21\u677F\u4E2D\u7121\u6CD5\u76F4\u63A5\u8A2A\u554F\n// \u89E3\u6C7A\u65B9\u6848\uFF1A\u5728\u8ABF\u7528\u6642\u50B3\u5165 knowledgeBase \u5BE6\u4F8B\uFF0C\u6216\u4F7F\u7528\u5168\u5C40\u55AE\u4F8B\n// \u9019\u88E1\u5148\u4F7F\u7528\u7C21\u5316\u7248\u672C\uFF0C\u5BE6\u969B\u4F7F\u7528\u6642\u9700\u8981\u50B3\u5165 knowledgeBase\n\nlet knowledgeBaseInstance: KnowledgeBase | null = null;\n\nexport function setKnowledgeBase(kb: KnowledgeBase) {\n  knowledgeBaseInstance = kb;\n}\n\n/**\n * \u6295\u8A34\u8655\u7406\u6A21\u677F\n */\nexport function getComplaintTemplate(): string {\n  try {\n  const contactInfo = knowledgeBaseInstance?.getContactInfo();\n  if (!contactInfo) {\n    return '\u975E\u5E38\u62B1\u6B49\u8B93\u4F60\u9047\u5230\u9019\u6A23\u7684\u60C5\u6CC1\u3002\u8ACB\u806F\u7D61\u6211\u5011\u7684\u771F\u4EBA\u5925\u4F34\u5354\u52A9\u8655\u7406\u3002';\n  }\n\n  const { email, phone, ig } = contactInfo.ai_response_rules.handoff_to_human;\n\n  return `\u975E\u5E38\u62B1\u6B49\u8B93\u4F60\u9047\u5230\u9019\u6A23\u7684\u60C5\u6CC1\uFF0C\u6211\u5B8C\u5168\u7406\u89E3\u4F60\u7684\u611F\u53D7\u3002\u70BA\u4E86\u80FD\u66F4\u6E96\u78BA\u5730\u5354\u52A9\u4F60\uFF0C\u6211\u5EFA\u8B70\u4F60\u76F4\u63A5\u806F\u7D61\u6211\u5011\u7684\u771F\u4EBA\u5925\u4F34\uFF0C\u4ED6\u5011\u6703\u7ACB\u5373\u8655\u7406\u4E26\u63D0\u4F9B\u6700\u9069\u5408\u7684\u89E3\u6C7A\u65B9\u6848\u3002\n\n\u806F\u7D61\u65B9\u5F0F\uFF1A\n- Email\uFF1A${email}\n- \u96FB\u8A71\uFF1A\u4E2D\u5C71\u5E97 ${phone.zhongshan} / \u516C\u9928\u5E97 ${phone.gongguan}\n- IG\uFF1A${ig}\n\n\u6211\u5011\u6703\u76E1\u5FEB\u56DE\u8986\u4E26\u5354\u52A9\u4F60\u89E3\u6C7A\u554F\u984C\u3002\n\n**\u91CD\u8981\u63D0\u9192\uFF1A\u6240\u6709\u88DC\u511F\u6C7A\u7B56\u90FD\u7531\u771F\u4EBA\u5BA2\u670D\u8655\u7406\uFF0C\u4EE5\u78BA\u4FDD\u516C\u5E73\u8207\u6E96\u78BA\u3002**`;\n  } catch (error) {\n    return '\u975E\u5E38\u62B1\u6B49\u8B93\u4F60\u9047\u5230\u9019\u6A23\u7684\u60C5\u6CC1\u3002\u8ACB\u806F\u7D61\u6211\u5011\u7684\u771F\u4EBA\u5925\u4F34\u5354\u52A9\u8655\u7406\u3002';\n  }\n}\n\n/**\n * \u8F49\u771F\u4EBA\u6A21\u677F\n */\nexport function getHandoffTemplate(reason?: string): string {\n  const contactInfo = knowledgeBaseInstance?.getContactInfo();\n  if (!contactInfo) {\n    return '\u5EFA\u8B70\u4F60\u900F\u904E Email \u6216\u96FB\u8A71\u806F\u7D61\u6211\u5011\u7684\u771F\u4EBA\u5925\u4F34\u3002';\n  }\n\n  const { email, phone, ig, booking_link } = contactInfo.ai_response_rules.handoff_to_human;\n\n  let message = '\u9019\u985E\u554F\u984C\u6BD4\u8F03\u9069\u5408\u7531\u771F\u4EBA\u5925\u4F34\u4F86\u5354\u52A9\uFF0C\u6703\u6BD4\u8F03\u7CBE\u6E96\u3001\u4E5F\u66F4\u8CBC\u8FD1\u4F60\u7684\u72C0\u6CC1 \uD83D\uDE4F\\n\\n\u5EFA\u8B70\u4F60\u53EF\u4EE5\u900F\u904E\u4EE5\u4E0B\u65B9\u5F0F\u806F\u7D61\u6211\u5011\uFF1A\\n';\n  message += `- Email\uFF1A${email}\\n`;\n  message += `- \u96FB\u8A71\uFF1A\u4E2D\u5C71\u5E97 ${phone.zhongshan} / \u516C\u9928\u5E97 ${phone.gongguan}\\n`;\n  message += `- IG\uFF1A${ig}\\n`;\n  message += `- \u9810\u7D04\u9023\u7D50\uFF1A${booking_link}`;\n\n  if (reason) {\n    message += `\\n\\n\u539F\u56E0\uFF1A${reason}`;\n  }\n\n  return message;\n}\n\n/**\n * \u7121\u6CD5\u7406\u89E3\u6A21\u677F\uFF08\u7B2C\u4E00\u6B21\uFF09\n */\nexport function getDontUnderstandFirst(): string {\n  return '\u62B1\u6B49\uFF0C\u6211\u6C92\u6709\u5B8C\u5168\u7406\u89E3\u4F60\u7684\u554F\u984C \uD83E\uDD7A \u65B9\u4FBF\u518D\u591A\u8DDF\u6211\u8AAA\u4E00\u9EDE\u55CE\uFF1F\u4F60\u53EF\u4EE5\u9019\u6A23\u63CF\u8FF0\uFF0C\u4F8B\u5982\uFF1A\u6211\u662F\u5B78\u751F\uFF0C\u60F3\u62CD\u5C65\u6B77\u7167\uFF1B\u6216\u662F\u6211\u5011\u5BB6\u60F3\u62CD\u5168\u5BB6\u798F\u3002';\n}\n\n/**\n * \u7121\u6CD5\u7406\u89E3\u6A21\u677F\uFF08\u7B2C\u4E8C\u6B21\uFF09\n */\nexport function getDontUnderstandSecond(): string {\n  const contactInfo = knowledgeBaseInstance?.getContactInfo();\n  if (!contactInfo) {\n    return '\u6211\u9084\u662F\u6C92\u6709\u5F88\u78BA\u5B9A\u4F60\u7684\u9700\u6C42\uFF0C\u6015\u8AA4\u6703\u4E86\u53CD\u800C\u5E6B\u4E0D\u4E0A\u5FD9\u3002\u6BD4\u8F03\u91CD\u8981\u6216\u7DCA\u6025\u7684\u72C0\u6CC1\uFF0C\u6703\u5EFA\u8B70\u4F60\u76F4\u63A5\u806F\u7D61\u771F\u4EBA\u5925\u4F34\u3002';\n  }\n\n  const { email, phone } = contactInfo.ai_response_rules.handoff_to_human;\n\n  return `\u6211\u9084\u662F\u6C92\u6709\u5F88\u78BA\u5B9A\u4F60\u7684\u9700\u6C42\uFF0C\u6015\u8AA4\u6703\u4E86\u53CD\u800C\u5E6B\u4E0D\u4E0A\u5FD9\u3002\u6BD4\u8F03\u91CD\u8981\u6216\u7DCA\u6025\u7684\u72C0\u6CC1\uFF0C\u6703\u5EFA\u8B70\u4F60\u76F4\u63A5\u806F\u7D61\u771F\u4EBA\u5925\u4F34\uFF1AEmail\uFF08${email}\uFF09\u6216\u96FB\u8A71\uFF08\u4E2D\u5C71\u5E97 ${phone.zhongshan} / \u516C\u9928\u5E97 ${phone.gongguan}\uFF09\u3002`;\n}\n\n/**\n * API \u932F\u8AA4\u6A21\u677F\n */\nexport function getApiErrorTemplate(): string {\n  try {\n  const contactInfo = knowledgeBaseInstance?.getContactInfo();\n  if (!contactInfo) {\n    return '\u7CDF\u7CD5\uFF0C\u5F8C\u53F0\u7CFB\u7D71\u73FE\u5728\u6709\u9EDE\u5FD9\u788C\uFF0C\u6211\u66AB\u6642\u62FF\u4E0D\u5230\u6B63\u78BA\u7684\u8CC7\u8A0A \uD83D\uDE23 \u4F60\u53EF\u4EE5\u904E\u5E7E\u5206\u9418\u518D\u8A66\u4E00\u6B21\uFF0C\u6216\u76F4\u63A5\u900F\u904E Email \u6216\u96FB\u8A71\u806F\u7D61\u6211\u5011\u7684\u771F\u4EBA\u5925\u4F34\u3002';\n  }\n\n  const { email, phone } = contactInfo.ai_response_rules.handoff_to_human;\n\n  return `\u7CDF\u7CD5\uFF0C\u5F8C\u53F0\u7CFB\u7D71\u73FE\u5728\u6709\u9EDE\u5FD9\u788C\uFF0C\u6211\u66AB\u6642\u62FF\u4E0D\u5230\u6B63\u78BA\u7684\u8CC7\u8A0A \uD83D\uDE23 \u4F60\u53EF\u4EE5\u904E\u5E7E\u5206\u9418\u518D\u8A66\u4E00\u6B21\uFF0C\u6216\u76F4\u63A5\u900F\u904E Email\uFF08${email}\uFF09\u6216\u96FB\u8A71\uFF08\u4E2D\u5C71\u5E97 ${phone.zhongshan} / \u516C\u9928\u5E97 ${phone.gongguan}\uFF09\u806F\u7D61\u6211\u5011\u7684\u771F\u4EBA\u5925\u4F34\u3002`;\n  } catch (error) {\n    // \u5982\u679C\u77E5\u8BC6\u5E93\u672A\u52A0\u8F7D\uFF0C\u8FD4\u56DE\u9ED8\u8BA4\u9519\u8BEF\u6D88\u606F\n    return '\u7CDF\u7CD5\uFF0C\u5F8C\u53F0\u7CFB\u7D71\u73FE\u5728\u6709\u9EDE\u5FD9\u788C\uFF0C\u6211\u66AB\u6642\u62FF\u4E0D\u5230\u6B63\u78BA\u7684\u8CC7\u8A0A \uD83D\uDE23 \u4F60\u53EF\u4EE5\u904E\u5E7E\u5206\u9418\u518D\u8A66\u4E00\u6B21\uFF0C\u6216\u76F4\u63A5\u900F\u904E Email \u6216\u96FB\u8A71\u806F\u7D61\u6211\u5011\u7684\u771F\u4EBA\u5925\u4F34\u3002';\n  }\n}\n\n/**\n * Timeout \u6A21\u677F\n */\nexport function getTimeoutTemplate(): string {\n  const contactInfo = knowledgeBaseInstance?.getContactInfo();\n  if (!contactInfo) {\n    return '\u9019\u6B21\u56DE\u8986\u82B1\u7684\u6642\u9593\u6709\u9EDE\u4E45\uFF0C\u6211\u6015\u7CFB\u7D71\u5361\u4F4F\u4E86\u3002\u4F60\u53EF\u4EE5\u91CD\u65B0\u63D0\u554F\u4E00\u6B21\uFF0C\u6216\u76F4\u63A5\u7528 Email \u6216\u96FB\u8A71\u627E\u771F\u4EBA\u5354\u52A9\u3002';\n  }\n\n  const { email, phone } = contactInfo.ai_response_rules.handoff_to_human;\n\n  return `\u9019\u6B21\u56DE\u8986\u82B1\u7684\u6642\u9593\u6709\u9EDE\u4E45\uFF0C\u6211\u6015\u7CFB\u7D71\u5361\u4F4F\u4E86\u3002\u4F60\u53EF\u4EE5\u91CD\u65B0\u63D0\u554F\u4E00\u6B21\uFF0C\u6216\u76F4\u63A5\u7528 Email\uFF08${email}\uFF09\u6216\u96FB\u8A71\uFF08\u4E2D\u5C71\u5E97 ${phone.zhongshan} / \u516C\u9928\u5E97 ${phone.gongguan}\uFF09\u627E\u771F\u4EBA\u5354\u52A9\u3002`;\n}\n\n/**\n * Line \u5B98\u65B9\u5E33\u865F\u56DE\u61C9\u6A21\u677F\n */\nexport function getLineInquiryTemplate(): string {\n  const contactInfo = knowledgeBaseInstance?.getContactInfo();\n  if (!contactInfo) {\n    return '\u6211\u5011\u76EE\u524D\u6C92\u6709\u63D0\u4F9B Line \u5B98\u65B9\u5E33\u865F\u670D\u52D9\uFF0C\u5982\u6709\u9700\u8981\u53EF\u4EE5\u900F\u904E Email \u6216\u96FB\u8A71\u806F\u7D61\u6211\u5011\u3002';\n  }\n\n  return contactInfo.ai_response_rules.line_inquiry;\n}\n\n", "/**\n * Pipeline \u6838\u5FC3\u6846\u67B6\n * \u652F\u6301\u7BC0\u9EDE\u5F0F\u57F7\u884C\u3001\u63D0\u524D\u9000\u51FA\u3001\u932F\u8AA4\u91CD\u65B0\u62CB\u51FA\n */\n\nimport { ConversationContext } from './contextManager.js';\n\n/**\n * Pipeline \u4E0A\u4E0B\u6587 - \u7D71\u4E00\u7684\u6578\u64DA\u6D41\uFF08\u985E\u4F3C n8n \u7684 JSON payload\uFF09\n */\nexport interface PipelineContext {\n  // \u8F38\u5165\u6578\u64DA\n  request: Request;\n  env: any;\n  body?: any; // ChatRequestBody\uFF0C\u5728\u9A57\u8B49\u7BC0\u9EDE\u5F8C\u586B\u5145\n  \n  // \u4E2D\u9593\u8655\u7406\u6578\u64DA\n  corsHeaders: Record<string, string>;\n  knowledgeBase?: any; // KnowledgeBase\n  llmService?: any; // LLMService\n  contextManager?: any; // ContextManager\n  conversationContext?: ConversationContext;\n  \n  // \u8655\u7406\u7D50\u679C\n  intent?: string;\n  entities?: Record<string, any>;\n  mergedEntities?: Record<string, any>;\n  nextState?: ConversationContext['state'];\n  reply?: string;\n  \n  // \u5143\u6578\u64DA\n  startTime: number;\n  logs: Array<{\n    node: string;\n    level: 'INFO' | 'SUCCESS' | 'ERROR' | 'WARN';\n    message: string;\n    timestamp: number;\n    duration?: number;\n  }>;\n}\n\n/**\n * Pipeline \u7BC0\u9EDE\u985E\u578B\n * \u53EF\u4EE5\u8FD4\u56DE\uFF1A\n * - PipelineContext: \u7E7C\u7E8C\u4E0B\u4E00\u500B\u7BC0\u9EDE\n * - Response: \u63D0\u524D\u7D50\u675F\u6D41\u7A0B\n */\nexport type PipelineNode = (ctx: PipelineContext) => Promise<PipelineContext | Response>;\n\n/**\n * Pipeline \u914D\u7F6E\n */\ninterface PipelineConfig {\n  enableDetailedLogging?: boolean;\n  logLevel?: 'INFO' | 'SUCCESS' | 'ERROR' | 'WARN';\n}\n\n/**\n * Pipeline \u4E3B\u985E\n */\nexport class Pipeline {\n  private nodes: Array<{ name: string; node: PipelineNode }> = [];\n  private config: PipelineConfig;\n\n  constructor(config: PipelineConfig = {}) {\n    this.config = {\n      enableDetailedLogging: true,\n      logLevel: 'INFO',\n      ...config,\n    };\n  }\n\n  /**\n   * \u6DFB\u52A0\u7BC0\u9EDE\n   */\n  addNode(name: string, node: PipelineNode): void {\n    this.nodes.push({ name, node });\n  }\n\n  /**\n   * \u57F7\u884C Pipeline\n   */\n  async execute(context: PipelineContext): Promise<Response> {\n    for (const { name, node } of this.nodes) {\n      const startNodeTime = Date.now();\n      \n      try {\n        // \u7BC0\u9EDE\u524D\u65E5\u8A8C\n        this.log(context, name, 'INFO', `\u958B\u59CB\u57F7\u884C\u7BC0\u9EDE: ${name}`);\n        \n        // \u57F7\u884C\u7BC0\u9EDE\n        const result = await node(context);\n        \n        // \u5982\u679C\u662F Response\uFF0C\u76F4\u63A5\u8FD4\u56DE\uFF08\u63D0\u524D\u7D50\u675F\u6D41\u7A0B\uFF09\n        if (result instanceof Response) {\n          const duration = Date.now() - startNodeTime;\n          this.log(context, name, 'SUCCESS', `\u7BC0\u9EDE ${name} \u8FD4\u56DE\u97FF\u61C9\uFF0C\u6D41\u7A0B\u7D50\u675F`, duration);\n          return result;\n        }\n        \n        // \u66F4\u65B0\u4E0A\u4E0B\u6587\uFF0C\u7E7C\u7E8C\u4E0B\u4E00\u500B\u7BC0\u9EDE\n        context = result;\n        const duration = Date.now() - startNodeTime;\n        this.log(context, name, 'SUCCESS', `\u7BC0\u9EDE ${name} \u57F7\u884C\u5B8C\u6210`, duration);\n        \n      } catch (error) {\n        // \u26A0\uFE0F \u95DC\u9375\uFF1A\u7BC0\u9EDE\u932F\u8AA4\u5FC5\u9808\u91CD\u65B0\u62CB\u51FA\uFF0C\u7531\u5916\u5C64\u7D71\u4E00\u8655\u7406\n        const duration = Date.now() - startNodeTime;\n        this.log(context, name, 'ERROR', `\u7BC0\u9EDE ${name} \u57F7\u884C\u5931\u6557: ${error instanceof Error ? error.message : String(error)}`, duration);\n        throw error; // \u4E0D\u8981\u6355\u7372\uFF0C\u8B93\u5916\u5C64\u8655\u7406\n      }\n    }\n    \n    // \u6240\u6709\u7BC0\u9EDE\u57F7\u884C\u5B8C\u7562\uFF08\u7406\u8AD6\u4E0A\u4E0D\u61C9\u8A72\u5230\u9019\u88E1\uFF0C\u61C9\u8A72\u5728\u524D\u9762\u7684\u7BC0\u9EDE\u8FD4\u56DE Response\uFF09\n    throw new Error('Pipeline execution completed without returning a response');\n  }\n\n  /**\n   * \u8A18\u9304\u65E5\u8A8C\n   */\n  private log(\n    ctx: PipelineContext,\n    node: string,\n    level: 'INFO' | 'SUCCESS' | 'ERROR' | 'WARN',\n    message: string,\n    duration?: number\n  ): void {\n    const logEntry = {\n      node,\n      level,\n      message,\n      timestamp: Date.now(),\n      duration,\n    };\n    \n    ctx.logs.push(logEntry);\n    \n    // \u540C\u6642\u8F38\u51FA\u5230 console\uFF08\u7D50\u69CB\u5316\u65E5\u8A8C\uFF09\n    if (this.shouldLog(level)) {\n      const prefix = `[Pipeline:${node}]`;\n      const durationStr = duration !== undefined ? ` (${duration}ms)` : '';\n      const emoji = {\n        INFO: '\u2139\uFE0F',\n        SUCCESS: '\u2705',\n        ERROR: '\u274C',\n        WARN: '\u26A0\uFE0F',\n      }[level];\n      \n      console.log(`${emoji} ${prefix} [${level}] ${message}${durationStr}`);\n    }\n  }\n\n  /**\n   * \u5224\u65B7\u662F\u5426\u61C9\u8A72\u8A18\u9304\u65E5\u8A8C\n   */\n  private shouldLog(level: 'INFO' | 'SUCCESS' | 'ERROR' | 'WARN'): boolean {\n    if (!this.config.enableDetailedLogging) {\n      return level === 'ERROR' || level === 'WARN';\n    }\n    \n    const levels = ['INFO', 'SUCCESS', 'WARN', 'ERROR'];\n    const currentLevelIndex = levels.indexOf(this.config.logLevel || 'INFO');\n    const messageLevelIndex = levels.indexOf(level);\n    \n    return messageLevelIndex >= currentLevelIndex;\n  }\n\n  /**\n   * \u7372\u53D6\u7BC0\u9EDE\u5217\u8868\uFF08\u7528\u65BC\u8ABF\u8A66\uFF09\n   */\n  getNodeNames(): string[] {\n    return this.nodes.map(n => n.name);\n  }\n\n  /**\n   * \u6E05\u7A7A\u6240\u6709\u7BC0\u9EDE\uFF08\u7528\u65BC\u6E2C\u8A66\uFF09\n   */\n  clear(): void {\n    this.nodes = [];\n  }\n}\n\n", "/**\n * \u7BC0\u9EDE 1: \u8ACB\u6C42\u9A57\u8B49\n * \u9A57\u8B49 CORS\u3001Content-Type\u3001\u8ACB\u6C42\u9AD4\u683C\u5F0F\u3001\u6240\u6709\u53C3\u6578\n */\n\nimport { PipelineContext } from '../lib/pipeline.js';\n\ninterface ChatRequestBody {\n  message: string;\n  source?: 'menu' | 'input';\n  mode?: 'auto' | 'decision_recommendation' | 'faq_flow_price';\n  pageType?: 'home' | 'qa';\n  conversationId?: string;\n  context?: {\n    last_intent?: string;\n    slots?: {\n      service_type?: string;\n      use_case?: string;\n      persona?: string;\n    };\n  };\n}\n\n/**\n * \u69CB\u5EFA CORS headers\n */\nfunction buildCorsHeaders(request: Request): Record<string, string> {\n  const allowedOrigins = [\n    'https://goldenyearsphoto.pages.dev',\n    'https://www.goldenyearsphoto.com',\n    'https://goldenyearsphoto.com',\n    // \u958B\u767C\u74B0\u5883\n    'http://localhost:8080',\n    'http://127.0.0.1:8080',\n    'http://localhost:8081',\n    'http://127.0.0.1:8081',\n  ];\n  \n  const origin = request.headers.get('Origin');\n  const allowedOrigin = origin && allowedOrigins.includes(origin) ? origin : allowedOrigins[0];\n  \n  return {\n    'Access-Control-Allow-Origin': allowedOrigin,\n    'Access-Control-Allow-Methods': 'POST, OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'Access-Control-Max-Age': '86400', // 24 hours\n  };\n}\n\n/**\n * \u8ACB\u6C42\u9A57\u8B49\u7BC0\u9EDE\n */\nexport async function node_validateRequest(ctx: PipelineContext): Promise<PipelineContext | Response> {\n  // 1. \u8655\u7406 OPTIONS \u8ACB\u6C42\n  if (ctx.request.method === 'OPTIONS') {\n    return new Response(null, { \n      status: 204, \n      headers: ctx.corsHeaders \n    });\n  }\n\n  // 2. \u69CB\u5EFA CORS headers\uFF08\u5982\u679C\u9084\u6C92\u6709\uFF09\n  if (!ctx.corsHeaders || Object.keys(ctx.corsHeaders).length === 0) {\n    ctx.corsHeaders = buildCorsHeaders(ctx.request);\n  }\n\n  // 3. \u9A57\u8B49 Content-Type\n  const contentType = ctx.request.headers.get('content-type');\n  if (!contentType || !contentType.includes('application/json')) {\n    return new Response(\n      JSON.stringify({ \n        error: 'Invalid Content-Type', \n        message: '\u8ACB\u6C42\u5FC5\u9808\u4F7F\u7528 application/json' \n      }),\n      { \n        status: 400, \n        headers: { \n          ...ctx.corsHeaders, \n          'Content-Type': 'application/json' \n        } \n      }\n    );\n  }\n\n  // 4. \u89E3\u6790\u8ACB\u6C42\u9AD4\uFF08\u6DFB\u52A0\u932F\u8AA4\u8655\u7406\uFF09\n  let body: ChatRequestBody;\n  try {\n    body = await ctx.request.json();\n  } catch (error) {\n    console.error('[Chat] Failed to parse request body:', error);\n    return new Response(\n      JSON.stringify({ \n        error: 'Invalid JSON', \n        message: '\u8ACB\u6C42\u9AD4\u5FC5\u9808\u662F\u6709\u6548\u7684 JSON \u683C\u5F0F' \n      }),\n      { \n        status: 400, \n        headers: { \n          ...ctx.corsHeaders, \n          'Content-Type': 'application/json' \n        } \n      }\n    );\n  }\n\n  // 5. \u9A57\u8B49\u5FC5\u8981\u6B04\u4F4D\n  if (!body.message || typeof body.message !== 'string' || body.message.trim().length === 0) {\n    return new Response(\n      JSON.stringify({ \n        error: 'Invalid request', \n        message: 'message \u6B04\u4F4D\u70BA\u5FC5\u586B\u4E14\u4E0D\u80FD\u70BA\u7A7A' \n      }),\n      { \n        status: 400, \n        headers: { \n          ...ctx.corsHeaders, \n          'Content-Type': 'application/json' \n        } \n      }\n    );\n  }\n\n  // 6. \u9A57\u8B49 message \u9577\u5EA6\n  if (body.message.length > 1000) {\n    return new Response(\n      JSON.stringify({ \n        error: 'Invalid request', \n        message: 'message \u9577\u5EA6\u4E0D\u80FD\u8D85\u904E 1000 \u5B57\u5143' \n      }),\n      { \n        status: 400, \n        headers: { \n          ...ctx.corsHeaders, \n          'Content-Type': 'application/json' \n        } \n      }\n    );\n  }\n\n  // 7. \u9A57\u8B49 conversationId \u683C\u5F0F\uFF08\u5982\u679C\u63D0\u4F9B\uFF09\n  if (body.conversationId) {\n    if (typeof body.conversationId !== 'string' || \n        body.conversationId.length > 100 ||\n        !/^conv_[a-zA-Z0-9_]+$/.test(body.conversationId)) {\n      return new Response(\n        JSON.stringify({ \n          error: 'Invalid request', \n          message: 'conversationId \u683C\u5F0F\u4E0D\u6B63\u78BA' \n        }),\n        { \n          status: 400, \n          headers: { \n            ...ctx.corsHeaders, \n            'Content-Type': 'application/json' \n          } \n        }\n      );\n    }\n  }\n\n  // 8. \u9A57\u8B49 mode \u503C\n  if (body.mode && !['auto', 'decision_recommendation', 'faq_flow_price'].includes(body.mode)) {\n    return new Response(\n      JSON.stringify({ \n        error: 'Invalid request', \n        message: 'mode \u503C\u4E0D\u6B63\u78BA' \n      }),\n      { \n        status: 400, \n        headers: { \n          ...ctx.corsHeaders, \n          'Content-Type': 'application/json' \n        } \n      }\n    );\n  }\n\n  // 9. \u9A57\u8B49 source \u503C\n  if (body.source && !['menu', 'input'].includes(body.source)) {\n    return new Response(\n      JSON.stringify({ \n        error: 'Invalid request', \n        message: 'source \u503C\u4E0D\u6B63\u78BA' \n      }),\n      { \n        status: 400, \n        headers: { \n          ...ctx.corsHeaders, \n          'Content-Type': 'application/json' \n        } \n      }\n    );\n  }\n\n  // 10. \u9A57\u8B49 pageType \u503C\n  if (body.pageType && !['home', 'qa'].includes(body.pageType)) {\n    return new Response(\n      JSON.stringify({ \n        error: 'Invalid request', \n        message: 'pageType \u503C\u4E0D\u6B63\u78BA' \n      }),\n      { \n        status: 400, \n        headers: { \n          ...ctx.corsHeaders, \n          'Content-Type': 'application/json' \n        } \n      }\n    );\n  }\n\n  // \u9A57\u8B49\u901A\u904E\uFF0C\u5C07 body \u5B58\u5165 context\n  ctx.body = body;\n  return ctx;\n}\n\n", "/**\n * \u7BC0\u9EDE 2: \u670D\u52D9\u521D\u59CB\u5316\n * \u8F09\u5165\u77E5\u8B58\u5EAB\u3001\u521D\u59CB\u5316 LLM \u670D\u52D9\u3001\u521D\u59CB\u5316 Context Manager\n * \n * \u26A0\uFE0F \u95DC\u9375\u4FEE\u6B63\u9EDE\uFF1A\n * 1. \u77E5\u8B58\u5EAB\u8F09\u5165\u5F8C\u5FC5\u9808\u7ACB\u5373\u8ABF\u7528 setKnowledgeBase(kb)\n * 2. \u77E5\u8B58\u5EAB\u932F\u8AA4\u5FC5\u9808\u91CD\u65B0\u62CB\u51FA\n */\n\nimport { PipelineContext } from '../lib/pipeline.js';\nimport { setKnowledgeBase } from '../lib/responseTemplates.js';\nimport { loadKnowledgeBase, initLLMService, initContextManager } from '../chat.js';\n\n/**\n * \u670D\u52D9\u521D\u59CB\u5316\u7BC0\u9EDE\n */\nexport async function node_initializeServices(ctx: PipelineContext): Promise<PipelineContext> {\n  // \u8F09\u5165\u77E5\u8B58\u5EAB\n  let kb;\n  try {\n    console.log('[Chat] Loading knowledge base...');\n    const url = new URL(ctx.request.url);\n    console.log('[Chat] Request host:', url.host);\n    \n    kb = await loadKnowledgeBase(ctx.request);\n    console.log('[Chat] Knowledge base loaded successfully');\n  } catch (error) {\n    console.error('[Chat] Failed to load knowledge base:', error);\n    console.error('[Chat] Error details:', error instanceof Error ? {\n      message: error.message,\n      stack: error.stack?.substring(0, 500) // \u9650\u5236 stack \u9577\u5EA6\n    } : String(error));\n    \n    // \u26A0\uFE0F \u95DC\u9375\u4FEE\u6B63 4: \u77E5\u8B58\u5EAB\u932F\u8AA4\u5FC5\u9808\u91CD\u65B0\u62CB\u51FA\uFF0C\u7531\u5916\u5C64\u7D71\u4E00\u8655\u7406\n    throw error;\n  }\n  \n  // \u26A0\uFE0F \u95DC\u9375\u4FEE\u6B63 1: \u5FC5\u9808\u5728\u77E5\u8B58\u5EAB\u8F09\u5165\u5F8C\u7ACB\u5373\u8ABF\u7528 setKnowledgeBase\n  // \u9019\u5F71\u97FF responseTemplates \u6A21\u584A\n  setKnowledgeBase(kb);\n  \n  // \u521D\u59CB\u5316\u670D\u52D9\n  console.log('[Chat] Initializing services...');\n  const llm = initLLMService(ctx.env);\n  const cm = initContextManager();\n  console.log('[Chat] Services initialized. LLM available:', !!llm);\n  \n  // \u5C07\u670D\u52D9\u5B58\u5165 context\n  ctx.knowledgeBase = kb;\n  ctx.llmService = llm;\n  ctx.contextManager = cm;\n  \n  return ctx;\n}\n\n", "/**\n * \u7BC0\u9EDE 3: \u4E0A\u4E0B\u6587\u7BA1\u7406\n * \u7372\u53D6\u6216\u5275\u5EFA\u5C0D\u8A71\u4E0A\u4E0B\u6587\n */\n\nimport { PipelineContext } from '../lib/pipeline.js';\n\n/**\n * \u4E0A\u4E0B\u6587\u7BA1\u7406\u7BC0\u9EDE\n */\nexport async function node_contextManagement(ctx: PipelineContext): Promise<PipelineContext> {\n  if (!ctx.contextManager) {\n    throw new Error('ContextManager not initialized');\n  }\n\n  if (!ctx.body) {\n    throw new Error('Request body not validated');\n  }\n\n  // \u7372\u53D6\u6216\u5275\u5EFA\u4E0A\u4E0B\u6587\n  let context_obj;\n  if (ctx.body.conversationId) {\n    const existingContext = ctx.contextManager.getContext(ctx.body.conversationId);\n    if (existingContext) {\n      context_obj = existingContext;\n    } else {\n      context_obj = ctx.contextManager.createContext(ctx.body.conversationId);\n    }\n  } else {\n    context_obj = ctx.contextManager.createContext();\n  }\n\n  // \u5B58\u5165 context\n  ctx.conversationContext = context_obj;\n\n  return ctx;\n}\n\n", "/**\n * \u7BC0\u9EDE 4: \u610F\u5716\u63D0\u53D6\n * \u610F\u5716\u5206\u985E\u3001\u5BE6\u9AD4\u63D0\u53D6\u3001\u5BE6\u9AD4\u5408\u4F75\n */\n\nimport { PipelineContext } from '../lib/pipeline.js';\nimport { classifyIntent, extractEntities } from '../chat.js';\n\n/**\n * \u610F\u5716\u63D0\u53D6\u7BC0\u9EDE\n */\nexport async function node_intentExtraction(ctx: PipelineContext): Promise<PipelineContext> {\n  if (!ctx.knowledgeBase) {\n    throw new Error('KnowledgeBase not initialized');\n  }\n\n  if (!ctx.body) {\n    throw new Error('Request body not validated');\n  }\n\n  if (!ctx.conversationContext) {\n    throw new Error('ConversationContext not initialized');\n  }\n\n  // \u610F\u5716\u5206\u985E\uFF08\u4F7F\u7528\u914D\u7F6E\u9A45\u52D5\uFF09\n  const intent = classifyIntent(ctx.body.message, {\n    last_intent: ctx.conversationContext.last_intent,\n    slots: ctx.conversationContext.slots,\n  }, ctx.knowledgeBase);\n\n  // \u5BE6\u9AD4\u63D0\u53D6\uFF08\u4F7F\u7528\u914D\u7F6E\u9A45\u52D5\uFF09\n  const entities = extractEntities(ctx.body.message, ctx.knowledgeBase);\n\n  // \u5408\u4F75\u4E0A\u4E0B\u6587\u4E2D\u7684\u5BE6\u9AD4\n  const mergedEntities = {\n    ...ctx.conversationContext.slots,\n    ...entities,\n  };\n\n  // \u5B58\u5165 context\n  ctx.intent = intent;\n  ctx.entities = entities;\n  ctx.mergedEntities = mergedEntities;\n\n  return ctx;\n}\n\n", "/**\n * \u7BC0\u9EDE 5: \u72C0\u614B\u8F49\u63DB\n * \u6C7A\u5B9A\u4E0B\u4E00\u500B\u5C0D\u8A71\u72C0\u614B\uFF08\u4F7F\u7528\u914D\u7F6E\u9A45\u52D5\uFF09\n */\n\nimport { PipelineContext } from '../lib/pipeline.js';\n\n/**\n * \u72C0\u614B\u8F49\u63DB\u7BC0\u9EDE\n */\nexport async function node_stateTransition(ctx: PipelineContext): Promise<PipelineContext> {\n  if (!ctx.knowledgeBase) {\n    throw new Error('KnowledgeBase not initialized');\n  }\n\n  if (!ctx.contextManager) {\n    throw new Error('ContextManager not initialized');\n  }\n\n  if (!ctx.conversationContext) {\n    throw new Error('ConversationContext not initialized');\n  }\n\n  if (!ctx.intent) {\n    throw new Error('Intent not extracted');\n  }\n\n  if (!ctx.mergedEntities) {\n    throw new Error('Merged entities not calculated');\n  }\n\n  // \u6C7A\u5B9A\u4E0B\u4E00\u500B\u72C0\u614B\uFF08\u4F7F\u7528\u914D\u7F6E\u9A45\u52D5\uFF09\n  let nextState = ctx.conversationContext.state;\n  \n  try {\n    const stateTransitionsConfig = ctx.knowledgeBase.getStateTransitionsConfig();\n    \n    if (stateTransitionsConfig) {\n      // \u6AA2\u67E5\u662F\u5426\u6709\u5FC5\u9700\u7684 slots\uFF08\u4F7F\u7528\u914D\u7F6E\u4E2D\u7684\u898F\u5247\uFF09\n      const requiredSlotsCheck = stateTransitionsConfig.requiredSlotsCheck;\n      let hasRequiredSlots = false;\n      \n      if (requiredSlotsCheck) {\n        if (requiredSlotsCheck.requireAny) {\n          // \u9700\u8981\u4EFB\u610F\u4E00\u500B\u5B57\u6BB5\n          hasRequiredSlots = requiredSlotsCheck.fields.some(field => ctx.mergedEntities![field]);\n        } else {\n          // \u9700\u8981\u6240\u6709\u5B57\u6BB5\n          hasRequiredSlots = requiredSlotsCheck.fields.every(field => ctx.mergedEntities![field]);\n        }\n      } else {\n        // \u9ED8\u8A8D\u908F\u8F2F\uFF1A\u81F3\u5C11\u9700\u8981 service_type \u6216 use_case\n        hasRequiredSlots = !!(ctx.mergedEntities!.service_type || ctx.mergedEntities!.use_case);\n      }\n\n      nextState = ctx.contextManager.determineNextState(\n        ctx.conversationContext.state,\n        ctx.intent,\n        hasRequiredSlots,\n        {\n          transitions: stateTransitionsConfig.transitions,\n          requiredSlotsCheck: stateTransitionsConfig.requiredSlotsCheck,\n        }\n      );\n    } else {\n      // \u5982\u679C\u6C92\u6709\u914D\u7F6E\uFF0C\u4F7F\u7528 fallback \u908F\u8F2F\n      const hasRequiredSlots = !!(ctx.mergedEntities!.service_type || ctx.mergedEntities!.use_case);\n      nextState = ctx.contextManager.determineNextState(\n        ctx.conversationContext.state,\n        ctx.intent,\n        hasRequiredSlots\n      );\n    }\n  } catch (error) {\n    console.warn('[Chat] Failed to determine next state, using current state:', error);\n    // \u4F7F\u7528\u7576\u524D\u72C0\u614B\u4F5C\u70BA fallback\n    nextState = ctx.conversationContext.state;\n  }\n\n  // \u5B58\u5165 context\n  ctx.nextState = nextState;\n\n  return ctx;\n}\n\n", "/**\n * \u7BC0\u9EDE 6: \u7279\u6B8A\u610F\u5716\u8655\u7406\n * Line \u8A62\u554F\u3001\u6295\u8A34\u3001\u8F49\u771F\u4EBA\u7B49\u7279\u6B8A\u610F\u5716\u7684\u8655\u7406\n */\n\nimport { PipelineContext } from '../lib/pipeline.js';\nimport { buildResponse } from '../chat.js';\nimport { getLineInquiryTemplate, getComplaintTemplate, getHandoffTemplate } from '../lib/responseTemplates.js';\n\n/**\n * \u7279\u6B8A\u610F\u5716\u8655\u7406\u7BC0\u9EDE\n */\nexport async function node_specialIntents(ctx: PipelineContext): Promise<PipelineContext | Response> {\n  if (!ctx.body) {\n    throw new Error('Request body not validated');\n  }\n\n  if (!ctx.intent) {\n    throw new Error('Intent not extracted');\n  }\n\n  if (!ctx.conversationContext) {\n    throw new Error('ConversationContext not initialized');\n  }\n\n  if (!ctx.mergedEntities) {\n    throw new Error('Merged entities not calculated');\n  }\n\n  if (!ctx.contextManager) {\n    throw new Error('ContextManager not initialized');\n  }\n\n  if (!ctx.knowledgeBase) {\n    throw new Error('KnowledgeBase not initialized');\n  }\n\n  if (!ctx.nextState) {\n    throw new Error('Next state not determined');\n  }\n\n  // \u6AA2\u67E5 Line \u5B98\u65B9\u5E33\u865F\u8A62\u554F\n  if (ctx.body.message.includes('line') || \n      ctx.body.message.includes('Line') || \n      ctx.body.message.includes('LINE')) {\n    return buildResponse(\n      getLineInquiryTemplate(),\n      ctx.intent,\n      ctx.conversationContext.conversationId,\n      ctx.mergedEntities,\n      ctx.contextManager,\n      ctx.knowledgeBase,\n      ctx.body.message,\n      ctx.corsHeaders,\n      ctx.nextState\n    );\n  }\n\n  // \u610F\u5716\u8655\u7406\u5668\u6620\u5C04\u8868\uFF08\u6295\u8A34\u3001\u8F49\u771F\u4EBA\uFF09\n  const intentHandlers: Record<string, () => string> = {\n    complaint: getComplaintTemplate,\n    handoff_to_human: getHandoffTemplate,\n  };\n\n  if (intentHandlers[ctx.intent]) {\n    return buildResponse(\n      intentHandlers[ctx.intent](),\n      ctx.intent,\n      ctx.conversationContext.conversationId,\n      ctx.mergedEntities,\n      ctx.contextManager,\n      ctx.knowledgeBase,\n      ctx.body.message,\n      ctx.corsHeaders,\n      ctx.nextState\n    );\n  }\n\n  // \u6C92\u6709\u5339\u914D\u7684\u7279\u6B8A\u610F\u5716\uFF0C\u7E7C\u7E8C\u6D41\u7A0B\n  return ctx;\n}\n\n", "/**\n * \u7BC0\u9EDE 7: FAQ \u6AA2\u67E5\n * \u7D71\u4E00 FAQ \u6AA2\u67E5\u8655\u7406\u548C\u83DC\u55AE\u9078\u64C7\u7684 FAQ \u5339\u914D\n */\n\nimport { PipelineContext } from '../lib/pipeline.js';\nimport { buildResponse, handleFAQIfNeeded } from '../chat.js';\n\n/**\n * FAQ \u6AA2\u67E5\u7BC0\u9EDE\n */\nexport async function node_faqCheck(ctx: PipelineContext): Promise<PipelineContext | Response> {\n  if (!ctx.intent) {\n    throw new Error('Intent not extracted');\n  }\n\n  if (!ctx.body) {\n    throw new Error('Request body not validated');\n  }\n\n  if (!ctx.knowledgeBase) {\n    throw new Error('KnowledgeBase not initialized');\n  }\n\n  if (!ctx.conversationContext) {\n    throw new Error('ConversationContext not initialized');\n  }\n\n  if (!ctx.mergedEntities) {\n    throw new Error('Merged entities not calculated');\n  }\n\n  if (!ctx.contextManager) {\n    throw new Error('ContextManager not initialized');\n  }\n\n  if (!ctx.nextState) {\n    throw new Error('Next state not determined');\n  }\n\n  // \u7D71\u4E00 FAQ \u6AA2\u67E5\u8655\u7406\uFF08\u6E1B\u5C11\u91CD\u8907\u4EE3\u78BC\uFF09\n  // \u6CE8\u610F\uFF1A\u5C0D\u65BC\u300C\u5982\u4F55\u9810\u7D04\u300D\u9019\u985E\u554F\u984C\uFF0C\u4E0D\u76F4\u63A5\u4F7F\u7528 FAQ\uFF0C\u800C\u662F\u8B93 LLM \u8655\u7406\u4EE5\u78BA\u4FDD\u63D0\u4F9B\u9810\u7D04\u9023\u7D50\n  // \u5C0D\u65BC\u300C\u50F9\u683C\u8A62\u554F\u300D\uFF0C\u53EA\u6709\u660E\u78BA\u554F\u653F\u7B56\u6642\u624D\u7528 FAQ\uFF0C\u4E00\u822C\u300C\u591A\u5C11\u9322\u300D\u76F4\u63A5\u56DE\u7B54\u50F9\u683C\n  const faqResponse = handleFAQIfNeeded(\n    ctx.intent,\n    ctx.body.message,\n    ctx.knowledgeBase,\n    ctx.conversationContext,\n    ctx.mergedEntities,\n    ctx.contextManager,\n    ctx.corsHeaders,\n    ctx.nextState\n  );\n  \n  if (faqResponse) {\n    return faqResponse;\n  }\n\n  // \u8655\u7406\u83DC\u55AE\u9078\u64C7\u7684\u6D88\u606F\uFF1A\u512A\u5148\u4F7F\u7528 FAQ \u5339\u914D\n  // \u7576 source === 'menu' \u6642\uFF0C\u512A\u5148\u4F7F\u7528 FAQ \u5339\u914D\uFF0C\u5339\u914D\u6210\u529F\u76F4\u63A5\u8FD4\u56DE\uFF0C\u4E0D\u8ABF\u7528 LLM\n  if (ctx.body.source === 'menu') {\n    console.log('[Chat] Menu source detected, prioritizing FAQ match');\n    const faqResults = ctx.knowledgeBase.searchFAQDetailed(ctx.body.message);\n    \n    if (faqResults && faqResults.length > 0) {\n      // \u627E\u5230\u5339\u914D\u7684 FAQ\uFF0C\u4F7F\u7528\u7D71\u4E00\u97FF\u61C9\u69CB\u5EFA\u51FD\u6578\n      const matchedFAQ = faqResults[0]; // \u53D6\u5206\u6578\u6700\u9AD8\u7684\n      console.log('[Chat] FAQ matched:', matchedFAQ.id, 'score:', matchedFAQ.score || 'N/A');\n      \n      // \u26A0\uFE0F \u91CD\u8981\uFF1A\u83DC\u55AE\u9078\u64C7\u5339\u914D\u5230 FAQ \u6642\uFF0C\u76F4\u63A5\u8FD4\u56DE\uFF0C\u4E0D\u8ABF\u7528 LLM\n      return buildResponse(\n        matchedFAQ.answer,\n        ctx.intent,\n        ctx.conversationContext.conversationId,\n        ctx.mergedEntities,\n        ctx.contextManager,\n        ctx.knowledgeBase,\n        ctx.body.message,\n        ctx.corsHeaders,\n        ctx.nextState\n      );\n    } else {\n      // \u26A0\uFE0F \u95DC\u9375\u4FEE\u6B63\uFF1A\u83DC\u55AE\u9078\u64C7\u7684 FAQ \u5339\u914D\u5931\u6557\u6642\uFF0C\u4E0D\u61C9\u8A72 fallback \u5230 LLM\n      // \u56E0\u70BA\u83DC\u55AE\u4E2D\u7684\u554F\u984C\u61C9\u8A72\u90FD\u6709\u5C0D\u61C9\u7684 FAQ \u7B54\u6848\n      // \u5982\u679C\u6C92\u6709\u5339\u914D\u5230\uFF0C\u53EF\u80FD\u662F\u554F\u984C\u8868\u8FF0\u4E0D\u5B8C\u5168\u4E00\u81F4\uFF0C\u5617\u8A66\u66F4\u5BEC\u9B06\u7684\u5339\u914D\n      console.log('[Chat] FAQ match failed for menu selection, message:', ctx.body.message);\n      console.log('[Chat] Attempting fuzzy match...');\n      \n      // \u5617\u8A66\u66F4\u5BEC\u9B06\u7684\u5339\u914D\uFF1A\u63D0\u53D6\u95DC\u9375\u5B57\n      const keywords = ctx.body.message.toLowerCase()\n        .replace(/\u6211\u60F3|\u6211\u8981|\u6211\u60F3\u77E5\u9053|\u8ACB\u554F|\u53EF\u4EE5|\u55CE|\u5462/g, '')\n        .trim();\n      \n      if (keywords) {\n        const fuzzyResults = ctx.knowledgeBase.searchFAQDetailed(keywords);\n        if (fuzzyResults && fuzzyResults.length > 0) {\n          const matchedFAQ = fuzzyResults[0];\n          console.log('[Chat] Fuzzy FAQ matched:', matchedFAQ.id);\n          return buildResponse(\n            matchedFAQ.answer,\n            ctx.intent,\n            ctx.conversationContext.conversationId,\n            ctx.mergedEntities,\n            ctx.contextManager,\n            ctx.knowledgeBase,\n            ctx.body.message,\n            ctx.corsHeaders,\n            ctx.nextState\n          );\n        }\n      }\n      \n      // \u5982\u679C\u9084\u662F\u6C92\u6709\u5339\u914D\u5230\uFF0C\u8FD4\u56DE\u53CB\u597D\u7684\u932F\u8AA4\u6D88\u606F\uFF0C\u800C\u4E0D\u662F fallback \u5230 LLM\n      console.warn('[Chat] No FAQ match found for menu selection, returning friendly message');\n      const friendlyMessage = `\u62B1\u6B49\uFF0C\u6211\u66AB\u6642\u627E\u4E0D\u5230\u9019\u500B\u554F\u984C\u7684\u7B54\u6848\u3002\u5EFA\u8B70\u60A8\uFF1A\\n\\n1. \u67E5\u770B\u6211\u5011\u7684 [\u5E38\u898B\u554F\u984C\u9801\u9762](/guide/faq/)\\n2. \u76F4\u63A5\u900F\u904E Email\uFF08goldenyears166@gmail.com\uFF09\u6216\u96FB\u8A71\u806F\u7D61\u6211\u5011\u7684\u771F\u4EBA\u5925\u4F34\\n3. \u6216\u91CD\u65B0\u9078\u64C7\u5176\u4ED6\u554F\u984C`;\n      \n      return buildResponse(\n        friendlyMessage,\n        ctx.intent,\n        ctx.conversationContext.conversationId,\n        ctx.mergedEntities,\n        ctx.contextManager,\n        ctx.knowledgeBase,\n        ctx.body.message,\n        ctx.corsHeaders,\n        ctx.nextState\n      );\n    }\n  }\n\n  // \u6C92\u6709\u5339\u914D\u7684 FAQ\uFF0C\u7E7C\u7E8C\u6D41\u7A0B\n  return ctx;\n}\n\n", "/**\n * \u7BC0\u9EDE 8: LLM \u751F\u6210\n * \u4F7F\u7528 LLM \u751F\u6210\u56DE\u8986\n * \n * \u26A0\uFE0F \u95DC\u9375\u4FEE\u6B63\u9EDE\uFF1A\n * 2. LLM \u4E0D\u53EF\u7528\u6642\u8FD4\u56DE 503 \u7279\u6B8A\u683C\u5F0F\uFF08\u7121 suggestedQuickReplies\uFF09\n * 3. \u8D85\u6642\u8655\u7406\u5FC5\u9808\u6E05\u7406 timeoutId\uFF08\u9632\u6B62\u5167\u5B58\u6CC4\u6F0F\uFF09\n */\n\nimport { PipelineContext } from '../lib/pipeline.js';\nimport { getApiErrorTemplate, getTimeoutTemplate } from '../lib/responseTemplates.js';\n\nconst TIMEOUT_MS = 10000; // 10 \u79D2\u8D85\u6642\n\n/**\n * LLM \u751F\u6210\u7BC0\u9EDE\n */\nexport async function node_llmGeneration(ctx: PipelineContext): Promise<PipelineContext | Response> {\n  if (!ctx.body) {\n    throw new Error('Request body not validated');\n  }\n\n  if (!ctx.intent) {\n    throw new Error('Intent not extracted');\n  }\n\n  if (!ctx.conversationContext) {\n    throw new Error('ConversationContext not initialized');\n  }\n\n  if (!ctx.mergedEntities) {\n    throw new Error('Merged entities not calculated');\n  }\n\n  if (!ctx.contextManager) {\n    throw new Error('ContextManager not initialized');\n  }\n\n  if (!ctx.knowledgeBase) {\n    throw new Error('KnowledgeBase not initialized');\n  }\n\n  // \u26A0\uFE0F \u95DC\u9375\u4FEE\u6B63 2: LLM \u4E0D\u53EF\u7528\u6642\u7684\u7279\u6B8A\u8655\u7406\n  // \u26A0\uFE0F \u91CD\u8981\uFF1A\u5982\u679C\u662F\u83DC\u55AE\u9078\u64C7\uFF0C\u4E0D\u61C9\u8A72\u5230\u9054\u9019\u88E1\uFF08\u61C9\u8A72\u5728 FAQ \u6AA2\u67E5\u7BC0\u9EDE\u5C31\u8FD4\u56DE\u4E86\uFF09\n  if (!ctx.llmService) {\n    // \u6AA2\u67E5\u662F\u5426\u662F\u83DC\u55AE\u9078\u64C7\uFF08\u4E0D\u61C9\u8A72\u5230\u9054\u9019\u88E1\uFF09\n    if (ctx.body?.source === 'menu') {\n      console.error('[Chat] ERROR: Menu selection reached LLM node without FAQ match!');\n      // \u5C0D\u65BC\u83DC\u55AE\u9078\u64C7\uFF0C\u8FD4\u56DE\u53CB\u597D\u7684\u932F\u8AA4\u6D88\u606F\u800C\u4E0D\u662F 503\n      const reply = '\u62B1\u6B49\uFF0C\u7CFB\u7D71\u66AB\u6642\u7121\u6CD5\u8655\u7406\u9019\u500B\u554F\u984C\u3002\u5EFA\u8B70\u60A8\u67E5\u770B\u6211\u5011\u7684\u5E38\u898B\u554F\u984C\u9801\u9762\uFF0C\u6216\u76F4\u63A5\u806F\u7D61\u6211\u5011\u7684\u771F\u4EBA\u5925\u4F34\u3002';\n      return new Response(\n        JSON.stringify({\n          reply,\n          intent: ctx.intent || 'handoff_to_human',\n          conversationId: ctx.conversationContext.conversationId,\n          updatedContext: {\n            last_intent: ctx.intent || 'handoff_to_human',\n            slots: ctx.mergedEntities,\n          },\n        }),\n        { \n          status: 200, // \u8FD4\u56DE 200 \u800C\u4E0D\u662F 503\uFF0C\u56E0\u70BA\u9019\u662F\u83DC\u55AE\u9078\u64C7\n          headers: { \n            ...ctx.corsHeaders, \n            'Content-Type': 'application/json' \n          } \n        }\n      );\n    }\n    \n    // \u975E\u83DC\u55AE\u9078\u64C7\u7684 LLM \u4E0D\u53EF\u7528\u8655\u7406\uFF08503 \u72C0\u614B\u78BC\uFF0C\u7121 suggestedQuickReplies\uFF09\n    const reply = getApiErrorTemplate();\n    return new Response(\n      JSON.stringify({\n        reply,\n        intent: 'handoff_to_human',\n        conversationId: ctx.conversationContext.conversationId,\n        updatedContext: {\n          last_intent: 'handoff_to_human',\n          slots: ctx.mergedEntities,\n        },\n        // \u26A0\uFE0F \u6CE8\u610F\uFF1A\u7121 suggestedQuickReplies \u6B04\u4F4D\n      }),\n      { \n        status: 503, \n        headers: { \n          ...ctx.corsHeaders, \n          'Content-Type': 'application/json' \n        } \n      }\n    );\n  }\n\n  // \u69CB\u5EFA LLM \u4E0A\u4E0B\u6587\n  const history = ctx.conversationContext.history.slice(-5).map(msg => ({\n    role: msg.role,\n    content: msg.text,\n  }));\n\n  const mode = ctx.body.mode || 'auto';\n\n  // \u4F7F\u7528 Promise.race \u5BE6\u73FE\u8D85\u6642\uFF08\u4FEE\u5FA9\u5167\u5B58\u6CC4\u6F0F\uFF09\n  const replyPromise = ctx.llmService.generateReply({\n    message: ctx.body.message,\n    intent: ctx.intent,\n    entities: ctx.mergedEntities,\n    context: {\n      last_intent: ctx.conversationContext.last_intent,\n      slots: ctx.mergedEntities,\n      history,\n    },\n    mode,\n    knowledgeBase: ctx.knowledgeBase, // \u50B3\u5165\u77E5\u8B58\u5EAB\u5BE6\u4F8B\uFF0C\u7528\u65BC\u7372\u53D6\u50F9\u683C\u8CC7\u8A0A\n  });\n\n  // \u26A0\uFE0F \u95DC\u9375\u4FEE\u6B63 3: \u8D85\u6642\u8655\u7406\u5FC5\u9808\u6E05\u7406 timeoutId\uFF08\u9632\u6B62\u5167\u5B58\u6CC4\u6F0F\uFF09\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n  const timeoutPromise = new Promise<string>((_, reject) => {\n    timeoutId = setTimeout(() => reject(new Error('Timeout')), TIMEOUT_MS);\n  });\n\n  let reply: string;\n  \n  try {\n    reply = await Promise.race([replyPromise, timeoutPromise]) as string;\n    \n    // \u6E05\u7406\u5B9A\u6642\u5668\uFF08\u5982\u679C\u9084\u5728\u904B\u884C\uFF09\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n      timeoutId = null;\n    }\n  } catch (error) {\n    // \u78BA\u4FDD\u6E05\u7406\u5B9A\u6642\u5668\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n      timeoutId = null;\n    }\n    \n    if (error instanceof Error && error.message === 'Timeout') {\n      reply = getTimeoutTemplate();\n    } else {\n      // \u26A0\uFE0F \u95DC\u9375\u4FEE\u6B63 4: \u975E\u8D85\u6642\u932F\u8AA4\u5FC5\u9808\u91CD\u65B0\u62CB\u51FA\n      throw error;\n    }\n  }\n\n  // \u5B58\u5165 context\n  ctx.reply = reply;\n\n  return ctx;\n}\n\n", "/**\n * \u7BC0\u9EDE 9: \u97FF\u61C9\u69CB\u5EFA\n * \u69CB\u5EFA\u6700\u7D42\u97FF\u61C9\n * \n * \u26A0\uFE0F \u95DC\u9375\u4FEE\u6B63\u9EDE\uFF1A\n * 6. \u97FF\u61C9\u6642\u9593\u65E5\u8A8C\u8A18\u9304\n */\n\nimport { PipelineContext } from '../lib/pipeline.js';\nimport { buildResponse } from '../chat.js';\n\n/**\n * \u97FF\u61C9\u69CB\u5EFA\u7BC0\u9EDE\n */\nexport async function node_buildResponse(ctx: PipelineContext): Promise<Response> {\n  if (!ctx.reply) {\n    throw new Error('Reply not generated');\n  }\n\n  if (!ctx.intent) {\n    throw new Error('Intent not extracted');\n  }\n\n  if (!ctx.conversationContext) {\n    throw new Error('ConversationContext not initialized');\n  }\n\n  if (!ctx.mergedEntities) {\n    throw new Error('Merged entities not calculated');\n  }\n\n  if (!ctx.contextManager) {\n    throw new Error('ContextManager not initialized');\n  }\n\n  if (!ctx.knowledgeBase) {\n    throw new Error('KnowledgeBase not initialized');\n  }\n\n  if (!ctx.body) {\n    throw new Error('Request body not validated');\n  }\n\n  if (!ctx.nextState) {\n    throw new Error('Next state not determined');\n  }\n\n  // \u26A0\uFE0F \u95DC\u9375\u4FEE\u6B63 6: \u97FF\u61C9\u6642\u9593\u65E5\u8A8C\u8A18\u9304\n  const responseTime = Date.now() - ctx.startTime;\n  console.log(`[Chat] ${ctx.intent} - ${responseTime}ms`);\n\n  // \u4F7F\u7528\u7D71\u4E00\u97FF\u61C9\u69CB\u5EFA\u51FD\u6578\u8655\u7406 LLM \u751F\u6210\u7684\u56DE\u8986\n  return buildResponse(\n    ctx.reply,\n    ctx.intent,\n    ctx.conversationContext.conversationId,\n    ctx.mergedEntities,\n    ctx.contextManager,\n    ctx.knowledgeBase,\n    ctx.body.message,\n    ctx.corsHeaders,\n    ctx.nextState\n  );\n}\n\n", "/**\n * \u7BC0\u9EDE 99: \u932F\u8AA4\u8655\u7406\n * \u5B8C\u5168\u5FA9\u73FE\u73FE\u6709\u7684\u5916\u5C64\u932F\u8AA4\u8655\u7406\u908F\u8F2F\n * \n * \u26A0\uFE0F \u95DC\u9375\u4FEE\u6B63\u9EDE 5: \u5FC5\u9808\u5B8C\u5168\u5FA9\u73FE\u73FE\u6709\u7684\u932F\u8AA4\u65E5\u8A8C\u548C\u7279\u6B8A\u8655\u7406\n */\n\nimport { PipelineContext } from '../lib/pipeline.js';\nimport { getApiErrorTemplate } from '../lib/responseTemplates.js';\n\n/**\n * \u932F\u8AA4\u8655\u7406\u7BC0\u9EDE\uFF08\u7528\u65BC\u5916\u5C64 catch\uFF09\n */\nexport function handlePipelineError(error: unknown, ctx: PipelineContext): Response {\n  // \u26A0\uFE0F \u95DC\u9375\u4FEE\u6B63 5: \u5B8C\u5168\u5FA9\u73FE\u73FE\u6709\u7684\u932F\u8AA4\u8655\u7406\u908F\u8F2F\uFF08\u5C0D\u61C9 chat.ts \u884C 794-832\uFF09\n  \n  // \u8A73\u7D30\u7684\u932F\u8AA4\u65E5\u8A8C\n  console.error('[Chat Error] ========== ERROR START ==========');\n  console.error('[Chat Error] Error type:', error instanceof Error ? error.constructor.name : typeof error);\n  console.error('[Chat Error] Error message:', error instanceof Error ? error.message : String(error));\n  \n  // \u4E0D\u8A18\u9304\u5B8C\u6574\u5806\u68E7\uFF0C\u907F\u514D\u6CC4\u9732\u5167\u90E8\u5BE6\u73FE\u7D30\u7BC0\n  if (error instanceof Error && error.stack) {\n    // \u53EA\u8A18\u9304\u5806\u68E7\u7684\u524D 200 \u500B\u5B57\u7B26\n    const stackPreview = error.stack.substring(0, 200);\n    console.error('[Chat Error] Error stack preview:', stackPreview);\n  }\n  \n  // \u6AA2\u67E5\u662F\u5426\u662F\u77E5\u8B58\u5EAB\u8F09\u5165\u932F\u8AA4\n  if (error instanceof Error && error.message.includes('Failed to load knowledge base')) {\n    console.error('[Chat Error] Knowledge base loading failed - this is likely the root cause');\n    console.error('[Chat Error] Please check:');\n    console.error('[Chat Error] 1. Knowledge files exist in _site/knowledge/ after build');\n    console.error('[Chat Error] 2. Knowledge files are accessible via HTTP');\n    console.error('[Chat Error] 3. Base URL is correctly constructed');\n  }\n  \n  // \u6AA2\u67E5\u662F\u5426\u662F LLM \u521D\u59CB\u5316\u932F\u8AA4\n  if (error instanceof Error && (error.message.includes('GEMINI_API_KEY') || error.message.includes('LLM'))) {\n    console.error('[Chat Error] LLM service initialization failed');\n    console.error('[Chat Error] Please check GEMINI_API_KEY environment variable in Cloudflare Pages');\n  }\n  \n  console.error('[Chat Error] ========== ERROR END ==========');\n  \n  // \u932F\u8AA4\u97FF\u61C9\uFF08\u683C\u5F0F\u5FC5\u9808\u5B8C\u5168\u4E00\u81F4\uFF09\n  return new Response(\n    JSON.stringify({\n      reply: getApiErrorTemplate(),\n      intent: 'handoff_to_human',\n      updatedContext: {\n        last_intent: 'handoff_to_human',\n        slots: {},\n      },\n    }),\n    { \n      status: 500, \n      headers: { \n        ...ctx.corsHeaders, \n        'Content-Type': 'application/json' \n      } \n    }\n  );\n}\n\n", "/**\n * Pipeline \u7BC0\u9EDE\u7D71\u4E00\u5C0E\u51FA\n */\n\nexport { node_validateRequest } from './01-validate-request.js';\nexport { node_initializeServices } from './02-initialize-services.js';\nexport { node_contextManagement } from './03-context-management.js';\nexport { node_intentExtraction } from './04-intent-extraction.js';\nexport { node_stateTransition } from './05-state-transition.js';\nexport { node_specialIntents } from './06-special-intents.js';\nexport { node_faqCheck } from './07-faq-check.js';\nexport { node_llmGeneration } from './08-llm-generation.js';\nexport { node_buildResponse } from './09-build-response.js';\nexport { handlePipelineError } from './99-error-handler.js';\n\n", "/**\n * Pipeline \u7248\u672C\u7684 onRequestPost\n * \u4F7F\u7528 Pipeline \u6A21\u5F0F\u91CD\u69CB\u7684\u4E3B\u6D41\u7A0B\n * \n * Pipeline \u57F7\u884C\u6D41\u7A0B\uFF1A\n * \n * \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n * \u2502               AI \u5BA2\u670D\u6A5F\u5668\u4EBA Pipeline                     \u2502\n * \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n * \n * [Request] \u2192 [1] \u2192 [2] \u2192 [3] \u2192 [4] \u2192 [5] \u2192 [6] \u2192 [7] \u2192 [8] \u2192 [9] \u2192 [Response]\n *             \u2502     \u2502     \u2502     \u2502     \u2502     \u2502     \u2502     \u2502     \u2502\n *            \u9A57\u8B49   \u521D\u59CB\u5316 \u4E0A\u4E0B\u6587 \u610F\u5716  \u72C0\u614B  \u7279\u6B8A   FAQ   LLM   \u69CB\u5EFA\n * \n * \u63D0\u524D\u9000\u51FA\u9EDE\uFF1A\n *   \u2022 \u7BC0\u9EDE 6 (specialIntents): \u7279\u6B8A\u610F\u5716\u5339\u914D\u6642\u63D0\u524D\u8FD4\u56DE\n *   \u2022 \u7BC0\u9EDE 7 (faqCheck): FAQ \u5339\u914D\u6642\u63D0\u524D\u8FD4\u56DE\n * \n * \u932F\u8AA4\u8655\u7406\uFF1A\n *   \u4EFB\u4F55\u7BC0\u9EDE\u932F\u8AA4 \u2192 [99. error-handler] \u2192 \u7D71\u4E00\u932F\u8AA4\u97FF\u61C9\n * \n * \u8996\u89BA\u5316\u512A\u52E2\uFF1A\n *   \u2022 \u6E05\u6670\u7684\u57F7\u884C\u6D41\u7A0B\u8FFD\u8E64\n *   \u2022 \u7D50\u69CB\u5316\u65E5\u8A8C\u8F38\u51FA\n *   \u2022 \u6027\u80FD\u74F6\u9838\u8B58\u5225\n *   \u2022 \u6613\u65BC\u8ABF\u8A66\u548C\u7DAD\u8B77\n */\n\nimport { Pipeline, PipelineContext } from './lib/pipeline.js';\nimport {\n  node_validateRequest,\n  node_initializeServices,\n  node_contextManagement,\n  node_intentExtraction,\n  node_stateTransition,\n  node_specialIntents,\n  node_faqCheck,\n  node_llmGeneration,\n  node_buildResponse,\n  handlePipelineError,\n} from './nodes/index.js';\n\n/**\n * Pipeline \u7248\u672C\u7684 onRequestPost\n */\nexport async function onRequestPostPipeline(context: {\n  request: Request;\n  env: any;\n  waitUntil: (promise: Promise<any>) => void;\n}): Promise<Response> {\n  const startTime = Date.now();\n\n  // \u5275\u5EFA Pipeline\n  const pipeline = new Pipeline({\n    enableDetailedLogging: true,\n    logLevel: 'INFO',\n  });\n\n  // \u8A3B\u518A\u6240\u6709\u7BC0\u9EDE\uFF08\u6309\u9806\u5E8F\uFF09\n  pipeline.addNode('validateRequest', node_validateRequest);\n  pipeline.addNode('initializeServices', node_initializeServices);\n  pipeline.addNode('contextManagement', node_contextManagement);\n  pipeline.addNode('intentExtraction', node_intentExtraction);\n  pipeline.addNode('stateTransition', node_stateTransition);\n  pipeline.addNode('specialIntents', node_specialIntents);\n  pipeline.addNode('faqCheck', node_faqCheck);\n  pipeline.addNode('llmGeneration', node_llmGeneration);\n  pipeline.addNode('buildResponse', node_buildResponse);\n\n  // \u521D\u59CB\u5316 PipelineContext\n  const pipelineContext: PipelineContext = {\n    request: context.request,\n    env: context.env,\n    corsHeaders: {},\n    startTime,\n    logs: [],\n  };\n\n  try {\n    // \u57F7\u884C Pipeline\n    return await pipeline.execute(pipelineContext);\n  } catch (error) {\n    // \u4F7F\u7528\u7D71\u4E00\u7684\u932F\u8AA4\u8655\u7406\n    return handlePipelineError(error, pipelineContext);\n  }\n}\n\n", "/**\n * Cloudflare Pages Function: /api/chat\n * \u8655\u7406 AI \u5BA2\u670D\u804A\u5929\u8ACB\u6C42\n */\n\nimport { LLMService } from './lib/llm.js';\nimport { KnowledgeBase } from './lib/knowledge.js';\nimport { ContextManager, ConversationContext } from './lib/contextManager.js';\nimport { \n  getDontUnderstandFirst, \n  getDontUnderstandSecond, \n  getApiErrorTemplate, \n  getTimeoutTemplate,\n  getComplaintTemplate,\n  getHandoffTemplate,\n  getLineInquiryTemplate,\n  setKnowledgeBase\n} from './lib/responseTemplates.js';\n\n// \u521D\u59CB\u5316\u670D\u52D9\uFF08\u55AE\u4F8B\u6A21\u5F0F\uFF09\nlet knowledgeBase: KnowledgeBase | null = null;\nlet llmService: LLMService | null = null;\nlet contextManager: ContextManager | null = null;\nlet knowledgeBaseLoading: Promise<KnowledgeBase> | null = null; // \u8F09\u5165\u4E2D\u7684 Promise\n\n// \u8F09\u5165\u77E5\u8B58\u5EAB\uFF08\u5EF6\u9072\u8F09\u5165\uFF09\n// \u26A0\uFE0F \u5C0E\u51FA\u4F9B Pipeline \u7BC0\u9EDE\u4F7F\u7528\nexport async function loadKnowledgeBase(request?: Request): Promise<KnowledgeBase> {\n  // \u5982\u679C\u77E5\u8B58\u5EAB\u5DF2\u5B58\u5728\u4E14\u5DF2\u8F09\u5165\uFF0C\u76F4\u63A5\u8FD4\u56DE\n  if (knowledgeBase && knowledgeBase.isLoaded()) {\n    return knowledgeBase;\n  }\n  \n  // \u5982\u679C\u6B63\u5728\u8F09\u5165\u4E2D\uFF0C\u7B49\u5F85\u8F09\u5165\u5B8C\u6210\n  if (knowledgeBaseLoading) {\n    console.log('[Chat] Knowledge base is loading, waiting...');\n    return await knowledgeBaseLoading;\n  }\n  \n  // \u5982\u679C\u77E5\u8B58\u5EAB\u5B58\u5728\u4F46\u672A\u8F09\u5165\uFF0C\u53EF\u80FD\u662F\u4E0A\u6B21\u8F09\u5165\u5931\u6557\uFF0C\u91CD\u65B0\u5275\u5EFA\u5BE6\u4F8B\n  if (knowledgeBase && !knowledgeBase.isLoaded()) {\n    console.log('[Chat] Knowledge base exists but not loaded, recreating...');\n    knowledgeBase = null;\n  }\n  \n  // \u5275\u5EFA\u8F09\u5165 Promise\uFF08\u9632\u6B62\u4E26\u767C\u8F09\u5165\uFF09\n  knowledgeBaseLoading = (async () => {\n    try {\n      // \u5982\u679C\u77E5\u8B58\u5EAB\u4E0D\u5B58\u5728\uFF0C\u5275\u5EFA\u65B0\u7684\u5BE6\u4F8B\n      if (!knowledgeBase) {\n        knowledgeBase = new KnowledgeBase();\n      }\n      \n      // \u5F9E request URL \u69CB\u5EFA\u57FA\u790E URL\n      let baseUrl: string | undefined;\n      if (request) {\n        const url = new URL(request.url);\n        baseUrl = `${url.protocol}//${url.host}`;\n      }\n      \n      // \u8F09\u5165\u77E5\u8B58\u5EAB\uFF08\u5982\u679C\u672A\u8F09\u5165\uFF09\n      if (!knowledgeBase.isLoaded()) {\n        await knowledgeBase.load(baseUrl);\n      }\n      \n      return knowledgeBase;\n    } catch (error) {\n      // \u8F09\u5165\u5931\u6557\u6642\uFF0C\u6E05\u9664\u5BE6\u4F8B\u548C\u8F09\u5165 Promise \u4EE5\u4FBF\u4E0B\u6B21\u91CD\u8A66\n      console.error('[Chat] Knowledge base loading failed, clearing instance:', error);\n      knowledgeBase = null;\n      knowledgeBaseLoading = null;\n      throw error;\n    } finally {\n      // \u8F09\u5165\u5B8C\u6210\u5F8C\u6E05\u9664\u8F09\u5165 Promise\n      knowledgeBaseLoading = null;\n    }\n  })();\n  \n  return await knowledgeBaseLoading;\n}\n\n// \u521D\u59CB\u5316 LLM \u670D\u52D9\n// \u26A0\uFE0F \u5C0E\u51FA\u4F9B Pipeline \u7BC0\u9EDE\u4F7F\u7528\nexport function initLLMService(env: any) {\n  if (!llmService) {\n    // \u5728 Cloudflare Pages Functions \u4E2D\uFF0C\u73AF\u5883\u53D8\u91CF\u901A\u8FC7 env \u53C2\u6570\u8BBF\u95EE\n    const apiKey = env?.GEMINI_API_KEY;\n    console.log('[Init LLM] Checking API key...');\n    console.log('[Init LLM] env object exists:', !!env);\n    console.log('[Init LLM] API Key exists:', !!apiKey);\n    // \u4E0D\u8A18\u9304 API Key \u9577\u5EA6\uFF0C\u907F\u514D\u6CC4\u9732\u4FE1\u606F\n    if (apiKey) {\n      // \u53EA\u8A18\u9304\u662F\u5426\u4EE5\u6B63\u78BA\u524D\u7DB4\u958B\u982D\uFF0C\u4E0D\u8A18\u9304\u4EFB\u4F55\u5BE6\u969B\u5B57\u7B26\n      console.log('[Init LLM] API Key format valid:', apiKey.startsWith('AIza'));\n      try {\n        llmService = new LLMService(apiKey);\n        console.log('[Init LLM] LLM service initialized successfully');\n      } catch (error) {\n        console.error('[Init LLM] Failed to initialize LLM service:', error);\n        throw error;\n      }\n    } else {\n      console.error('[Init LLM] GEMINI_API_KEY not found in env');\n      console.log('[Init LLM] Available env keys:', env ? Object.keys(env) : 'env is null/undefined');\n    }\n  }\n  return llmService;\n}\n\n// \u521D\u59CB\u5316 Context Manager\n// \u26A0\uFE0F \u5C0E\u51FA\u4F9B Pipeline \u7BC0\u9EDE\u4F7F\u7528\nexport function initContextManager() {\n  if (!contextManager) {\n    contextManager = new ContextManager();\n  }\n  return contextManager;\n}\n\n// \u4ECB\u9762\u5B9A\u7FA9\ninterface ChatRequestBody {\n  message: string;\n  source?: 'menu' | 'input';  // \u65B0\u589E\u5B57\u6BB5\uFF1A\u6D88\u606F\u6765\u6E90\uFF08\u83DC\u5355\u9009\u62E9\u6216\u624B\u52A8\u8F93\u5165\uFF09\n  mode?: 'auto' | 'decision_recommendation' | 'faq_flow_price';\n  pageType?: 'home' | 'qa';\n  conversationId?: string;\n  context?: {\n    last_intent?: string;\n    slots?: {\n      service_type?: string;\n      use_case?: string;\n      persona?: string;\n    };\n  };\n}\n\ninterface ChatResponse {\n  reply: string;\n  intent: string;\n  conversationId?: string;\n  updatedContext?: {\n    last_intent?: string;\n    slots?: {\n      service_type?: string;\n      use_case?: string;\n      persona?: string;\n      price_range?: string;\n      branch?: string;\n      booking_action?: string;\n    };\n  };\n  suggestedQuickReplies?: string[];\n}\n\n/**\n * \u7D71\u4E00\u97FF\u61C9\u69CB\u5EFA\u51FD\u6578\n * \u6E1B\u5C11\u91CD\u8907\u7684\u97FF\u61C9\u69CB\u5EFA\u4EE3\u78BC\uFF08\u6E1B\u5C11 ~35 \u500B\u689D\u4EF6\u5224\u65B7\uFF09\n */\nexport function buildResponse(\n  reply: string,\n  intent: string,\n  conversationId: string,\n  mergedEntities: Record<string, any>,\n  cm: ContextManager,\n  kb: KnowledgeBase,\n  userMessage: string,\n  corsHeaders: Record<string, string>,\n  nextState?: ConversationContext['state']\n): Response {\n  cm.updateContext(conversationId, {\n    last_intent: intent,\n    slots: mergedEntities,\n    userMessage,\n    assistantMessage: reply,\n    state: nextState,\n  });\n\n  const response: ChatResponse = {\n    reply,\n    intent,\n    conversationId,\n    updatedContext: {\n      last_intent: intent,\n      slots: mergedEntities,\n    },\n    suggestedQuickReplies: getSuggestedQuickReplies(intent, mergedEntities, nextState, kb),\n  };\n\n  return new Response(\n    JSON.stringify(response),\n    { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n  );\n}\n\n/**\n * FAQ \u8655\u7406\u898F\u5247\u914D\u7F6E\n */\ninterface FAQRule {\n  shouldCheckFAQ: (message: string) => boolean;\n  faqFilter?: (faq: any, message?: string) => boolean;\n  }\n\nconst faqHandlingRules: Record<string, FAQRule> = {\n  location_inquiry: {\n    shouldCheckFAQ: () => true,\n  },\n  price_inquiry: {\n    shouldCheckFAQ: (msg) => {\n      const lower = msg.toLowerCase();\n      return ['\u53EF\u4EE5\u8DDF\u6211\u8AAA\u5230', '\u8AAA\u5230\u591A\u7D30', '\u54EA\u4E9B\u4E00\u5B9A\u8981', '\u518D\u554F\u771F\u4EBA', '\u5831\u50F9\u7BC4\u570D']\n        .some(k => lower.includes(k));\n    },\n    faqFilter: (faq) => faq.critical && faq.id === 'policy_price_scope',\n  },\n  booking_inquiry: {\n    shouldCheckFAQ: (msg) => {\n      const lower = msg.toLowerCase();\n      return ['\u6539\u671F', '\u53D6\u6D88', 'reschedule', 'cancel'].some(k => lower.includes(k));\n    },\n    faqFilter: (faq, message) => {\n      if (!faq.critical) return false;\n      if (faq.id === 'policy_reschedule_cancel') return true;\n      if (message && faq.keywords && faq.keywords.some((k: string) => \n        message.toLowerCase().includes(k.toLowerCase())\n      )) return true;\n      return false;\n    },\n  },\n};\n\n/**\n * \u7D71\u4E00 FAQ \u6AA2\u67E5\u8655\u7406\u51FD\u6578\n * \u6E1B\u5C11\u91CD\u8907\u7684 FAQ \u6AA2\u67E5\u908F\u8F2F\uFF08\u6E1B\u5C11 ~12 \u500B\u689D\u4EF6\u5224\u65B7\uFF09\n */\nexport function handleFAQIfNeeded(\n  intent: string,\n  message: string,\n  kb: KnowledgeBase,\n  context_obj: ConversationContext,\n  mergedEntities: Record<string, any>,\n  cm: ContextManager,\n  corsHeaders: Record<string, string>,\n  nextState?: ConversationContext['state']\n): Response | null {\n  const rule = faqHandlingRules[intent];\n  if (!rule || !rule.shouldCheckFAQ(message)) {\n    return null; // \u4E0D\u9700\u8981\u6AA2\u67E5 FAQ\n  }\n  \n  const faqResults = kb.searchFAQ(message);\n  let criticalFAQ: any;\n  \n  if (rule.faqFilter) {\n    // \u5982\u679C\u6709\u81EA\u5B9A\u7FA9\u904E\u6FFE\u5668\uFF0C\u50B3\u5165 message \u53C3\u6578\uFF08\u5982\u679C\u904E\u6FFE\u5668\u9700\u8981\uFF09\n    criticalFAQ = faqResults.find((faq: any) => rule.faqFilter!(faq, message));\n  } else {\n    criticalFAQ = faqResults.find((faq: any) => faq.critical);\n  }\n  \n  if (criticalFAQ) {\n    return buildResponse(\n      criticalFAQ.answer,\n      intent,\n      context_obj.conversationId,\n      mergedEntities,\n      cm,\n      kb,\n      message,\n      corsHeaders,\n      nextState\n    );\n  }\n\n  return null; // FAQ \u672A\u5339\u914D\uFF0C\u7E7C\u7E8C LLM \u8655\u7406\n}\n\n/**\n * \u610F\u5716\u5206\u985E\uFF08\u914D\u7F6E\u9A45\u52D5\u7248\u672C\uFF09\n * \u4F7F\u7528 intent_config.json \u914D\u7F6E\u6587\u4EF6\uFF0C\u6E1B\u5C11\u786C\u7DE8\u78BC\uFF08\u6E1B\u5C11 ~12 \u500B\u689D\u4EF6\u5224\u65B7\uFF09\n */\nexport function classifyIntent(\n  message: string,\n  context?: { last_intent?: string; slots?: Record<string, any> },\n  knowledgeBase?: KnowledgeBase\n): string {\n  const lowerMessage = message.toLowerCase();\n\n  // \u5617\u8A66\u5F9E\u77E5\u8B58\u5EAB\u7372\u53D6\u914D\u7F6E\n  let intentConfig = null;\n  if (knowledgeBase) {\n    try {\n      intentConfig = knowledgeBase.getIntentConfig();\n    } catch (error) {\n      console.warn('[Chat] Failed to get intent config from knowledge base:', error);\n    }\n  }\n\n  // \u5982\u679C\u6C92\u6709\u914D\u7F6E\uFF0C\u4F7F\u7528 fallback \u908F\u8F2F\n  if (!intentConfig || !intentConfig.intents) {\n    // Fallback: \u4F7F\u7528\u4E0A\u6B21\u7684\u610F\u5716\uFF08\u5982\u679C\u4E0A\u4E0B\u6587\u5B58\u5728\u4E14\u8A0A\u606F\u5F88\u77ED\uFF09\n    if (context?.last_intent && lowerMessage.length < 10) {\n      return context.last_intent;\n    }\n    return 'service_inquiry'; // \u9810\u8A2D\u610F\u5716\n  }\n\n  // \u6309\u512A\u5148\u7D1A\u6392\u5E8F\u610F\u5716\u914D\u7F6E\n  const sortedIntents = [...intentConfig.intents].sort((a, b) => a.priority - b.priority);\n\n  // \u904D\u6B77\u914D\u7F6E\uFF0C\u627E\u5230\u5339\u914D\u7684\u610F\u5716\n  for (const intent of sortedIntents) {\n    // \u6AA2\u67E5\u95DC\u9375\u5B57\u5339\u914D\n    const hasKeyword = intent.keywords.some(keyword => lowerMessage.includes(keyword));\n\n    // \u6AA2\u67E5\u4E0A\u4E0B\u6587\u95DC\u9375\u5B57\u5339\u914D\n    const hasContextKeyword = intent.contextKeywords.length > 0 && \n      intent.contextKeywords.some(ctx => lowerMessage.includes(ctx));\n    \n    // \u6AA2\u67E5\u6392\u9664\u95DC\u9375\u5B57\n    const hasExcludeKeyword = intent.excludeKeywords.length > 0 &&\n      intent.excludeKeywords.some(exclude => lowerMessage.includes(exclude));\n\n    // \u7279\u6B8A\u689D\u4EF6\u6AA2\u67E5\uFF08\u4F8B\u5982\uFF1A\u77ED\u8A0A\u606F\uFF09\n    let matchesSpecialCondition = false;\n    if (intent.specialConditions) {\n      if (intent.specialConditions.shortMessage && \n          lowerMessage.length < (intent.specialConditions.shortMessageThreshold || 5)) {\n        matchesSpecialCondition = true;\n      }\n    }\n\n    // \u5982\u679C\u5339\u914D\u95DC\u9375\u5B57\u6216\u4E0A\u4E0B\u6587\u95DC\u9375\u5B57\uFF0C\u4E14\u6C92\u6709\u6392\u9664\u95DC\u9375\u5B57\uFF0C\u5247\u8FD4\u56DE\u8A72\u610F\u5716\n    if ((hasKeyword || hasContextKeyword || matchesSpecialCondition) && !hasExcludeKeyword) {\n      return intent.id;\n    }\n  }\n\n  // \u5982\u679C\u6C92\u6709\u5339\u914D\uFF0C\u4F7F\u7528 fallback \u908F\u8F2F\n  if (intentConfig.fallback.useContextIntent && \n      context?.last_intent && \n      lowerMessage.length < intentConfig.fallback.contextIntentThreshold) {\n    return context.last_intent;\n  }\n\n  return intentConfig.fallback.defaultIntent;\n}\n\n/**\n * \u7D71\u4E00\u5BE6\u9AD4\u63D0\u53D6\u51FD\u6578\uFF08\u914D\u7F6E\u9A45\u52D5\u7248\u672C\uFF09\n * \u4F7F\u7528 entity_patterns.json \u914D\u7F6E\u6587\u4EF6\uFF0C\u6E1B\u5C11\u786C\u7DE8\u78BC\uFF08\u6E1B\u5C11 ~15 \u500B\u689D\u4EF6\u5224\u65B7\uFF09\n */\nfunction extractEntityByPatterns(\n  message: string,\n  patterns: Array<{ keywords: string[]; id: string }>\n): string | undefined {\n  const lowerMessage = message.toLowerCase();\n  for (const pattern of patterns) {\n    if (pattern.keywords.some(keyword => lowerMessage.includes(keyword))) {\n      return pattern.id;\n    }\n  }\n  return undefined;\n}\n\n/**\n * \u5BE6\u9AD4\u63D0\u53D6\uFF08\u914D\u7F6E\u9A45\u52D5\u7248\u672C\uFF09\n */\nexport function extractEntities(\n  message: string,\n  knowledgeBase?: KnowledgeBase\n): Record<string, any> {\n  const lowerMessage = message.toLowerCase();\n  const entities: Record<string, any> = {};\n\n  // \u5617\u8A66\u5F9E\u77E5\u8B58\u5EAB\u7372\u53D6\u914D\u7F6E\n  let entityPatterns = null;\n  if (knowledgeBase) {\n    try {\n      entityPatterns = knowledgeBase.getEntityPatterns();\n    } catch (error) {\n      console.warn('[Chat] Failed to get entity patterns from knowledge base:', error);\n    }\n  }\n\n  // \u5982\u679C\u6C92\u6709\u914D\u7F6E\uFF0C\u4F7F\u7528 fallback \u908F\u8F2F\uFF08\u7C21\u55AE\u5339\u914D\uFF09\n  if (!entityPatterns || !entityPatterns.patterns) {\n    // Fallback: \u57FA\u672C\u7684\u5BE6\u9AD4\u63D0\u53D6\u908F\u8F2F\n    if (lowerMessage.includes('\u9810\u7D04') || lowerMessage.includes('book')) {\n      entities.booking_action = 'book';\n    }\n    return entities;\n    }\n\n  const patterns = entityPatterns.patterns;\n\n  // \u63D0\u53D6 service_type\uFF08\u4F7F\u7528\u7D71\u4E00\u51FD\u6578\uFF09\n  if (patterns.service_type) {\n    entities.service_type = extractEntityByPatterns(message, patterns.service_type);\n  }\n\n  // \u63D0\u53D6 use_case\n  if (patterns.use_case) {\n    entities.use_case = extractEntityByPatterns(message, patterns.use_case);\n  }\n\n  // \u63D0\u53D6 persona\n  if (patterns.persona) {\n    entities.persona = extractEntityByPatterns(message, patterns.persona);\n  }\n\n  // \u63D0\u53D6 branch\uFF08\u7279\u6B8A\u8655\u7406\uFF1A\u5C0D\u8C61\u7D50\u69CB\uFF09\n  if (patterns.branch) {\n    for (const [branchId, branchConfig] of Object.entries(patterns.branch)) {\n      if (branchConfig.keywords.some(keyword => lowerMessage.includes(keyword))) {\n        entities.branch = branchId;\n      break;\n    }\n  }\n  }\n\n  // \u63D0\u53D6 booking_action\uFF08\u7279\u6B8A\u8655\u7406\uFF1A\u5C0D\u8C61\u7D50\u69CB\uFF09\n  if (patterns.booking_action) {\n    for (const [actionId, actionConfig] of Object.entries(patterns.booking_action)) {\n      if (actionConfig.keywords.some(keyword => lowerMessage.includes(keyword))) {\n        entities.booking_action = actionId;\n        break;\n      }\n    }\n  }\n\n  return entities;\n}\n\n/**\n * \u53D6\u5F97\u5EFA\u8B70\u7684\u5FEB\u901F\u56DE\u8986\uFF08\u512A\u5316\u7248\uFF09\n * \u512A\u5148\u4F7F\u7528\u77E5\u8B58\u5EAB\uFF0C\u7C21\u5316 fallback \u908F\u8F2F\uFF08\u6E1B\u5C11 ~6 \u500B\u689D\u4EF6\u5224\u65B7\uFF09\n */\nfunction getSuggestedQuickReplies(\n  intent: string,\n  entities: Record<string, any>,\n  state?: string,\n  knowledgeBase?: any\n): string[] {\n  // \u512A\u5148\u7D1A 1: intent_nba_mapping\n  if (knowledgeBase) {\n    try {\n      const nbaActions = knowledgeBase.getNextBestActions(intent);\n      if (nbaActions && nbaActions.length > 0) {\n        return nbaActions;\n      }\n    } catch (error) {\n      console.error('[Chat] Failed to get next best actions from knowledge base:', error);\n    }\n\n    // \u512A\u5148\u7D1A 2: response_template\n    try {\n      const responseTemplate = knowledgeBase.getResponseTemplate(intent);\n      if (responseTemplate?.next_best_actions?.length > 0) {\n        return responseTemplate.next_best_actions;\n      }\n    } catch (error) {\n      console.error('[Chat] Failed to get response template from knowledge base:', error);\n    }\n  }\n\n  // \u7D71\u4E00\u7684 fallback\uFF08\u7C21\u5316\u908F\u8F2F\uFF09\n  return ['\u6211\u60F3\u4E86\u89E3\u66F4\u591A', '\u5982\u4F55\u9810\u7D04', '\u806F\u7D61\u771F\u4EBA'];\n}\n\n/**\n * Cloudflare Pages Function Handler\n * \n * \u26A0\uFE0F \u6CE8\u610F\uFF1A\u6B64\u51FD\u6578\u5DF2\u91CD\u69CB\u70BA\u4F7F\u7528 Pipeline \u6A21\u5F0F\n * \u4F7F\u7528\u52D5\u614B\u5C0E\u5165\u4EE5\u907F\u514D\u5FAA\u74B0\u4F9D\u8CF4\n */\nexport async function onRequestPost(context: {\n  request: Request;\n  env: any;\n  waitUntil: (promise: Promise<any>) => void;\n}): Promise<Response> {\n  // \u4F7F\u7528 Pipeline \u7248\u672C\uFF08\u52D5\u614B\u5C0E\u5165\u907F\u514D\u5FAA\u74B0\u4F9D\u8CF4\uFF09\n  const { onRequestPostPipeline } = await import('./chat-pipeline.js');\n  return onRequestPostPipeline(context);\n}\n\n/**\n * \u820A\u7248\u672C\u7684 onRequestPost\uFF08\u4F5C\u70BA\u5099\u4EFD\uFF09\n * \u4FDD\u7559\u7528\u65BC\u5C0D\u6BD4\u6E2C\u8A66\u548C\u56DE\u6EFE\n */\nasync function onRequestPost_legacy(context: {\n  request: Request;\n  env: any;\n  waitUntil: (promise: Promise<any>) => void;\n}): Promise<Response> {\n  const { request, env } = context;\n  const startTime = Date.now();\n  const TIMEOUT_MS = 10000; // 10 \u79D2\u8D85\u6642\n\n  // CORS headers - \u9650\u5236\u5141\u8A31\u7684\u4F86\u6E90\n  const allowedOrigins = [\n    'https://goldenyearsphoto.pages.dev',\n    'https://www.goldenyearsphoto.com',\n    'https://goldenyearsphoto.com',\n    // \u958B\u767C\u74B0\u5883\n    'http://localhost:8080',\n    'http://127.0.0.1:8080',\n  ];\n  \n  const origin = request.headers.get('Origin');\n  const allowedOrigin = origin && allowedOrigins.includes(origin) ? origin : allowedOrigins[0];\n  \n  const corsHeaders = {\n    'Access-Control-Allow-Origin': allowedOrigin,\n    'Access-Control-Allow-Methods': 'POST, OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'Access-Control-Max-Age': '86400', // 24 hours\n  };\n\n  // \u8655\u7406 OPTIONS \u8ACB\u6C42\n  if (request.method === 'OPTIONS') {\n    return new Response(null, { status: 204, headers: corsHeaders });\n  }\n\n  try {\n    // \u9A57\u8B49 Content-Type\n    const contentType = request.headers.get('content-type');\n    if (!contentType || !contentType.includes('application/json')) {\n      return new Response(\n        JSON.stringify({ error: 'Invalid Content-Type', message: '\u8ACB\u6C42\u5FC5\u9808\u4F7F\u7528 application/json' }),\n        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      );\n    }\n\n    // \u89E3\u6790\u8ACB\u6C42\u9AD4\uFF08\u6DFB\u52A0\u932F\u8AA4\u8655\u7406\uFF09\n    let body: ChatRequestBody;\n    try {\n      body = await request.json();\n    } catch (error) {\n      console.error('[Chat] Failed to parse request body:', error);\n      return new Response(\n        JSON.stringify({ error: 'Invalid JSON', message: '\u8ACB\u6C42\u9AD4\u5FC5\u9808\u662F\u6709\u6548\u7684 JSON \u683C\u5F0F' }),\n        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      );\n    }\n\n    // \u9A57\u8B49\u5FC5\u8981\u6B04\u4F4D\n    if (!body.message || typeof body.message !== 'string' || body.message.trim().length === 0) {\n      return new Response(\n        JSON.stringify({ error: 'Invalid request', message: 'message \u6B04\u4F4D\u70BA\u5FC5\u586B\u4E14\u4E0D\u80FD\u70BA\u7A7A' }),\n        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      );\n    }\n\n    // \u9A57\u8B49 message \u9577\u5EA6\n    if (body.message.length > 1000) {\n      return new Response(\n        JSON.stringify({ error: 'Invalid request', message: 'message \u9577\u5EA6\u4E0D\u80FD\u8D85\u904E 1000 \u5B57\u5143' }),\n        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      );\n    }\n\n    // \u9A57\u8B49 conversationId \u683C\u5F0F\uFF08\u5982\u679C\u63D0\u4F9B\uFF09\n    if (body.conversationId) {\n      if (typeof body.conversationId !== 'string' || \n          body.conversationId.length > 100 ||\n          !/^conv_[a-zA-Z0-9_]+$/.test(body.conversationId)) {\n        return new Response(\n          JSON.stringify({ error: 'Invalid request', message: 'conversationId \u683C\u5F0F\u4E0D\u6B63\u78BA' }),\n          { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n        );\n      }\n    }\n\n    // \u9A57\u8B49 mode \u503C\n    if (body.mode && !['auto', 'decision_recommendation', 'faq_flow_price'].includes(body.mode)) {\n      return new Response(\n        JSON.stringify({ error: 'Invalid request', message: 'mode \u503C\u4E0D\u6B63\u78BA' }),\n        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      );\n    }\n\n    // \u9A57\u8B49 source \u503C\n    if (body.source && !['menu', 'input'].includes(body.source)) {\n      return new Response(\n        JSON.stringify({ error: 'Invalid request', message: 'source \u503C\u4E0D\u6B63\u78BA' }),\n        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      );\n    }\n\n    // \u9A57\u8B49 pageType \u503C\n    if (body.pageType && !['home', 'qa'].includes(body.pageType)) {\n      return new Response(\n        JSON.stringify({ error: 'Invalid request', message: 'pageType \u503C\u4E0D\u6B63\u78BA' }),\n        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      );\n    }\n\n    // \u8F09\u5165\u77E5\u8B58\u5EAB\n    console.log('[Chat] Loading knowledge base...');\n    // \u4E0D\u8A18\u9304\u5B8C\u6574 URL\uFF0C\u907F\u514D\u6CC4\u9732\u654F\u611F\u4FE1\u606F\n    const url = new URL(request.url);\n    console.log('[Chat] Request host:', url.host);\n    let kb;\n    try {\n      kb = await loadKnowledgeBase(request);\n      console.log('[Chat] Knowledge base loaded successfully');\n    } catch (error) {\n      console.error('[Chat] Failed to load knowledge base:', error);\n      console.error('[Chat] Error details:', error instanceof Error ? {\n        message: error.message,\n        stack: error.stack?.substring(0, 500) // \u9650\u5236 stack \u9577\u5EA6\n      } : String(error));\n      // \u91CD\u65B0\u62CB\u51FA\u932F\u8AA4\uFF0C\u8B93\u4E0A\u5C64 catch \u8655\u7406\n      throw error;\n    }\n    \n    // \u8A2D\u7F6E responseTemplates \u7684 knowledgeBase \u5BE6\u4F8B\n    setKnowledgeBase(kb);\n\n    // \u521D\u59CB\u5316\u670D\u52D9\n    console.log('[Chat] Initializing services...');\n    const llm = initLLMService(env);\n    const cm = initContextManager();\n    console.log('[Chat] Services initialized. LLM available:', !!llm);\n\n    const mode = body.mode || 'auto';\n\n    // \u53D6\u5F97\u6216\u5EFA\u7ACB\u4E0A\u4E0B\u6587\n    let context_obj: ConversationContext;\n    if (body.conversationId) {\n      const existingContext = cm.getContext(body.conversationId);\n      if (existingContext) {\n        context_obj = existingContext;\n      } else {\n        context_obj = cm.createContext(body.conversationId);\n      }\n    } else {\n      context_obj = cm.createContext();\n    }\n\n    // \u610F\u5716\u5206\u985E\uFF08\u4F7F\u7528\u914D\u7F6E\u9A45\u52D5\uFF09\n    const intent = classifyIntent(body.message, {\n      last_intent: context_obj.last_intent,\n      slots: context_obj.slots,\n    }, kb);\n\n    // \u5BE6\u9AD4\u63D0\u53D6\uFF08\u4F7F\u7528\u914D\u7F6E\u9A45\u52D5\uFF09\n    const entities = extractEntities(body.message, kb);\n\n    // \u5408\u4F75\u4E0A\u4E0B\u6587\u4E2D\u7684\u5BE6\u9AD4\n    const mergedEntities = {\n      ...context_obj.slots,\n      ...entities,\n    };\n\n    // \u6C7A\u5B9A\u4E0B\u4E00\u500B\u72C0\u614B\uFF08\u4F7F\u7528\u914D\u7F6E\u9A45\u52D5\uFF09\n    let nextState: ConversationContext['state'] = context_obj.state;\n    try {\n      const stateTransitionsConfig = kb.getStateTransitionsConfig();\n      if (stateTransitionsConfig) {\n        // \u6AA2\u67E5\u662F\u5426\u6709\u5FC5\u9700\u7684 slots\uFF08\u4F7F\u7528\u914D\u7F6E\u4E2D\u7684\u898F\u5247\uFF09\n        const requiredSlotsCheck = stateTransitionsConfig.requiredSlotsCheck;\n        let hasRequiredSlots = false;\n        if (requiredSlotsCheck) {\n          if (requiredSlotsCheck.requireAny) {\n            // \u9700\u8981\u4EFB\u610F\u4E00\u500B\u5B57\u6BB5\n            hasRequiredSlots = requiredSlotsCheck.fields.some(field => mergedEntities[field]);\n          } else {\n            // \u9700\u8981\u6240\u6709\u5B57\u6BB5\n            hasRequiredSlots = requiredSlotsCheck.fields.every(field => mergedEntities[field]);\n          }\n        } else {\n          // \u9ED8\u8A8D\u908F\u8F2F\uFF1A\u81F3\u5C11\u9700\u8981 service_type \u6216 use_case\n          hasRequiredSlots = !!(mergedEntities.service_type || mergedEntities.use_case);\n        }\n\n        nextState = cm.determineNextState(\n          context_obj.state,\n        intent,\n          hasRequiredSlots,\n          {\n            transitions: stateTransitionsConfig.transitions,\n            requiredSlotsCheck: stateTransitionsConfig.requiredSlotsCheck,\n          }\n        );\n      } else {\n        // \u5982\u679C\u6C92\u6709\u914D\u7F6E\uFF0C\u4F7F\u7528 fallback \u908F\u8F2F\n        const hasRequiredSlots = !!(mergedEntities.service_type || mergedEntities.use_case);\n        nextState = cm.determineNextState(context_obj.state, intent, hasRequiredSlots);\n    }\n    } catch (error) {\n      console.warn('[Chat] Failed to determine next state, using current state:', error);\n      // \u4F7F\u7528\u7576\u524D\u72C0\u614B\u4F5C\u70BA fallback\n    }\n\n    // \u6AA2\u67E5 Line \u5B98\u65B9\u5E33\u865F\u8A62\u554F\uFF08\u4F7F\u7528\u7D71\u4E00\u97FF\u61C9\u69CB\u5EFA\u51FD\u6578\uFF09\n    if (body.message.includes('line') || body.message.includes('Line') || body.message.includes('LINE')) {\n      return buildResponse(\n        getLineInquiryTemplate(),\n        intent,\n        context_obj.conversationId,\n        mergedEntities,\n        cm,\n        kb,\n        body.message,\n        corsHeaders,\n        nextState\n      );\n    }\n\n    // \u610F\u5716\u8655\u7406\u5668\u6620\u5C04\u8868\uFF08\u4F7F\u7528\u7D71\u4E00\u97FF\u61C9\u69CB\u5EFA\u51FD\u6578\uFF09\n    const intentHandlers: Record<string, () => string> = {\n      complaint: getComplaintTemplate,\n      handoff_to_human: getHandoffTemplate,\n    };\n\n    if (intentHandlers[intent]) {\n      return buildResponse(\n        intentHandlers[intent](),\n        intent,\n        context_obj.conversationId,\n        mergedEntities,\n        cm,\n        kb,\n        body.message,\n        corsHeaders,\n        nextState\n      );\n    }\n\n    // \u7D71\u4E00 FAQ \u6AA2\u67E5\u8655\u7406\uFF08\u6E1B\u5C11\u91CD\u8907\u4EE3\u78BC\uFF09\n    // \u6CE8\u610F\uFF1A\u5C0D\u65BC\u300C\u5982\u4F55\u9810\u7D04\u300D\u9019\u985E\u554F\u984C\uFF0C\u4E0D\u76F4\u63A5\u4F7F\u7528 FAQ\uFF0C\u800C\u662F\u8B93 LLM \u8655\u7406\u4EE5\u78BA\u4FDD\u63D0\u4F9B\u9810\u7D04\u9023\u7D50\n    // \u5C0D\u65BC\u300C\u50F9\u683C\u8A62\u554F\u300D\uFF0C\u53EA\u6709\u660E\u78BA\u554F\u653F\u7B56\u6642\u624D\u7528 FAQ\uFF0C\u4E00\u822C\u300C\u591A\u5C11\u9322\u300D\u76F4\u63A5\u56DE\u7B54\u50F9\u683C\n    const faqResponse = handleFAQIfNeeded(\n          intent,\n      body.message,\n      kb,\n      context_obj,\n      mergedEntities,\n      cm,\n      corsHeaders,\n      nextState\n    );\n    if (faqResponse) {\n      return faqResponse;\n    }\n\n    // \u8655\u7406\u83DC\u55AE\u9078\u64C7\u7684\u6D88\u606F\uFF1A\u512A\u5148\u4F7F\u7528 FAQ \u5339\u914D\n    // \u7576 source === 'menu' \u6642\uFF0C\u512A\u5148\u4F7F\u7528 FAQ \u5339\u914D\uFF0C\u5339\u914D\u6210\u529F\u76F4\u63A5\u8FD4\u56DE\uFF0C\u4E0D\u8ABF\u7528 LLM\n    if (body.source === 'menu') {\n      console.log('[Chat] Menu source detected, prioritizing FAQ match');\n      const faqResults = kb.searchFAQDetailed(body.message);\n      \n      if (faqResults && faqResults.length > 0) {\n        // \u627E\u5230\u5339\u914D\u7684 FAQ\uFF0C\u4F7F\u7528\u7D71\u4E00\u97FF\u61C9\u69CB\u5EFA\u51FD\u6578\n        const matchedFAQ = faqResults[0]; // \u53D6\u5206\u6578\u6700\u9AD8\u7684\n        console.log('[Chat] FAQ matched:', matchedFAQ.id);\n        \n        return buildResponse(\n          matchedFAQ.answer,\n          intent,\n          context_obj.conversationId,\n          mergedEntities,\n          cm,\n          kb,\n          body.message,\n          corsHeaders,\n          nextState\n        );\n      } else {\n        // FAQ \u5339\u914D\u5931\u6557\uFF0C\u7E7C\u7E8C\u4F7F\u7528 LLM \u8655\u7406\uFF08\u4F5C\u70BA fallback\uFF09\n        console.log('[Chat] FAQ match failed, falling back to LLM');\n      }\n    }\n\n    // \u4F7F\u7528 LLM \u751F\u6210\u56DE\u8986\n    if (!llm) {\n      // LLM \u670D\u52D9\u4E0D\u53EF\u7528\u6642\u7684\u7279\u6B8A\u8655\u7406\uFF08503 \u72C0\u614B\u78BC\uFF0C\u7121 suggestedQuickReplies\uFF09\n      const reply = getApiErrorTemplate();\n      return new Response(\n        JSON.stringify({\n        reply,\n        intent: 'handoff_to_human',\n        conversationId: context_obj.conversationId,\n        updatedContext: {\n          last_intent: 'handoff_to_human',\n          slots: mergedEntities,\n        },\n        }),\n        { status: 503, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      );\n    }\n\n    // \u69CB\u5EFA LLM \u4E0A\u4E0B\u6587\n    const history = context_obj.history.slice(-5).map(msg => ({\n      role: msg.role,\n      content: msg.text,\n    }));\n\n    // \u4F7F\u7528 Promise.race \u5BE6\u73FE\u8D85\u6642\uFF08\u4FEE\u5FA9\u5167\u5B58\u6CC4\u6F0F\uFF09\n    const replyPromise = llm.generateReply({\n      message: body.message,\n      intent,\n      entities: mergedEntities,\n      context: {\n        last_intent: context_obj.last_intent,\n        slots: mergedEntities,\n        history,\n      },\n      mode,\n      knowledgeBase: kb, // \u50B3\u5165\u77E5\u8B58\u5EAB\u5BE6\u4F8B\uFF0C\u7528\u65BC\u7372\u53D6\u50F9\u683C\u8CC7\u8A0A\n    });\n\n    let timeoutId: ReturnType<typeof setTimeout> | null = null;\n    const timeoutPromise = new Promise<string>((_, reject) => {\n      timeoutId = setTimeout(() => reject(new Error('Timeout')), TIMEOUT_MS);\n    });\n\n    let reply: string;\n    try {\n      reply = await Promise.race([replyPromise, timeoutPromise]) as string;\n      // \u6E05\u7406\u5B9A\u6642\u5668\uFF08\u5982\u679C\u9084\u5728\u904B\u884C\uFF09\n      if (timeoutId) {\n        clearTimeout(timeoutId);\n        timeoutId = null;\n      }\n    } catch (error) {\n      // \u78BA\u4FDD\u6E05\u7406\u5B9A\u6642\u5668\n      if (timeoutId) {\n        clearTimeout(timeoutId);\n        timeoutId = null;\n      }\n      if (error instanceof Error && error.message === 'Timeout') {\n        reply = getTimeoutTemplate();\n      } else {\n        throw error;\n      }\n    }\n\n    // \u4F7F\u7528\u7D71\u4E00\u97FF\u61C9\u69CB\u5EFA\u51FD\u6578\u8655\u7406 LLM \u751F\u6210\u7684\u56DE\u8986\n    const responseTime = Date.now() - startTime;\n    console.log(`[Chat] ${intent} - ${responseTime}ms`);\n\n    return buildResponse(\n      reply,\n      intent,\n      context_obj.conversationId,\n      mergedEntities,\n      cm,\n      kb,\n      body.message,\n      corsHeaders,\n      nextState\n    );\n\n  } catch (error) {\n    // \u8A73\u7D30\u7684\u932F\u8AA4\u65E5\u8A8C\n    console.error('[Chat Error] ========== ERROR START ==========');\n    console.error('[Chat Error] Error type:', error instanceof Error ? error.constructor.name : typeof error);\n    console.error('[Chat Error] Error message:', error instanceof Error ? error.message : String(error));\n    // \u4E0D\u8A18\u9304\u5B8C\u6574\u5806\u68E7\uFF0C\u907F\u514D\u6CC4\u9732\u5167\u90E8\u5BE6\u73FE\u7D30\u7BC0\n    if (error instanceof Error && error.stack) {\n      // \u53EA\u8A18\u9304\u5806\u68E7\u7684\u524D 200 \u500B\u5B57\u7B26\n      const stackPreview = error.stack.substring(0, 200);\n      console.error('[Chat Error] Error stack preview:', stackPreview);\n    }\n    \n    // \u6AA2\u67E5\u662F\u5426\u662F\u77E5\u8B58\u5EAB\u8F09\u5165\u932F\u8AA4\n    if (error instanceof Error && error.message.includes('Failed to load knowledge base')) {\n      console.error('[Chat Error] Knowledge base loading failed - this is likely the root cause');\n      console.error('[Chat Error] Please check:');\n      console.error('[Chat Error] 1. Knowledge files exist in _site/knowledge/ after build');\n      console.error('[Chat Error] 2. Knowledge files are accessible via HTTP');\n      console.error('[Chat Error] 3. Base URL is correctly constructed');\n    }\n    \n    // \u6AA2\u67E5\u662F\u5426\u662F LLM \u521D\u59CB\u5316\u932F\u8AA4\n    if (error instanceof Error && (error.message.includes('GEMINI_API_KEY') || error.message.includes('LLM'))) {\n      console.error('[Chat Error] LLM service initialization failed');\n      console.error('[Chat Error] Please check GEMINI_API_KEY environment variable in Cloudflare Pages');\n    }\n    \n    console.error('[Chat Error] ========== ERROR END ==========');\n    \n    const response: ChatResponse = {\n      reply: getApiErrorTemplate(),\n      intent: 'handoff_to_human',\n      updatedContext: {\n        last_intent: 'handoff_to_human',\n        slots: {},\n      },\n    };\n\n    return new Response(\n      JSON.stringify(response),\n      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n    );\n  }\n}\n\n", "/**\n * Cloudflare Pages Function: /api/faq-menu\n * \u8FD4\u56DE FAQ \u83DC\u5355\u7ED3\u6784\u4F9B\u524D\u7AEF\u4F7F\u7528\n */\n\nimport { KnowledgeBase } from './lib/knowledge.js';\n\n// \u521D\u59CB\u5316\u77E5\u8B58\u5EAB\uFF08\u55AE\u4F8B\u6A21\u5F0F\uFF09\nlet knowledgeBase: KnowledgeBase | null = null;\nlet knowledgeBaseLoading: Promise<KnowledgeBase> | null = null; // \u8F09\u5165\u4E2D\u7684 Promise\n\n// \u8F09\u5165\u77E5\u8B58\u5EAB\uFF08\u5EF6\u9072\u8F09\u5165\uFF09\nasync function loadKnowledgeBase(request?: Request): Promise<KnowledgeBase> {\n  // \u5982\u679C\u77E5\u8B58\u5EAB\u5DF2\u5B58\u5728\u4E14\u5DF2\u8F09\u5165\uFF0C\u76F4\u63A5\u8FD4\u56DE\n  if (knowledgeBase && knowledgeBase.isLoaded()) {\n    return knowledgeBase;\n  }\n  \n  // \u5982\u679C\u6B63\u5728\u8F09\u5165\u4E2D\uFF0C\u7B49\u5F85\u8F09\u5165\u5B8C\u6210\n  if (knowledgeBaseLoading) {\n    console.log('[FAQ Menu] Knowledge base is loading, waiting...');\n    return await knowledgeBaseLoading;\n  }\n  \n  // \u5982\u679C\u77E5\u8B58\u5EAB\u5B58\u5728\u4F46\u672A\u8F09\u5165\uFF0C\u53EF\u80FD\u662F\u4E0A\u6B21\u8F09\u5165\u5931\u6557\uFF0C\u91CD\u65B0\u5275\u5EFA\u5BE6\u4F8B\n  if (knowledgeBase && !knowledgeBase.isLoaded()) {\n    console.log('[FAQ Menu] Knowledge base exists but not loaded, recreating...');\n    knowledgeBase = null;\n  }\n  \n  // \u5275\u5EFA\u8F09\u5165 Promise\uFF08\u9632\u6B62\u4E26\u767C\u8F09\u5165\uFF09\n  knowledgeBaseLoading = (async () => {\n    try {\n      // \u5982\u679C\u77E5\u8B58\u5EAB\u4E0D\u5B58\u5728\uFF0C\u5275\u5EFA\u65B0\u7684\u5BE6\u4F8B\n      if (!knowledgeBase) {\n        knowledgeBase = new KnowledgeBase();\n      }\n      \n      // \u5F9E request URL \u69CB\u5EFA\u57FA\u790E URL\n      let baseUrl: string | undefined;\n      if (request) {\n        const url = new URL(request.url);\n        baseUrl = `${url.protocol}//${url.host}`;\n      }\n      \n      // \u8F09\u5165\u77E5\u8B58\u5EAB\uFF08\u5982\u679C\u672A\u8F09\u5165\uFF09\n      if (!knowledgeBase.isLoaded()) {\n        await knowledgeBase.load(baseUrl);\n      }\n      \n      return knowledgeBase;\n    } catch (error) {\n      // \u8F09\u5165\u5931\u6557\u6642\uFF0C\u6E05\u9664\u5BE6\u4F8B\u548C\u8F09\u5165 Promise \u4EE5\u4FBF\u4E0B\u6B21\u91CD\u8A66\n      console.error('[FAQ Menu] Knowledge base loading failed, clearing instance:', error);\n      knowledgeBase = null;\n      knowledgeBaseLoading = null;\n      throw error;\n    } finally {\n      // \u8F09\u5165\u5B8C\u6210\u5F8C\u6E05\u9664\u8F09\u5165 Promise\n      knowledgeBaseLoading = null;\n    }\n  })();\n  \n  return await knowledgeBaseLoading;\n}\n\n/**\n * Cloudflare Pages Function Handler\n */\nexport async function onRequestGet(context: {\n  request: Request;\n  env: any;\n}): Promise<Response> {\n  const { request } = context;\n\n  // CORS headers\n  const corsHeaders = {\n    'Access-Control-Allow-Origin': request.headers.get('Origin') || '*',\n    'Access-Control-Allow-Methods': 'GET, OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n  };\n\n  // \u8655\u7406 OPTIONS \u8ACB\u6C42\n  if (request.method === 'OPTIONS') {\n    return new Response(null, { status: 204, headers: corsHeaders });\n  }\n\n  try {\n    // \u8F09\u5165\u77E5\u8B58\u5EAB\n    console.log('[FAQ Menu] Loading knowledge base...');\n    const kb = await loadKnowledgeBase(request);\n    console.log('[FAQ Menu] Knowledge base loaded successfully');\n\n    // \u53D6\u5F97 FAQ \u8A73\u7D30\u8CC7\u6599\n    const faqDetailed = kb.getFAQDetailed();\n    if (!faqDetailed) {\n      return new Response(\n        JSON.stringify({ error: 'FAQ data not available' }),\n        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      );\n    }\n\n    // \u69CB\u5EFA\u83DC\u55AE\u7D50\u69CB\n    const categories = Object.entries(faqDetailed.categories)\n      .map(([categoryId, category]) => {\n        if (!category || !category.questions) {\n          return null;\n        }\n\n        // \u6BCF\u500B\u5206\u985E\u6700\u591A\u8FD4\u56DE 8 \u500B\u5E38\u898B\u554F\u984C\n        const questions = category.questions\n          .slice(0, 8)\n          .map(q => ({\n            id: q.id,\n            question: q.question,\n          }));\n\n        return {\n          id: categoryId,\n          title: category.title,\n          questions: questions,\n        };\n      })\n      .filter(cat => cat !== null); // \u904E\u6FFE\u6389 null \u503C\n\n    const response = {\n      categories: categories,\n    };\n\n    return new Response(\n      JSON.stringify(response),\n      { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n    );\n\n  } catch (error) {\n    console.error('[FAQ Menu Error]', error);\n    console.error('[FAQ Menu Error] Error details:', error instanceof Error ? {\n      message: error.message,\n      stack: error.stack?.substring(0, 500)\n    } : String(error));\n    \n    return new Response(\n      JSON.stringify({ \n        error: 'Failed to load FAQ menu',\n        details: error instanceof Error ? error.message : String(error)\n      }),\n      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n    );\n  }\n}\n\n", "import { onRequestPost as __api_chat_ts_onRequestPost } from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/functions/api/chat.ts\"\nimport { onRequestGet as __api_faq_menu_ts_onRequestGet } from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/functions/api/faq-menu.ts\"\n\nexport const routes = [\n    {\n      routePath: \"/api/chat\",\n      mountPath: \"/api\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_chat_ts_onRequestPost],\n    },\n  {\n      routePath: \"/api/faq-menu\",\n      mountPath: \"/api\",\n      method: \"GET\",\n      middlewares: [],\n      modules: [__api_faq_menu_ts_onRequestGet],\n    },\n  ]", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/.wrangler/tmp/bundle-Ryusmq/middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/node_modules/wrangler/templates/middleware/common.ts\";\nimport type { WorkerEntrypointConstructor } from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/.wrangler/tmp/bundle-Ryusmq/middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/.wrangler/tmp/bundle-Ryusmq/middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/node_modules/wrangler/templates/pages-template-worker.ts\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"/Users/jackm4/Documents/GitHub/goldenyearsphoto/node_modules/wrangler/templates/pages-template-worker.ts\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "import { match } from \"path-to-regexp\";\n\n//note: this explicitly does not include the * character, as pages requires this\nconst escapeRegex = /[.+?^${}()|[\\]\\\\]/g;\n\ntype HTTPMethod =\n\t| \"HEAD\"\n\t| \"OPTIONS\"\n\t| \"GET\"\n\t| \"POST\"\n\t| \"PUT\"\n\t| \"PATCH\"\n\t| \"DELETE\";\n\n/* TODO: Grab these from @cloudflare/workers-types instead */\ntype Params<P extends string = string> = Record<P, string | string[]>;\n\ntype EventContext<Env, P extends string, Data> = {\n\trequest: Request;\n\tfunctionPath: string;\n\twaitUntil: (promise: Promise<unknown>) => void;\n\tpassThroughOnException: () => void;\n\tnext: (input?: Request | string, init?: RequestInit) => Promise<Response>;\n\tenv: Env & { ASSETS: { fetch: typeof fetch } };\n\tparams: Params<P>;\n\tdata: Data;\n};\n\ndeclare type PagesFunction<\n\tEnv = unknown,\n\tP extends string = string,\n\tData extends Record<string, unknown> = Record<string, unknown>,\n> = (context: EventContext<Env, P, Data>) => Response | Promise<Response>;\n/* end @cloudflare/workers-types */\n\ntype RouteHandler = {\n\troutePath: string;\n\tmountPath: string;\n\tmethod?: HTTPMethod;\n\tmodules: PagesFunction[];\n\tmiddlewares: PagesFunction[];\n};\n\n// inject `routes` via ESBuild\ndeclare const routes: RouteHandler[];\n// define `__FALLBACK_SERVICE__` via ESBuild\ndeclare const __FALLBACK_SERVICE__: string;\n\n// expect an ASSETS fetcher binding pointing to the asset-server stage\ntype FetchEnv = {\n\t[name: string]: { fetch: typeof fetch };\n\tASSETS: { fetch: typeof fetch };\n};\n\ntype WorkerContext = {\n\twaitUntil: (promise: Promise<unknown>) => void;\n\tpassThroughOnException: () => void;\n};\n\nfunction* executeRequest(request: Request) {\n\tconst requestPath = new URL(request.url).pathname;\n\n\t// First, iterate through the routes (backwards) and execute \"middlewares\" on partial route matches\n\tfor (const route of [...routes].reverse()) {\n\t\tif (route.method && route.method !== request.method) {\n\t\t\tcontinue;\n\t\t}\n\n\t\t// replaces with \"\\\\$&\", this prepends a backslash to the matched string, e.g. \"[\" becomes \"\\[\"\n\t\tconst routeMatcher = match(route.routePath.replace(escapeRegex, \"\\\\$&\"), {\n\t\t\tend: false,\n\t\t});\n\t\tconst mountMatcher = match(route.mountPath.replace(escapeRegex, \"\\\\$&\"), {\n\t\t\tend: false,\n\t\t});\n\t\tconst matchResult = routeMatcher(requestPath);\n\t\tconst mountMatchResult = mountMatcher(requestPath);\n\t\tif (matchResult && mountMatchResult) {\n\t\t\tfor (const handler of route.middlewares.flat()) {\n\t\t\t\tyield {\n\t\t\t\t\thandler,\n\t\t\t\t\tparams: matchResult.params as Params,\n\t\t\t\t\tpath: mountMatchResult.path,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n\n\t// Then look for the first exact route match and execute its \"modules\"\n\tfor (const route of routes) {\n\t\tif (route.method && route.method !== request.method) {\n\t\t\tcontinue;\n\t\t}\n\t\tconst routeMatcher = match(route.routePath.replace(escapeRegex, \"\\\\$&\"), {\n\t\t\tend: true,\n\t\t});\n\t\tconst mountMatcher = match(route.mountPath.replace(escapeRegex, \"\\\\$&\"), {\n\t\t\tend: false,\n\t\t});\n\t\tconst matchResult = routeMatcher(requestPath);\n\t\tconst mountMatchResult = mountMatcher(requestPath);\n\t\tif (matchResult && mountMatchResult && route.modules.length) {\n\t\t\tfor (const handler of route.modules.flat()) {\n\t\t\t\tyield {\n\t\t\t\t\thandler,\n\t\t\t\t\tparams: matchResult.params as Params,\n\t\t\t\t\tpath: matchResult.path,\n\t\t\t\t};\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nexport default {\n\tasync fetch(\n\t\toriginalRequest: Request,\n\t\tenv: FetchEnv,\n\t\tworkerContext: WorkerContext\n\t) {\n\t\tlet request = originalRequest;\n\t\tconst handlerIterator = executeRequest(request);\n\t\tlet data = {}; // arbitrary data the user can set between functions\n\t\tlet isFailOpen = false;\n\n\t\tconst next = async (input?: RequestInfo, init?: RequestInit) => {\n\t\t\tif (input !== undefined) {\n\t\t\t\tlet url = input;\n\t\t\t\tif (typeof input === \"string\") {\n\t\t\t\t\turl = new URL(input, request.url).toString();\n\t\t\t\t}\n\t\t\t\trequest = new Request(url, init);\n\t\t\t}\n\n\t\t\tconst result = handlerIterator.next();\n\t\t\t// Note we can't use `!result.done` because this doesn't narrow to the correct type\n\t\t\tif (result.done === false) {\n\t\t\t\tconst { handler, params, path } = result.value;\n\t\t\t\tconst context = {\n\t\t\t\t\trequest: new Request(request.clone()),\n\t\t\t\t\tfunctionPath: path,\n\t\t\t\t\tnext,\n\t\t\t\t\tparams,\n\t\t\t\t\tget data() {\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t},\n\t\t\t\t\tset data(value) {\n\t\t\t\t\t\tif (typeof value !== \"object\" || value === null) {\n\t\t\t\t\t\t\tthrow new Error(\"context.data must be an object\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// user has overriden context.data, so we need to merge it with the existing data\n\t\t\t\t\t\tdata = value;\n\t\t\t\t\t},\n\t\t\t\t\tenv,\n\t\t\t\t\twaitUntil: workerContext.waitUntil.bind(workerContext),\n\t\t\t\t\tpassThroughOnException: () => {\n\t\t\t\t\t\tisFailOpen = true;\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\tconst response = await handler(context);\n\n\t\t\t\tif (!(response instanceof Response)) {\n\t\t\t\t\tthrow new Error(\"Your Pages function should return a Response\");\n\t\t\t\t}\n\n\t\t\t\treturn cloneResponse(response);\n\t\t\t} else if (__FALLBACK_SERVICE__) {\n\t\t\t\t// There are no more handlers so finish with the fallback service (`env.ASSETS.fetch` in Pages' case)\n\t\t\t\tconst response = await env[__FALLBACK_SERVICE__].fetch(request);\n\t\t\t\treturn cloneResponse(response);\n\t\t\t} else {\n\t\t\t\t// There was not fallback service so actually make the request to the origin.\n\t\t\t\tconst response = await fetch(request);\n\t\t\t\treturn cloneResponse(response);\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\treturn await next();\n\t\t} catch (error) {\n\t\t\tif (isFailOpen) {\n\t\t\t\tconst response = await env[__FALLBACK_SERVICE__].fetch(request);\n\t\t\t\treturn cloneResponse(response);\n\t\t\t}\n\n\t\t\tthrow error;\n\t\t}\n\t},\n};\n\n// This makes a Response mutable\nconst cloneResponse = (response: Response) =>\n\t// https://fetch.spec.whatwg.org/#null-body-status\n\tnew Response(\n\t\t[101, 204, 205, 304].includes(response.status) ? null : response.body,\n\t\tresponse\n\t);\n", "/**\n * Tokenizer results.\n */\ninterface LexToken {\n  type:\n    | \"OPEN\"\n    | \"CLOSE\"\n    | \"PATTERN\"\n    | \"NAME\"\n    | \"CHAR\"\n    | \"ESCAPED_CHAR\"\n    | \"MODIFIER\"\n    | \"END\";\n  index: number;\n  value: string;\n}\n\n/**\n * Tokenize input string.\n */\nfunction lexer(str: string): LexToken[] {\n  const tokens: LexToken[] = [];\n  let i = 0;\n\n  while (i < str.length) {\n    const char = str[i];\n\n    if (char === \"*\" || char === \"+\" || char === \"?\") {\n      tokens.push({ type: \"MODIFIER\", index: i, value: str[i++] });\n      continue;\n    }\n\n    if (char === \"\\\\\") {\n      tokens.push({ type: \"ESCAPED_CHAR\", index: i++, value: str[i++] });\n      continue;\n    }\n\n    if (char === \"{\") {\n      tokens.push({ type: \"OPEN\", index: i, value: str[i++] });\n      continue;\n    }\n\n    if (char === \"}\") {\n      tokens.push({ type: \"CLOSE\", index: i, value: str[i++] });\n      continue;\n    }\n\n    if (char === \":\") {\n      let name = \"\";\n      let j = i + 1;\n\n      while (j < str.length) {\n        const code = str.charCodeAt(j);\n\n        if (\n          // `0-9`\n          (code >= 48 && code <= 57) ||\n          // `A-Z`\n          (code >= 65 && code <= 90) ||\n          // `a-z`\n          (code >= 97 && code <= 122) ||\n          // `_`\n          code === 95\n        ) {\n          name += str[j++];\n          continue;\n        }\n\n        break;\n      }\n\n      if (!name) throw new TypeError(`Missing parameter name at ${i}`);\n\n      tokens.push({ type: \"NAME\", index: i, value: name });\n      i = j;\n      continue;\n    }\n\n    if (char === \"(\") {\n      let count = 1;\n      let pattern = \"\";\n      let j = i + 1;\n\n      if (str[j] === \"?\") {\n        throw new TypeError(`Pattern cannot start with \"?\" at ${j}`);\n      }\n\n      while (j < str.length) {\n        if (str[j] === \"\\\\\") {\n          pattern += str[j++] + str[j++];\n          continue;\n        }\n\n        if (str[j] === \")\") {\n          count--;\n          if (count === 0) {\n            j++;\n            break;\n          }\n        } else if (str[j] === \"(\") {\n          count++;\n          if (str[j + 1] !== \"?\") {\n            throw new TypeError(`Capturing groups are not allowed at ${j}`);\n          }\n        }\n\n        pattern += str[j++];\n      }\n\n      if (count) throw new TypeError(`Unbalanced pattern at ${i}`);\n      if (!pattern) throw new TypeError(`Missing pattern at ${i}`);\n\n      tokens.push({ type: \"PATTERN\", index: i, value: pattern });\n      i = j;\n      continue;\n    }\n\n    tokens.push({ type: \"CHAR\", index: i, value: str[i++] });\n  }\n\n  tokens.push({ type: \"END\", index: i, value: \"\" });\n\n  return tokens;\n}\n\nexport interface ParseOptions {\n  /**\n   * Set the default delimiter for repeat parameters. (default: `'/'`)\n   */\n  delimiter?: string;\n  /**\n   * List of characters to automatically consider prefixes when parsing.\n   */\n  prefixes?: string;\n}\n\n/**\n * Parse a string for the raw tokens.\n */\nexport function parse(str: string, options: ParseOptions = {}): Token[] {\n  const tokens = lexer(str);\n  const { prefixes = \"./\", delimiter = \"/#?\" } = options;\n  const result: Token[] = [];\n  let key = 0;\n  let i = 0;\n  let path = \"\";\n\n  const tryConsume = (type: LexToken[\"type\"]): string | undefined => {\n    if (i < tokens.length && tokens[i].type === type) return tokens[i++].value;\n  };\n\n  const mustConsume = (type: LexToken[\"type\"]): string => {\n    const value = tryConsume(type);\n    if (value !== undefined) return value;\n    const { type: nextType, index } = tokens[i];\n    throw new TypeError(`Unexpected ${nextType} at ${index}, expected ${type}`);\n  };\n\n  const consumeText = (): string => {\n    let result = \"\";\n    let value: string | undefined;\n    while ((value = tryConsume(\"CHAR\") || tryConsume(\"ESCAPED_CHAR\"))) {\n      result += value;\n    }\n    return result;\n  };\n\n  const isSafe = (value: string): boolean => {\n    for (const char of delimiter) if (value.indexOf(char) > -1) return true;\n    return false;\n  };\n\n  const safePattern = (prefix: string) => {\n    const prev = result[result.length - 1];\n    const prevText = prefix || (prev && typeof prev === \"string\" ? prev : \"\");\n\n    if (prev && !prevText) {\n      throw new TypeError(\n        `Must have text between two parameters, missing text after \"${(prev as Key).name}\"`,\n      );\n    }\n\n    if (!prevText || isSafe(prevText)) return `[^${escapeString(delimiter)}]+?`;\n    return `(?:(?!${escapeString(prevText)})[^${escapeString(delimiter)}])+?`;\n  };\n\n  while (i < tokens.length) {\n    const char = tryConsume(\"CHAR\");\n    const name = tryConsume(\"NAME\");\n    const pattern = tryConsume(\"PATTERN\");\n\n    if (name || pattern) {\n      let prefix = char || \"\";\n\n      if (prefixes.indexOf(prefix) === -1) {\n        path += prefix;\n        prefix = \"\";\n      }\n\n      if (path) {\n        result.push(path);\n        path = \"\";\n      }\n\n      result.push({\n        name: name || key++,\n        prefix,\n        suffix: \"\",\n        pattern: pattern || safePattern(prefix),\n        modifier: tryConsume(\"MODIFIER\") || \"\",\n      });\n      continue;\n    }\n\n    const value = char || tryConsume(\"ESCAPED_CHAR\");\n    if (value) {\n      path += value;\n      continue;\n    }\n\n    if (path) {\n      result.push(path);\n      path = \"\";\n    }\n\n    const open = tryConsume(\"OPEN\");\n    if (open) {\n      const prefix = consumeText();\n      const name = tryConsume(\"NAME\") || \"\";\n      const pattern = tryConsume(\"PATTERN\") || \"\";\n      const suffix = consumeText();\n\n      mustConsume(\"CLOSE\");\n\n      result.push({\n        name: name || (pattern ? key++ : \"\"),\n        pattern: name && !pattern ? safePattern(prefix) : pattern,\n        prefix,\n        suffix,\n        modifier: tryConsume(\"MODIFIER\") || \"\",\n      });\n      continue;\n    }\n\n    mustConsume(\"END\");\n  }\n\n  return result;\n}\n\nexport interface TokensToFunctionOptions {\n  /**\n   * When `true` the regexp will be case sensitive. (default: `false`)\n   */\n  sensitive?: boolean;\n  /**\n   * Function for encoding input strings for output.\n   */\n  encode?: (value: string, token: Key) => string;\n  /**\n   * When `false` the function can produce an invalid (unmatched) path. (default: `true`)\n   */\n  validate?: boolean;\n}\n\n/**\n * Compile a string to a template function for the path.\n */\nexport function compile<P extends object = object>(\n  str: string,\n  options?: ParseOptions & TokensToFunctionOptions,\n) {\n  return tokensToFunction<P>(parse(str, options), options);\n}\n\nexport type PathFunction<P extends object = object> = (data?: P) => string;\n\n/**\n * Expose a method for transforming tokens into the path function.\n */\nexport function tokensToFunction<P extends object = object>(\n  tokens: Token[],\n  options: TokensToFunctionOptions = {},\n): PathFunction<P> {\n  const reFlags = flags(options);\n  const { encode = (x: string) => x, validate = true } = options;\n\n  // Compile all the tokens into regexps.\n  const matches = tokens.map((token) => {\n    if (typeof token === \"object\") {\n      return new RegExp(`^(?:${token.pattern})$`, reFlags);\n    }\n  });\n\n  return (data: Record<string, any> | null | undefined) => {\n    let path = \"\";\n\n    for (let i = 0; i < tokens.length; i++) {\n      const token = tokens[i];\n\n      if (typeof token === \"string\") {\n        path += token;\n        continue;\n      }\n\n      const value = data ? data[token.name] : undefined;\n      const optional = token.modifier === \"?\" || token.modifier === \"*\";\n      const repeat = token.modifier === \"*\" || token.modifier === \"+\";\n\n      if (Array.isArray(value)) {\n        if (!repeat) {\n          throw new TypeError(\n            `Expected \"${token.name}\" to not repeat, but got an array`,\n          );\n        }\n\n        if (value.length === 0) {\n          if (optional) continue;\n\n          throw new TypeError(`Expected \"${token.name}\" to not be empty`);\n        }\n\n        for (let j = 0; j < value.length; j++) {\n          const segment = encode(value[j], token);\n\n          if (validate && !(matches[i] as RegExp).test(segment)) {\n            throw new TypeError(\n              `Expected all \"${token.name}\" to match \"${token.pattern}\", but got \"${segment}\"`,\n            );\n          }\n\n          path += token.prefix + segment + token.suffix;\n        }\n\n        continue;\n      }\n\n      if (typeof value === \"string\" || typeof value === \"number\") {\n        const segment = encode(String(value), token);\n\n        if (validate && !(matches[i] as RegExp).test(segment)) {\n          throw new TypeError(\n            `Expected \"${token.name}\" to match \"${token.pattern}\", but got \"${segment}\"`,\n          );\n        }\n\n        path += token.prefix + segment + token.suffix;\n        continue;\n      }\n\n      if (optional) continue;\n\n      const typeOfMessage = repeat ? \"an array\" : \"a string\";\n      throw new TypeError(`Expected \"${token.name}\" to be ${typeOfMessage}`);\n    }\n\n    return path;\n  };\n}\n\nexport interface RegexpToFunctionOptions {\n  /**\n   * Function for decoding strings for params.\n   */\n  decode?: (value: string, token: Key) => string;\n}\n\n/**\n * A match result contains data about the path match.\n */\nexport interface MatchResult<P extends object = object> {\n  path: string;\n  index: number;\n  params: P;\n}\n\n/**\n * A match is either `false` (no match) or a match result.\n */\nexport type Match<P extends object = object> = false | MatchResult<P>;\n\n/**\n * The match function takes a string and returns whether it matched the path.\n */\nexport type MatchFunction<P extends object = object> = (\n  path: string,\n) => Match<P>;\n\n/**\n * Create path match function from `path-to-regexp` spec.\n */\nexport function match<P extends object = object>(\n  str: Path,\n  options?: ParseOptions & TokensToRegexpOptions & RegexpToFunctionOptions,\n) {\n  const keys: Key[] = [];\n  const re = pathToRegexp(str, keys, options);\n  return regexpToFunction<P>(re, keys, options);\n}\n\n/**\n * Create a path match function from `path-to-regexp` output.\n */\nexport function regexpToFunction<P extends object = object>(\n  re: RegExp,\n  keys: Key[],\n  options: RegexpToFunctionOptions = {},\n): MatchFunction<P> {\n  const { decode = (x: string) => x } = options;\n\n  return function (pathname: string) {\n    const m = re.exec(pathname);\n    if (!m) return false;\n\n    const { 0: path, index } = m;\n    const params = Object.create(null);\n\n    for (let i = 1; i < m.length; i++) {\n      if (m[i] === undefined) continue;\n\n      const key = keys[i - 1];\n\n      if (key.modifier === \"*\" || key.modifier === \"+\") {\n        params[key.name] = m[i].split(key.prefix + key.suffix).map((value) => {\n          return decode(value, key);\n        });\n      } else {\n        params[key.name] = decode(m[i], key);\n      }\n    }\n\n    return { path, index, params };\n  };\n}\n\n/**\n * Escape a regular expression string.\n */\nfunction escapeString(str: string) {\n  return str.replace(/([.+*?=^!:${}()[\\]|/\\\\])/g, \"\\\\$1\");\n}\n\n/**\n * Get the flags for a regexp from the options.\n */\nfunction flags(options?: { sensitive?: boolean }) {\n  return options && options.sensitive ? \"\" : \"i\";\n}\n\n/**\n * Metadata about a key.\n */\nexport interface Key {\n  name: string | number;\n  prefix: string;\n  suffix: string;\n  pattern: string;\n  modifier: string;\n}\n\n/**\n * A token is a string (nothing special) or key metadata (capture group).\n */\nexport type Token = string | Key;\n\n/**\n * Pull out keys from a regexp.\n */\nfunction regexpToRegexp(path: RegExp, keys?: Key[]): RegExp {\n  if (!keys) return path;\n\n  const groupsRegex = /\\((?:\\?<(.*?)>)?(?!\\?)/g;\n\n  let index = 0;\n  let execResult = groupsRegex.exec(path.source);\n  while (execResult) {\n    keys.push({\n      // Use parenthesized substring match if available, index otherwise\n      name: execResult[1] || index++,\n      prefix: \"\",\n      suffix: \"\",\n      modifier: \"\",\n      pattern: \"\",\n    });\n    execResult = groupsRegex.exec(path.source);\n  }\n\n  return path;\n}\n\n/**\n * Transform an array into a regexp.\n */\nfunction arrayToRegexp(\n  paths: Array<string | RegExp>,\n  keys?: Key[],\n  options?: TokensToRegexpOptions & ParseOptions,\n): RegExp {\n  const parts = paths.map((path) => pathToRegexp(path, keys, options).source);\n  return new RegExp(`(?:${parts.join(\"|\")})`, flags(options));\n}\n\n/**\n * Create a path regexp from string input.\n */\nfunction stringToRegexp(\n  path: string,\n  keys?: Key[],\n  options?: TokensToRegexpOptions & ParseOptions,\n) {\n  return tokensToRegexp(parse(path, options), keys, options);\n}\n\nexport interface TokensToRegexpOptions {\n  /**\n   * When `true` the regexp will be case sensitive. (default: `false`)\n   */\n  sensitive?: boolean;\n  /**\n   * When `true` the regexp won't allow an optional trailing delimiter to match. (default: `false`)\n   */\n  strict?: boolean;\n  /**\n   * When `true` the regexp will match to the end of the string. (default: `true`)\n   */\n  end?: boolean;\n  /**\n   * When `true` the regexp will match from the beginning of the string. (default: `true`)\n   */\n  start?: boolean;\n  /**\n   * Sets the final character for non-ending optimistic matches. (default: `/`)\n   */\n  delimiter?: string;\n  /**\n   * List of characters that can also be \"end\" characters.\n   */\n  endsWith?: string;\n  /**\n   * Encode path tokens for use in the `RegExp`.\n   */\n  encode?: (value: string) => string;\n}\n\n/**\n * Expose a function for taking tokens and returning a RegExp.\n */\nexport function tokensToRegexp(\n  tokens: Token[],\n  keys?: Key[],\n  options: TokensToRegexpOptions = {},\n) {\n  const {\n    strict = false,\n    start = true,\n    end = true,\n    encode = (x: string) => x,\n    delimiter = \"/#?\",\n    endsWith = \"\",\n  } = options;\n  const endsWithRe = `[${escapeString(endsWith)}]|$`;\n  const delimiterRe = `[${escapeString(delimiter)}]`;\n  let route = start ? \"^\" : \"\";\n\n  // Iterate over the tokens and create our regexp string.\n  for (const token of tokens) {\n    if (typeof token === \"string\") {\n      route += escapeString(encode(token));\n    } else {\n      const prefix = escapeString(encode(token.prefix));\n      const suffix = escapeString(encode(token.suffix));\n\n      if (token.pattern) {\n        if (keys) keys.push(token);\n\n        if (prefix || suffix) {\n          if (token.modifier === \"+\" || token.modifier === \"*\") {\n            const mod = token.modifier === \"*\" ? \"?\" : \"\";\n            route += `(?:${prefix}((?:${token.pattern})(?:${suffix}${prefix}(?:${token.pattern}))*)${suffix})${mod}`;\n          } else {\n            route += `(?:${prefix}(${token.pattern})${suffix})${token.modifier}`;\n          }\n        } else {\n          if (token.modifier === \"+\" || token.modifier === \"*\") {\n            throw new TypeError(\n              `Can not repeat \"${token.name}\" without a prefix and suffix`,\n            );\n          }\n\n          route += `(${token.pattern})${token.modifier}`;\n        }\n      } else {\n        route += `(?:${prefix}${suffix})${token.modifier}`;\n      }\n    }\n  }\n\n  if (end) {\n    if (!strict) route += `${delimiterRe}?`;\n\n    route += !options.endsWith ? \"$\" : `(?=${endsWithRe})`;\n  } else {\n    const endToken = tokens[tokens.length - 1];\n    const isEndDelimited =\n      typeof endToken === \"string\"\n        ? delimiterRe.indexOf(endToken[endToken.length - 1]) > -1\n        : endToken === undefined;\n\n    if (!strict) {\n      route += `(?:${delimiterRe}(?=${endsWithRe}))?`;\n    }\n\n    if (!isEndDelimited) {\n      route += `(?=${delimiterRe}|${endsWithRe})`;\n    }\n  }\n\n  return new RegExp(route, flags(options));\n}\n\n/**\n * Supported `path-to-regexp` input types.\n */\nexport type Path = string | RegExp | Array<string | RegExp>;\n\n/**\n * Normalize the given path string, returning a regular expression.\n *\n * An empty array can be passed in for the keys, which will hold the\n * placeholder key descriptions. For example, using `/user/:id`, `keys` will\n * contain `[{ name: 'id', delimiter: '/', optional: false, repeat: false }]`.\n */\nexport function pathToRegexp(\n  path: Path,\n  keys?: Key[],\n  options?: TokensToRegexpOptions & ParseOptions,\n) {\n  if (path instanceof RegExp) return regexpToRegexp(path, keys);\n  if (Array.isArray(path)) return arrayToRegexp(path, keys, options);\n  return stringToRegexp(path, keys, options);\n}\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n"],
  "mappings": "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",
  "names": ["import_checked_fetch", "import_checked_fetch", "require_checked_fetch", "__commonJS", "__name", "match", "import_checked_fetch", "__toESM", "SchemaType", "ExecutableCodeLanguage", "Outcome", "HarmCategory", "HarmBlockThreshold", "HarmProbability", "BlockReason", "FinishReason", "TaskType", "FunctionCallingMode", "DynamicRetrievalMode", "Task", "_a", "knowledgeBase", "id", "duration", "reply", "onRequestPostPipeline", "loadKnowledgeBase", "knowledgeBaseLoading", "value", "result", "char", "prefix", "i", "import_checked_fetch", "drainBody", "middleware_ensure_req_body_drained_default", "import_checked_fetch", "reduceError", "jsonError", "middleware_miniflare3_json_error_default", "__INTERNAL_WRANGLER_MIDDLEWARE__", "middleware_ensure_req_body_drained_default", "middleware_miniflare3_json_error_default", "middleware_insertion_facade_default", "import_checked_fetch", "__facade_middleware__", "__facade_register__", "__facade_invokeChain__", "__facade_invoke__", "__facade_middleware__", "__Facade_ScheduledController__", "___Facade_ScheduledController__", "wrapExportedHandler", "__INTERNAL_WRANGLER_MIDDLEWARE__", "__facade_register__", "__facade_invoke__", "wrapWorkerEntrypoint", "WRAPPED_ENTRY", "middleware_insertion_facade_default", "middleware_loader_entry_default"]
}
