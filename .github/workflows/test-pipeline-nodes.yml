name: Test Pipeline Nodes

on:
  pull_request:
    paths:
      - 'functions/api/**'
      - 'scripts/test-pipeline-comparison.mjs'
      - 'scripts/verify-mvp.mjs'
      - '.github/workflows/test-pipeline-nodes.yml'
  push:
    branches:
      - main
    paths:
      - 'functions/api/**'
      - 'scripts/test-pipeline-comparison.mjs'
      - 'scripts/verify-mvp.mjs'
      - '.github/workflows/test-pipeline-nodes.yml'

jobs:
  test-pipeline-structure:
    name: Test Pipeline Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Verify MVP Implementation
        run: node scripts/verify-mvp.mjs
      
      - name: Test Pipeline Comparison
        run: node scripts/test-pipeline-comparison.mjs
      
      - name: Check TypeScript compilation
        run: |
          if command -v tsc &> /dev/null; then
            npx tsc --noEmit --project tsconfig.json || echo "⚠️ TypeScript check skipped (tsconfig.json not found or tsc not available)"
          else
            echo "⚠️ TypeScript compiler not found, skipping type check"
          fi

  test-pipeline-nodes:
    name: Test Individual Nodes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Verify all nodes exist
        run: |
          echo "檢查所有 Pipeline 節點文件..."
          nodes=(
            "functions/api/nodes/01-validate-request.ts"
            "functions/api/nodes/02-initialize-services.ts"
            "functions/api/nodes/03-context-management.ts"
            "functions/api/nodes/04-intent-extraction.ts"
            "functions/api/nodes/05-state-transition.ts"
            "functions/api/nodes/06-special-intents.ts"
            "functions/api/nodes/07-faq-check.ts"
            "functions/api/nodes/08-llm-generation.ts"
            "functions/api/nodes/09-build-response.ts"
            "functions/api/nodes/99-error-handler.ts"
          )
          
          missing_nodes=()
          for node in "${nodes[@]}"; do
            if [ ! -f "$node" ]; then
              missing_nodes+=("$node")
              echo "❌ 缺少節點: $node"
            else
              echo "✅ 節點存在: $node"
            fi
          done
          
          if [ ${#missing_nodes[@]} -ne 0 ]; then
            echo "❌ 發現 ${#missing_nodes[@]} 個缺失的節點"
            exit 1
          fi
          
          echo "✅ 所有節點文件都存在"
      
      - name: Verify Pipeline core files
        run: |
          echo "檢查 Pipeline 核心文件..."
          core_files=(
            "functions/api/lib/pipeline.ts"
            "functions/api/chat-pipeline.ts"
            "functions/api/nodes/index.ts"
          )
          
          missing_files=()
          for file in "${core_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
              echo "❌ 缺少文件: $file"
            else
              echo "✅ 文件存在: $file"
            fi
          done
          
          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "❌ 發現 ${#missing_files[@]} 個缺失的文件"
            exit 1
          fi
          
          echo "✅ 所有核心文件都存在"

  test-pipeline-integration:
    name: Test Pipeline Integration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check Pipeline node exports
        run: |
          echo "檢查 Pipeline 節點導出..."
          
          # 檢查 nodes/index.ts 是否導出所有必要的節點
          if [ -f "functions/api/nodes/index.ts" ]; then
            echo "✅ nodes/index.ts 存在"
            
            # 檢查是否導出了所有節點函數
            required_exports=(
              "node_validateRequest"
              "node_initializeServices"
              "node_contextManagement"
              "node_intentExtraction"
              "node_stateTransition"
              "node_specialIntents"
              "node_faqCheck"
              "node_llmGeneration"
              "node_buildResponse"
              "handlePipelineError"
            )
            
            index_content=$(cat functions/api/nodes/index.ts)
            missing_exports=()
            
            for export_name in "${required_exports[@]}"; do
              if echo "$index_content" | grep -q "$export_name"; then
                echo "✅ 導出存在: $export_name"
              else
                missing_exports+=("$export_name")
                echo "❌ 缺少導出: $export_name"
              fi
            done
            
            if [ ${#missing_exports[@]} -ne 0 ]; then
              echo "❌ 發現 ${#missing_exports[@]} 個缺失的導出"
              exit 1
            fi
            
            echo "✅ 所有必要的導出都存在"
          else
            echo "❌ nodes/index.ts 不存在"
            exit 1
          fi
      
      - name: Verify Pipeline node registration
        run: |
          echo "檢查 Pipeline 節點註冊..."
          
          if [ -f "functions/api/chat-pipeline.ts" ]; then
            echo "✅ chat-pipeline.ts 存在"
            
            # 檢查是否註冊了所有節點
            required_nodes=(
              "validateRequest"
              "initializeServices"
              "contextManagement"
              "intentExtraction"
              "stateTransition"
              "specialIntents"
              "faqCheck"
              "llmGeneration"
              "buildResponse"
            )
            
            pipeline_content=$(cat functions/api/chat-pipeline.ts)
            missing_nodes=()
            
            for node_name in "${required_nodes[@]}"; do
              if echo "$pipeline_content" | grep -q "addNode.*$node_name"; then
                echo "✅ 節點已註冊: $node_name"
              else
                missing_nodes+=("$node_name")
                echo "❌ 節點未註冊: $node_name"
              fi
            done
            
            if [ ${#missing_nodes[@]} -ne 0 ]; then
              echo "❌ 發現 ${#missing_nodes[@]} 個未註冊的節點"
              exit 1
            fi
            
            echo "✅ 所有節點都已正確註冊"
          else
            echo "❌ chat-pipeline.ts 不存在"
            exit 1
          fi

