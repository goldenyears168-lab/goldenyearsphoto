name: Test Backend

on:
  pull_request:
    paths:
      - 'functions/api/**'
      - 'scripts/test-*.mjs'
      - '.github/workflows/test-backend.yml'
  push:
    branches:
      - main
    paths:
      - 'functions/api/**'
      - 'scripts/test-*.mjs'
      - '.github/workflows/test-backend.yml'

jobs:
  test-backend-structure:
    name: Test Backend Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Verify API structure
        run: |
          echo "æª¢æŸ¥ API çµæ§‹..."
          
          required_files=(
            "functions/api/chat.ts"
            "functions/api/chat-pipeline.ts"
            "functions/api/lib/pipeline.ts"
          )
          
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
              echo "âŒ ç¼ºå°‘æ–‡ä»¶: $file"
            else
              echo "âœ… æ–‡ä»¶å­˜åœ¨: $file"
            fi
          done
          
          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "âŒ ç™¼ç¾ ${#missing_files[@]} å€‹ç¼ºå¤±çš„æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… API çµæ§‹å®Œæ•´"
      
      - name: Check API exports
        run: |
          echo "æª¢æŸ¥ API å°å‡º..."
          
          # æª¢æŸ¥ chat.ts æ˜¯å¦å°å‡º onRequestPost
          if [ -f "functions/api/chat.ts" ]; then
            chat_content=$(cat functions/api/chat.ts)
            
            if echo "$chat_content" | grep -q "export.*onRequestPost"; then
              echo "âœ… chat.ts å°å‡º onRequestPost"
            else
              echo "âŒ chat.ts æœªå°å‡º onRequestPost"
              exit 1
            fi
            
            # æª¢æŸ¥æ˜¯å¦å°å…¥äº† Pipeline ç‰ˆæœ¬
            if echo "$chat_content" | grep -q "onRequestPostPipeline"; then
              echo "âœ… chat.ts ä½¿ç”¨ Pipeline ç‰ˆæœ¬"
            else
              echo "âš ï¸  chat.ts å¯èƒ½æœªä½¿ç”¨ Pipeline ç‰ˆæœ¬"
            fi
          else
            echo "âŒ chat.ts ä¸å­˜åœ¨"
            exit 1
          fi
      
      - name: Verify test scripts exist
        run: |
          echo "æª¢æŸ¥æ¸¬è©¦è…³æœ¬..."
          
          test_scripts=(
            "scripts/test-pipeline-comparison.mjs"
            "scripts/verify-mvp.mjs"
            "scripts/test-chatbot-api.mjs"
          )
          
          missing_scripts=()
          for script in "${test_scripts[@]}"; do
            if [ ! -f "$script" ]; then
              missing_scripts+=("$script")
              echo "âŒ ç¼ºå°‘æ¸¬è©¦è…³æœ¬: $script"
            else
              echo "âœ… æ¸¬è©¦è…³æœ¬å­˜åœ¨: $script"
              # æª¢æŸ¥è…³æœ¬æ˜¯å¦å¯åŸ·è¡Œ
              if [ -x "$script" ] || head -n 1 "$script" | grep -q "#!/usr/bin/env node"; then
                echo "   âœ… è…³æœ¬å¯åŸ·è¡Œ"
              fi
            fi
          done
          
          if [ ${#missing_scripts[@]} -ne 0 ]; then
            echo "âš ï¸  ç™¼ç¾ ${#missing_scripts[@]} å€‹ç¼ºå¤±çš„æ¸¬è©¦è…³æœ¬ï¼ˆå¯é¸ï¼‰"
          fi

  lint-code:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint JavaScript
        run: |
          if npm run lint:js 2>/dev/null; then
            echo "âœ… JavaScript linting passed"
          else
            echo "âš ï¸  JavaScript linting issues found (non-blocking)"
          fi
      
      - name: Lint CSS
        run: |
          if npm run lint:css 2>/dev/null; then
            echo "âœ… CSS linting passed"
          else
            echo "âš ï¸  CSS linting issues found (non-blocking)"
          fi

  # æ³¨æ„ï¼šå¯¦éš›çš„ API æ¸¬è©¦éœ€è¦é‹è¡Œä¸­çš„æœå‹™å™¨
  # é€™å€‹ job åªåœ¨æœ‰ GEMINI_API_KEY secret æ™‚é‹è¡Œ
  test-api-integration:
    name: Test API Integration
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # éœ€è¦ GEMINI_API_KEY æ‰èƒ½é‹è¡Œå¯¦éš›çš„ API æ¸¬è©¦
    # å¦‚æœæ²’æœ‰è¨­ç½® secretï¼Œé€™å€‹ job æœƒè·³é
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Check if GEMINI_API_KEY is available
        id: check-key
        run: |
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "âš ï¸  GEMINI_API_KEY secret æœªè¨­ç½®ï¼Œè·³é API é›†æˆæ¸¬è©¦"
            echo "available=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… GEMINI_API_KEY å·²è¨­ç½®"
            echo "available=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Run API tests (if key available)
        if: steps.check-key.outputs.available == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸš€ å•Ÿå‹•æœ¬åœ°æ¸¬è©¦æœå‹™å™¨..."
          
          # åœ¨èƒŒæ™¯å•Ÿå‹• wrangler pages dev
          npx wrangler pages dev --port 8788 &
          WRANGLER_PID=$!
          
          # ç­‰å¾…æœå‹™å™¨å•Ÿå‹•
          echo "â³ ç­‰å¾…æœå‹™å™¨å•Ÿå‹•..."
          sleep 10
          
          # æª¢æŸ¥æœå‹™å™¨æ˜¯å¦é‹è¡Œ
          if curl -f http://localhost:8788/api/chat -X POST -H "Content-Type: application/json" -d '{"message":"test"}' > /dev/null 2>&1; then
            echo "âœ… æœå‹™å™¨å·²å•Ÿå‹•"
            
            # é‹è¡Œæ¸¬è©¦
            echo "ğŸ§ª é‹è¡Œ API æ¸¬è©¦..."
            API_URL=http://localhost:8788/api/chat node scripts/test-chatbot-api.mjs || true
            
            # æ¸…ç†
            kill $WRANGLER_PID 2>/dev/null || true
          else
            echo "âš ï¸  ç„¡æ³•é€£æ¥åˆ°æ¸¬è©¦æœå‹™å™¨ï¼Œè·³é API æ¸¬è©¦"
          fi
      
      - name: Skip API tests message
        if: steps.check-key.outputs.available == 'false'
        run: |
          echo "â„¹ï¸  API é›†æˆæ¸¬è©¦éœ€è¦ GEMINI_API_KEY secret"
          echo "   è¨­ç½®æ–¹æ³•ï¼šRepository Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
          echo "   æ¸¬è©¦è…³æœ¬å·²æº–å‚™å°±ç·’ï¼Œä½†éœ€è¦ API key æ‰èƒ½é‹è¡Œå¯¦éš›æ¸¬è©¦"

