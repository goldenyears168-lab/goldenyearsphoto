# AI 客服機器人 Pipeline 模式重構計劃書

## 📋 文檔信息

- **文檔版本**: v1.0
- **創建日期**: 2025-01-20
- **負責人**: 技術團隊
- **預估工期**: 5-7 個工作日
- **風險等級**: 中等（有完整的回滾計劃）

---

## 🎯 項目目標

### 主要目標
1. **提升代碼可維護性**：將 400+ 行的單一函數拆解為清晰的 Pipeline 節點
2. **增強調試透明度**：引入結構化日誌，實現 n8n 風格的執行追蹤
3. **改善開發體驗**：線性數據流，每個節點獨立可測試
4. **保持系統穩定性**：100% 向後兼容，不破壞現有功能

### 成功指標
- ✅ 主流程函數從 400+ 行減少到 < 100 行
- ✅ 每個節點函數 < 50 行，單一職責
- ✅ 結構化日誌覆蓋率 100%
- ✅ 單元測試覆蓋率 > 80%
- ✅ 零回歸測試失敗
- ✅ 性能影響 < 5%（日誌開銷）

---

## 📊 現狀分析

### 當前代碼結構
```
functions/api/chat.ts
├── onRequestPost() [400+ 行] ⚠️ 主要痛點
│   ├── 請求驗證 (50 行)
│   ├── 服務初始化 (30 行)
│   ├── 上下文管理 (20 行)
│   ├── 意圖分類 (10 行)
│   ├── 實體提取 (10 行)
│   ├── 狀態轉換 (40 行)
│   ├── 特殊意圖處理 (100+ 行)
│   ├── FAQ 檢查 (50 行)
│   ├── LLM 生成 (50 行)
│   └── 響應構建 (40 行)
├── buildResponse() [已優化]
├── handleFAQIfNeeded() [已優化]
├── classifyIntent() [已優化]
└── extractEntities() [已優化]
```

### 已完成的優化
- ✅ 統一響應構建函數
- ✅ 統一 FAQ 檢查處理
- ✅ 意圖分類配置化
- ✅ 實體提取配置化
- ✅ 狀態轉換配置化

### 現有痛點
1. **代碼冗長**：`onRequestPost` 函數超過 400 行
2. **調試困難**：缺少結構化日誌，問題定位困難
3. **測試困難**：函數過大，難以單元測試
4. **維護困難**：邏輯混雜，修改風險高

---

## 🏗️ 目標架構

### Pipeline 架構設計

```
┌─────────────────────────────────────────────────────────┐
│                  ChatRequestPipeline                     │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐         │
│  │ Node 1   │───▶│ Node 2   │───▶│ Node 3   │───▶...  │
│  │ Validate │    │ Init     │    │ Context  │         │
│  └──────────┘    └──────────┘    └──────────┘         │
│       │               │               │                 │
│       ▼               ▼               ▼                 │
│   PipelineContext (統一的數據流)                        │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 節點設計原則
1. **單一職責**：每個節點只做一件事
2. **數據流清晰**：輸入輸出都是 `PipelineContext`
3. **可提前退出**：節點可返回 `Response` 提前結束流程
4. **錯誤隔離**：節點錯誤不影響其他節點執行（由 Pipeline 統一處理）

---

## ⚠️ 關鍵修正（必須在實施前閱讀）

**重要**: 請先閱讀 `docs/PIPELINE_FEASIBILITY_REVIEW.md` 和 `docs/PIPELINE_CRITICAL_FIXES.md`，了解所有關鍵修正點。

### 必須修正的 6 個關鍵點

1. **setKnowledgeBase 調用時機**：必須在知識庫載入後立即調用
2. **LLM 不可用的特殊響應格式**：503 狀態碼，無 suggestedQuickReplies
3. **超時處理的資源清理**：必須清理 timeoutId，防止內存泄漏
4. **錯誤重新拋出機制**：知識庫和 LLM 錯誤必須重新拋出
5. **外層錯誤處理完全復現**：必須完全復現現有的錯誤日誌邏輯
6. **響應時間日誌**：正常流程結束時記錄響應時間

詳見：`docs/PIPELINE_CRITICAL_FIXES.md`

---

## 📝 詳細實施計劃

### 階段 0：最小可驗證版本 (MVP) (Day 0.5) ⭐ 新增

**目標**: 驗證 Pipeline 框架可行性，確保關鍵修正正確實施

#### 0.1 實現最小 Pipeline 框架

**任務清單**:
- [ ] 實現 Pipeline 核心框架（支持提前退出和錯誤重新拋出）
- [ ] 實現 PipelineContext 接口
- [ ] 實現基礎日誌系統

#### 0.2 實現 3 個核心節點進行驗證

**節點選擇**:
1. 請求驗證節點（包含所有驗證邏輯）
2. 服務初始化節點（包含 setKnowledgeBase 調用和錯誤重新拋出）
3. 錯誤處理節點（完全復現外層錯誤處理）

#### 0.3 對比測試

**任務清單**:
- [ ] 測試驗證錯誤返回格式與現有實現完全一致
- [ ] 測試知識庫錯誤是否正確傳播
- [ ] 測試錯誤響應格式是否完全一致
- [ ] 驗證關鍵修正點是否正確實施

**驗收標準**:
- ✅ 所有測試通過
- ✅ 響應格式 100% 一致
- ✅ 錯誤處理邏輯正確

**如果 MVP 失敗**: 停止重構，回退並重新評估方案

---

### 階段 1：基礎框架搭建 (Day 1-2)

#### 1.1 創建 Pipeline 核心類型定義

**文件**: `functions/api/lib/pipeline.ts`

**任務清單**:
- [ ] 定義 `PipelineContext` 接口
- [ ] 定義 `PipelineNode` 類型
- [ ] 定義 `PipelineLogger` 接口
- [ ] 定義 `PipelineError` 類型

**驗收標準**:
- TypeScript 編譯通過
- 類型定義完整，無 `any` 類型

#### 1.2 實現 Pipeline 基類

**文件**: `functions/api/lib/pipeline.ts`

**任務清單**:
- [ ] 實現 `Pipeline` 基類
- [ ] 實現節點註冊機制
- [ ] 實現節點執行機制
- [ ] 實現結構化日誌系統
- [ ] 實現錯誤處理機制

**驗收標準**:
- 可以註冊多個節點
- 可以順序執行節點
- 節點可以提前返回 Response
- 日誌格式統一且可讀

#### 1.3 單元測試

**文件**: `functions/api/lib/__tests__/pipeline.test.ts`

**任務清單**:
- [ ] 測試節點順序執行
- [ ] 測試節點提前退出
- [ ] 測試錯誤處理
- [ ] 測試日誌記錄

**驗收標準**:
- 測試覆蓋率 > 90%
- 所有測試通過

---

### 階段 2：節點拆分實施 (Day 3-4)

#### 2.1 創建節點目錄結構

```
functions/api/nodes/
├── index.ts                 # 節點導出
├── 01-validate-request.ts   # 請求驗證節點
├── 02-initialize-services.ts # 服務初始化節點
├── 03-context-management.ts  # 上下文管理節點
├── 04-intent-extraction.ts   # 意圖分類與實體提取
├── 05-state-transition.ts    # 狀態轉換節點
├── 06-special-intents.ts     # 特殊意圖處理
├── 07-faq-check.ts          # FAQ 檢查節點
├── 08-llm-generation.ts     # LLM 生成節點
├── 09-build-response.ts     # 響應構建節點
└── 99-error-handler.ts      # 錯誤處理節點
```

#### 2.2 實施各節點 (按優先級)

**節點 1: 請求驗證** ⭐⭐⭐ (高優先級)

**任務清單**:
- [ ] 提取請求驗證邏輯
- [ ] 實現 CORS 檢查
- [ ] 實現請求體驗證
- [ ] 實現參數驗證
- [ ] 單元測試

**節點 2: 服務初始化** ⭐⭐⭐ (高優先級 - 關鍵修正)

**任務清單**:
- [ ] 提取服務初始化邏輯
- [ ] 實現知識庫載入
- [ ] ⚠️ **關鍵**: 知識庫載入後立即調用 `setKnowledgeBase(kb)` (見修正點 1)
- [ ] 實現 LLM 服務初始化
- [ ] 實現上下文管理器初始化
- [ ] ⚠️ **關鍵**: 知識庫錯誤必須重新拋出 (見修正點 4)
- [ ] 單元測試（包含錯誤重新拋出測試）

**節點 3: 上下文管理** ⭐⭐ (中優先級)

**任務清單**:
- [ ] 提取上下文獲取/創建邏輯
- [ ] 實現上下文恢復
- [ ] 實現上下文創建
- [ ] 單元測試

**節點 4: 意圖提取** ⭐⭐⭐ (高優先級)

**任務清單**:
- [ ] 整合意圖分類邏輯
- [ ] 整合實體提取邏輯
- [ ] 整合實體合併邏輯
- [ ] 單元測試

**節點 5: 狀態轉換** ⭐⭐ (中優先級)

**任務清單**:
- [ ] 提取狀態轉換邏輯
- [ ] 實現配置驅動的狀態轉換
- [ ] 實現 fallback 邏輯
- [ ] 單元測試

**節點 6: 特殊意圖處理** ⭐⭐⭐ (高優先級)

**任務清單**:
- [ ] 提取 Line 詢問處理
- [ ] 提取投訴處理
- [ ] 提取轉真人處理
- [ ] 單元測試

**節點 7: FAQ 檢查** ⭐⭐ (中優先級)

**任務清單**:
- [ ] 封裝現有 `handleFAQIfNeeded` 函數
- [ ] 實現菜單選擇優先處理
- [ ] 單元測試

**節點 8: LLM 生成** ⭐⭐⭐ (高優先級 - 多個關鍵修正)

**任務清單**:
- [ ] ⚠️ **關鍵**: 檢查 LLM 不可用情況，返回 503 特殊格式 (見修正點 2)
- [ ] 提取 LLM 調用邏輯
- [ ] ⚠️ **關鍵**: 實現超時處理，必須使用 try-finally 清理 timeoutId (見修正點 3)
- [ ] ⚠️ **關鍵**: 非超時錯誤必須重新拋出 (見修正點 4)
- [ ] 實現錯誤處理
- [ ] 單元測試（包含 LLM 不可用、超時、錯誤場景）

**節點 9: 響應構建** ⭐⭐⭐ (高優先級 - 關鍵修正)

**任務清單**:
- [ ] 封裝現有 `buildResponse` 函數
- [ ] ⚠️ **關鍵**: 實現響應時間日誌記錄 (見修正點 6)
- [ ] 實現響應格式化
- [ ] 單元測試

**節點 99: 錯誤處理** ⭐⭐⭐ (高優先級 - 關鍵修正)

**任務清單**:
- [ ] ⚠️ **關鍵**: 完全復現現有外層錯誤處理邏輯 (見修正點 5)
- [ ] 實現詳細錯誤日誌（包括知識庫和 LLM 錯誤的特殊處理）
- [ ] 實現錯誤響應構建（500 狀態碼，格式完全一致）
- [ ] 單元測試（對比現有實現的錯誤響應格式）

---

### 階段 3: 主流程重構 (Day 5)

#### 3.1 重構 onRequestPost 函數

**任務清單**:
- [ ] 創建 Pipeline 實例
- [ ] 註冊所有節點（按順序）
- [ ] 初始化 PipelineContext
- [ ] 執行 Pipeline
- [ ] 處理 Pipeline 錯誤

**驗收標準**:
- `onRequestPost` 函數 < 100 行
- ⚠️ **關鍵**: 功能與原實現 100% 一致（必須對比重構前後的響應）
- ⚠️ **關鍵**: 所有關鍵修正點已實施
- 所有測試通過

#### 3.2 整合測試

**任務清單**:
- [ ] 端到端測試（完整流程）
- [ ] 性能測試（對比重構前後）
- [ ] 錯誤場景測試
- [ ] 邊界條件測試

**驗收標準**:
- 所有整合測試通過
- 性能影響 < 5%
- 錯誤處理正確

---

### 階段 4: 日誌增強與調試工具 (Day 6)

#### 4.1 增強結構化日誌

**任務清單**:
- [ ] 實現節點級別日誌
- [ ] 實現執行時間追蹤
- [ ] 實現數據快照（可選，避免敏感數據）
- [ ] 實現日誌級別控制

**驗收標準**:
- 日誌格式統一
- 日誌包含必要信息
- 日誌不影響性能

#### 4.2 創建調試工具（可選）

**任務清單**:
- [ ] 創建日誌可視化腳本
- [ ] 創建 Pipeline 流程圖生成器
- [ ] 文檔說明如何使用

**驗收標準**:
- 工具可用
- 文檔完整

---

### 階段 5: 文檔與回歸測試 (Day 7)

#### 5.1 文檔編寫

**任務清單**:
- [ ] API 文檔更新
- [ ] 開發者指南（如何添加新節點）
- [ ] 調試指南（如何使用日誌）
- [ ] 架構文檔

**驗收標準**:
- 文檔完整清晰
- 包含示例代碼

#### 5.2 回歸測試

**任務清單**:
- [ ] 運行所有現有測試
- [ ] 手動測試所有功能
- [ ] 性能基準測試
- [ ] 生產環境預發布測試

**驗收標準**:
- 所有測試通過
- 無回歸問題
- 性能達標

---

## ⚠️ 風險分析與應對

### 風險 0: MVP 驗證失敗 ⚠️⚠️ (中風險) ⭐ 新增

**影響**: 嚴重
**概率**: 低（如果嚴格遵循關鍵修正）

**原因**:
- Pipeline 框架設計可能有缺陷
- 關鍵修正點可能被遺漏

**應對措施**:
1. **階段 0 MVP 驗證**：先實現最小版本驗證可行性
2. **嚴格遵循關鍵修正**：必須實施所有 6 個關鍵修正點
3. **對比測試**：MVP 階段就進行完整對比測試

**如果 MVP 失敗**: 立即停止，回退並重新評估方案

---

### 風險 1: 功能回歸 ⚠️⚠️⚠️ (高風險 → 中風險)

**影響**: 嚴重
**概率**: 中等

**原因**:
- 重構範圍大，可能遺漏某些邊界條件
- 節點拆分可能改變執行順序

**應對措施**:
1. **階段 0 MVP 驗證**：先驗證關鍵路徑正確性
2. **完整測試覆蓋**：為每個節點編寫單元測試
3. **關鍵修正檢查清單**：每個階段完成後檢查關鍵修正點
4. **對比測試**：重構前後輸出 100% 對比驗證（包括 JSON 結構、狀態碼、日誌格式）
5. **分階段發布**：先在測試環境驗證，再逐步推廣
6. **回滾計劃**：保留原代碼分支，可快速回滾

**回滾計劃**:
```bash
# 如果出現問題，立即回滾
git revert <commit-hash>
# 或切換到原分支
git checkout main-old
```

---

### 風險 2: 性能下降 ⚠️⚠️ (中風險)

**影響**: 中等
**概率**: 低

**原因**:
- Pipeline 框架可能有額外開銷
- 結構化日誌可能有性能影響

**應對措施**:
1. **性能基準測試**：重構前後對比
2. **日誌開關**：生產環境可關閉詳細日誌
3. **異步日誌**：日誌記錄異步執行
4. **性能監控**：上線後密切監控

**性能目標**:
- 響應時間增加 < 50ms
- CPU 使用率增加 < 5%
- 內存使用增加 < 10MB

---

### 風險 3: 學習曲線 ⚠️ (低風險)

**影響**: 低
**概率**: 中等

**原因**:
- 團隊需要時間熟悉 Pipeline 模式
- 調試方式改變

**應對措施**:
1. **詳細文檔**：提供完整的開發者指南
2. **培訓會議**：組織技術分享
3. **示例代碼**：提供常見場景示例
4. **代碼審查**：初期嚴格審查，確保理解一致

---

### 風險 4: 過度設計 ⚠️ (低風險)

**影響**: 低
**概率**: 低

**原因**:
- 可能過度抽象，增加複雜度

**應對措施**:
1. **保持簡單**：節點粒度適中，不過度拆分
2. **優先實用**：優先實現核心功能，可選功能後續迭代
3. **代碼審查**：確保設計合理性

---

## ✅ 測試策略

### 單元測試 (每個節點)

**測試覆蓋**:
- ✅ 正常執行流程
- ✅ 錯誤處理
- ✅ 邊界條件
- ✅ 數據驗證

**示例**:
```typescript
describe('Node: ValidateRequest', () => {
  it('should validate valid request', async () => {
    const ctx = createMockContext();
    const result = await node_validateRequest(ctx);
    expect(result).toBeInstanceOf(PipelineContext);
  });
  
  it('should return error for invalid request', async () => {
    const ctx = createInvalidContext();
    const result = await node_validateRequest(ctx);
    expect(result).toBeInstanceOf(Response);
    expect(result.status).toBe(400);
  });
});
```

### 整合測試 (完整流程)

**測試場景**:
1. 正常對話流程
2. 特殊意圖處理（投訴、轉真人）
3. FAQ 匹配流程
4. 錯誤處理流程
5. 超時處理
6. ⚠️ **新增**: LLM 不可用場景（驗證 503 響應格式）
7. ⚠️ **新增**: 知識庫載入錯誤（驗證錯誤傳播）
8. ⚠️ **新增**: 所有提前退出點（12 個）

### 對比測試 (關鍵) ⚠️

**必須執行的對比測試**:
1. 重構前後響應 JSON 結構 100% 對比
2. 重構前後狀態碼對比
3. 重構前後錯誤響應格式對比
4. 重構前後日誌格式對比
5. 重構前後響應時間對比

**工具**: 編寫自動化對比測試腳本

### 性能測試

**指標**:
- 響應時間 P50/P95/P99
- CPU 使用率
- 內存使用
- 並發處理能力

**工具**:
- 使用 k6 或 artillery 進行負載測試
- 對比重構前後指標

---

## 📅 實施時間表

| 階段 | 任務 | 天數 | 負責人 | 狀態 |
|------|------|------|--------|------|
| 階段0 | MVP 驗證 | 0.5 | 開發者A | ⬜ 待開始 ⚠️ 新增 |
| 階段1 | 基礎框架搭建 | 2 | 開發者A | ⬜ 待開始 |
| 階段2 | 節點拆分實施 | 2 | 開發者B | ⬜ 待開始 |
| 階段3 | 主流程重構 | 1 | 開發者A | ⬜ 待開始 |
| 階段4 | 日誌增強 | 1 | 開發者B | ⬜ 待開始 |
| 階段5 | 文檔與測試 | 1 | 全體 | ⬜ 待開始 |

**總計**: 7.5 個工作日

**緩衝時間**: +2 天（用於應對意外問題）

**預估完成時間**: 9 個工作日

---

## 📦 交付物清單

### 代碼交付物
- [ ] `functions/api/lib/pipeline.ts` - Pipeline 核心框架
- [ ] `functions/api/nodes/*.ts` - 所有節點實現
- [ ] `functions/api/chat.ts` - 重構後的主流程
- [ ] `functions/api/lib/__tests__/*.test.ts` - 單元測試
- [ ] `functions/api/__tests__/integration.test.ts` - 整合測試

### 文檔交付物
- [ ] `docs/PIPELINE_ARCHITECTURE.md` - 架構文檔
- [ ] `docs/DEVELOPER_GUIDE.md` - 開發者指南
- [ ] `docs/DEBUGGING_GUIDE.md` - 調試指南
- [ ] `docs/MIGRATION_GUIDE.md` - 遷移指南（如果需要）

### 測試交付物
- [ ] 測試報告
- [ ] 性能基準報告
- [ ] 回歸測試報告

---

## 🔄 發布計劃

### 發布階段

**階段 1: 內部測試** (Day 8-9)
- 在測試環境部署
- 內部團隊測試
- 修復發現的問題

**階段 2: 灰度發布** (Day 10-12)
- 10% 流量切換到新版本
- 監控錯誤率和性能
- 逐步增加到 50%

**階段 3: 全量發布** (Day 13+)
- 100% 流量切換
- 持續監控
- 收集反饋

### 回滾條件

如果出現以下情況，立即回滾：
1. 錯誤率增加 > 1%
2. 響應時間增加 > 100ms
3. 出現嚴重功能問題
4. 性能指標不達標

---

## 📚 關鍵文檔

### 必須閱讀的文檔（按順序）

1. **`docs/PIPELINE_FEASIBILITY_REVIEW.md`** ⚠️ **必讀**
   - 深度技術審查報告
   - 現有實現完整分析
   - 關鍵問題識別

2. **`docs/PIPELINE_CRITICAL_FIXES.md`** ⚠️ **必讀**
   - 6 個關鍵修正點詳細說明
   - 每個修正點的代碼示例
   - 驗證清單

3. **`docs/PIPELINE_REFACTORING_PLAN.md`** (本文檔)
   - 完整實施計劃
   - 時間表和資源分配

---

## 📚 參考資料

### 設計模式
- Pipeline Pattern
- Chain of Responsibility Pattern
- Strategy Pattern

### 相關文檔
- n8n 工作流設計理念
- 現有代碼優化文檔

### 工具與框架
- TypeScript 最佳實踐
- Jest 測試框架
- 結構化日誌最佳實踐

---

## ✍️ 簽名與批准

### 技術負責人
- **姓名**: _________________
- **簽名**: _________________
- **日期**: _________________

### 項目經理
- **姓名**: _________________
- **簽名**: _________________
- **日期**: _________________

---

## 📝 變更日誌

| 版本 | 日期 | 變更內容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-01-20 | 初始版本 | 技術團隊 |

---

**文檔結束**

