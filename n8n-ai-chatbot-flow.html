<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好時有影 AI 客服機器人 - n8n 流程圖</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .section {
            margin-bottom: 50px;
        }
        
        h2 {
            color: #34495e;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            font-size: 1.5em;
        }
        
        h3 {
            color: #555;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
        }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            overflow-x: auto;
        }
        
        .json-file {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
        }
        
        .code-module {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            padding: 15px;
            margin: 15px 0;
        }
        
        .flow-step {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin: 15px 0;
        }
        
        ul, ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: #3498db;
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>好時有影 AI 客服機器人</h1>
        <p class="subtitle">n8n 工作流程詳細說明與架構圖</p>
        
        <div class="section">
            <h2>📊 完整流程圖</h2>
            <p>以下為使用 Mermaid 繪製的完整 n8n 工作流程圖，展示從接收用戶訊息到生成回覆的完整過程：</p>
            
            <div class="mermaid">
graph TD
    Start([用戶發送訊息]) --> Webhook[Webhook 節點<br/>接收 POST 請求]
    
    Webhook --> Validate[驗證請求<br/>- Content-Type<br/>- CORS<br/>- 必要欄位]
    
    Validate -->|驗證失敗| Error1[返回 400 錯誤]
    Validate -->|驗證成功| LoadKB[載入知識庫<br/>KnowledgeBase.load]
    
    LoadKB -->|載入失敗| Error2[返回 500 錯誤]
    LoadKB -->|載入成功| InitServices[初始化服務<br/>- LLMService<br/>- ContextManager]
    
    InitServices -->|LLM 不可用| Error3[返回 503 錯誤<br/>API Error Template]
    InitServices -->|服務就緒| GetContext[取得/建立對話上下文<br/>ContextManager]
    
    GetContext --> ClassifyIntent[意圖分類<br/>classifyIntent]
    ClassifyIntent --> ExtractEntities[實體提取<br/>extractEntities]
    
    ExtractEntities --> CheckSpecial{特殊情況檢查}
    
    CheckSpecial -->|Line 詢問| LineTemplate[Line 回應模板<br/>getLineInquiryTemplate]
    CheckSpecial -->|投訴| ComplaintTemplate[投訴處理模板<br/>getComplaintTemplate]
    CheckSpecial -->|轉真人| HandoffTemplate[轉真人模板<br/>getHandoffTemplate]
    CheckSpecial -->|一般情況| CheckFAQ{檢查 FAQ 匹配}
    
    LineTemplate --> BuildResponse1[構建回應]
    ComplaintTemplate --> BuildResponse2[構建回應]
    HandoffTemplate --> BuildResponse3[構建回應]
    
    CheckFAQ -->|菜單選擇 source=menu| FAQMatch[FAQ 詳細匹配<br/>searchFAQDetailed]
    CheckFAQ -->|地址詢問| LocationFAQ[地址 FAQ 匹配]
    CheckFAQ -->|價格政策詢問| PricePolicyFAQ[價格政策 FAQ]
    CheckFAQ -->|預約改期/取消| BookingPolicyFAQ[預約政策 FAQ]
    CheckFAQ -->|其他| LLMProcess[LLM 處理流程]
    
    FAQMatch -->|匹配成功| BuildResponse4[構建回應]
    FAQMatch -->|匹配失敗| LLMProcess
    
    LocationFAQ -->|匹配成功| BuildResponse5[構建回應]
    LocationFAQ -->|匹配失敗| LLMProcess
    
    PricePolicyFAQ -->|匹配成功| BuildResponse6[構建回應]
    PricePolicyFAQ -->|匹配失敗| LLMProcess
    
    BookingPolicyFAQ -->|匹配成功| BuildResponse7[構建回應]
    BookingPolicyFAQ -->|匹配失敗| LLMProcess
    
    LLMProcess --> BuildPrompt[構建 LLM Prompt<br/>buildSystemPrompt]
    BuildPrompt --> CallLLM[調用 Gemini API<br/>generateReply]
    
    CallLLM -->|超時 10s| TimeoutTemplate[超時模板<br/>getTimeoutTemplate]
    CallLLM -->|API 錯誤| ApiErrorTemplate[API 錯誤模板<br/>getApiErrorTemplate]
    CallLLM -->|成功| CleanReply[清理回覆內容<br/>cleanReply]
    
    TimeoutTemplate --> BuildResponse8[構建回應]
    ApiErrorTemplate --> BuildResponse9[構建回應]
    CleanReply --> UpdateContext[更新對話上下文<br/>ContextManager.updateContext]
    
    UpdateContext --> GetQuickReplies[取得快速回覆建議<br/>getSuggestedQuickReplies]
    
    GetQuickReplies --> BuildResponse10[構建最終回應<br/>ChatResponse]
    
    BuildResponse1 --> End([返回 JSON 回應])
    BuildResponse2 --> End
    BuildResponse3 --> End
    BuildResponse4 --> End
    BuildResponse5 --> End
    BuildResponse6 --> End
    BuildResponse7 --> End
    BuildResponse8 --> End
    BuildResponse9 --> End
    BuildResponse10 --> End
    
    style Webhook fill:#e1f5ff
    style LoadKB fill:#fff3cd
    style InitServices fill:#fff3cd
    style ClassifyIntent fill:#d4edda
    style ExtractEntities fill:#d4edda
    style LLMProcess fill:#f8d7da
    style BuildResponse10 fill:#d1ecf1
            </div>
        </div>
        
        <div class="section">
            <h2>📁 知識庫 JSON 檔案說明</h2>
            <p>知識庫採用 JSON 格式作為單一事實來源，所有資料都從這些檔案載入：</p>
            
            <div class="json-file">
                <h3>1. services.json - 服務基本資訊</h3>
                <p><strong>用途：</strong>定義所有攝影服務的詳細資訊</p>
                <p><strong>主要欄位：</strong></p>
                <ul>
                    <li><code>id</code>: 服務唯一識別碼（如 <code>headshot_korean</code>、<code>portrait_pro</code>）</li>
                    <li><code>name</code>: 服務名稱（如「韓式證件照」、「專業形象照」）</li>
                    <li><code>price_range</code>: 價格範圍（如「約 NT$399 / 張」）</li>
                    <li><code>pricing_model</code>: 計價方式（如「按張計費，低消 1 張」）</li>
                    <li><code>shooting_time</code>: 拍攝時長</li>
                    <li><code>target_audience</code>: 目標客群</li>
                    <li><code>use_cases</code>: 適用場景</li>
                    <li><code>pros</code>: 服務優點</li>
                    <li><code>not_suitable</code>: 不適合的情況</li>
                </ul>
                <p><strong>在流程中的使用：</strong>LLM 生成回覆時，用於提供準確的服務資訊和價格，防止編造不存在的服務。</p>
            </div>
            
            <div class="json-file">
                <h3>2. personas.json - 客戶角色分析</h3>
                <p><strong>用途：</strong>定義不同客戶角色的特徵、需求與推薦服務</p>
                <p><strong>主要欄位：</strong></p>
                <ul>
                    <li><code>id</code>: 角色 ID（如 <code>student_graduating</code>、<code>pro_switching_job</code>）</li>
                    <li><code>name</code>: 角色名稱（如「畢業學生」、「轉職上班族」）</li>
                    <li><code>goals</code>: 目標與需求</li>
                    <li><code>concerns</code>: 關心事項</li>
                    <li><code>budget_level</code>: 預算等級</li>
                    <li><code>recommended_services</code>: 推薦的服務 ID 列表</li>
                    <li><code>reasoning</code>: 推薦理由</li>
                </ul>
                <p><strong>在流程中的使用：</strong>當實體提取識別出客戶角色時，用於提供個人化的服務推薦。</p>
            </div>
            
            <div class="json-file">
                <h3>3. policies.json - 重要政策與 FAQ</h3>
                <p><strong>用途：</strong>定義關鍵政策問題的標準答案</p>
                <p><strong>主要欄位：</strong></p>
                <ul>
                    <li><code>id</code>: 政策 ID（如 <code>policy_price_scope</code>）</li>
                    <li><code>category</code>: 分類（如「價格」、「預約」、「隱私」）</li>
                    <li><code>critical</code>: 是否為關鍵政策（必須嚴格遵守）</li>
                    <li><code>question</code>: 問題內容</li>
                    <li><code>answer</code>: 標準答案</li>
                    <li><code>keywords</code>: 關鍵字陣列（用於匹配）</li>
                </ul>
                <p><strong>在流程中的使用：</strong>在 FAQ 匹配階段，用於快速回答政策類問題，確保答案一致性。</p>
            </div>
            
            <div class="json-file">
                <h3>4. contact_info.json - 聯絡資訊</h3>
                <p><strong>用途：</strong>定義分店地址、營業時間、聯絡方式等資訊</p>
                <p><strong>主要欄位：</strong></p>
                <ul>
                    <li><code>branches</code>: 分店資訊陣列
                        <ul>
                            <li><code>name</code>: 分店名稱（如「中山店」、「公館店」）</li>
                            <li><code>address</code>: 地址</li>
                            <li><code>phone</code>: 電話</li>
                            <li><code>hours</code>: 營業時間</li>
                            <li><code>parking</code>: 停車資訊</li>
                        </ul>
                    </li>
                    <li><code>contact_channels</code>: 聯絡管道（Email、IG、Line、預約連結）</li>
                    <li><code>ai_response_rules</code>: AI 回應規則（Line 詢問、轉真人模板等）</li>
                </ul>
                <p><strong>在流程中的使用：</strong>回答地址/地點詢問時，必須使用此檔案中的資訊，嚴禁編造。也用於生成轉真人、投訴處理等模板。</p>
            </div>
            
            <div class="json-file">
                <h3>5. faq_detailed.json - 詳細 FAQ 問答集</h3>
                <p><strong>用途：</strong>包含 123+ 個常見問題的詳細問答，分類整理</p>
                <p><strong>結構：</strong></p>
                <ul>
                    <li><code>categories</code>: 分類物件
                        <ul>
                            <li><code>booking</code>: 預約問題（14 個）</li>
                            <li><code>delivery</code>: 交件問題（13 個）</li>
                            <li><code>shooting</code>: 拍攝問題（17 個）</li>
                            <li><code>pricing</code>: 價格問題（8 個）</li>
                            <li>... 其他分類</li>
                        </ul>
                    </li>
                    <li>每個問題包含：
                        <ul>
                            <li><code>id</code>: 問題 ID</li>
                            <li><code>question</code>: 問題內容</li>
                            <li><code>answer</code>: 答案內容</li>
                            <li><code>keywords</code>: 關鍵字陣列</li>
                            <li><code>critical_note</code>: 重要備註（可選）</li>
                        </ul>
                    </li>
                </ul>
                <p><strong>在流程中的使用：</strong>當用戶從菜單選擇問題（<code>source=menu</code>）時，優先使用 <code>searchFAQDetailed</code> 進行精確匹配，匹配成功直接返回答案，不調用 LLM。</p>
            </div>
            
            <div class="json-file">
                <h3>6. response_templates.json - 三段式回覆模板</h3>
                <p><strong>用途：</strong>定義不同意圖的標準回覆模板，確保回覆結構一致</p>
                <p><strong>結構：</strong></p>
                <ul>
                    <li><code>templates</code>: 模板物件，key 為意圖 ID
                        <ul>
                            <li><code>main_answer</code>: 主回答（直接回答問題）</li>
                            <li><code>supplementary_info</code>: 補充資訊（1-2 點關鍵細節）</li>
                            <li><code>next_best_actions</code>: 智慧預測選單（2-4 個下一步選項）</li>
                        </ul>
                    </li>
                </ul>
                <p><strong>在流程中的使用：</strong>LLM 生成回覆時，作為參考模板，確保回覆採用三段式結構。LLM 會用自然語言重新表達，不會原樣貼上。</p>
            </div>
            
            <div class="json-file">
                <h3>7. service_summaries.json - 服務摘要</h3>
                <p><strong>用途：</strong>提供服務的快速摘要，用於 LLM 生成回覆時的參考</p>
                <p><strong>主要欄位：</strong></p>
                <ul>
                    <li><code>core_purpose</code>: 核心用途</li>
                    <li><code>price_pricing</code>: 價格與計費說明</li>
                    <li><code>shooting_time_selection</code>: 拍攝時長/挑圖說明</li>
                    <li><code>delivery_speed</code>: 交件速度</li>
                    <li><code>add_ons_limitations</code>: 常見加購/限制</li>
                </ul>
                <p><strong>在流程中的使用：</strong>當實體提取識別出 <code>service_type</code> 時，LLM 會使用對應的服務摘要來生成回覆。</p>
            </div>
            
            <div class="json-file">
                <h3>8. emotion_templates.json - 情緒場景模板</h3>
                <p><strong>用途：</strong>定義不同情緒場景的回應方式，展現同理心</p>
                <p><strong>主要欄位：</strong></p>
                <ul>
                    <li><code>emotion</code>: 情緒類型（如「緊張」、「焦慮」、「不滿意」）</li>
                    <li><code>keywords</code>: 觸發關鍵字</li>
                    <li><code>warm_comfort</code>: 溫暖安撫語句</li>
                    <li><code>assistance_explanation</code>: 協助說明</li>
                    <li><code>next_best_actions</code>: 智慧選單</li>
                </ul>
                <p><strong>在流程中的使用：</strong>LLM 生成回覆前，會檢查用戶訊息是否包含情緒關鍵字，如果匹配到情緒模板，會優先使用該模板的內容。</p>
            </div>
            
            <div class="json-file">
                <h3>9. intent_nba_mapping.json - 意圖對應表</h3>
                <p><strong>用途：</strong>定義每個意圖對應的「下一步最佳動作」（Next Best Actions）</p>
                <p><strong>結構：</strong></p>
                <ul>
                    <li><code>mappings</code>: 對應物件，key 為意圖 ID，value 為快速回覆選項陣列
                        <ul>
                            <li>例如：<code>price_inquiry</code> → <code>["拍攝流程", "妝髮建議", "交件時間", "線上預約"]</code></li>
                            <li>例如：<code>service_inquiry</code> → <code>["我想拍形象照", "我想拍證件照", "我想拍全家福", "想知道價格"]</code></li>
                        </ul>
                    </li>
                </ul>
                <p><strong>在流程中的使用：</strong>在構建最終回應時，<code>getSuggestedQuickReplies</code> 函數會優先使用此檔案中的定義，如果找不到才使用 fallback 邏輯。</p>
            </div>
        </div>
        
        <div class="section">
            <h2>💻 程式碼模組說明</h2>
            <p>系統採用模組化設計，每個模組負責特定功能：</p>
            
            <div class="code-module">
                <h3>1. chat.ts - 主要 API 端點</h3>
                <p><strong>檔案位置：</strong><code>functions/api/chat.ts</code></p>
                <p><strong>功能：</strong>處理所有聊天請求的入口點</p>
                <p><strong>主要函數：</strong></p>
                <ul>
                    <li><code>onRequestPost()</code>: Cloudflare Pages Function 的處理函數
                        <ul>
                            <li>驗證請求（Content-Type、CORS、必要欄位）</li>
                            <li>載入知識庫</li>
                            <li>初始化服務（LLM、ContextManager）</li>
                            <li>協調整個處理流程</li>
                            <li>構建並返回回應</li>
                        </ul>
                    </li>
                    <li><code>classifyIntent()</code>: 意圖分類（規則基礎）
                        <ul>
                            <li>檢查關鍵字匹配（投訴、轉真人、價格、地址等）</li>
                            <li>返回意圖 ID（如 <code>price_inquiry</code>、<code>location_inquiry</code>）</li>
                        </ul>
                    </li>
                    <li><code>extractEntities()</code>: 實體提取
                        <ul>
                            <li>提取 <code>service_type</code>（服務類型）</li>
                            <li>提取 <code>use_case</code>（使用場景）</li>
                            <li>提取 <code>persona</code>（客戶角色）</li>
                            <li>提取 <code>branch</code>（分店）</li>
                            <li>提取 <code>booking_action</code>（預約動作）</li>
                        </ul>
                    </li>
                    <li><code>getSuggestedQuickReplies()</code>: 取得快速回覆建議
                        <ul>
                            <li>優先使用 <code>intent_nba_mapping.json</code></li>
                            <li>其次使用 <code>response_templates.json</code> 中的 <code>next_best_actions</code></li>
                            <li>最後使用 fallback 邏輯</li>
                        </ul>
                    </li>
                </ul>
            </div>
            
            <div class="code-module">
                <h3>2. knowledge.ts - 知識庫載入服務</h3>
                <p><strong>檔案位置：</strong><code>functions/api/lib/knowledge.ts</code></p>
                <p><strong>功能：</strong>載入和管理所有知識庫 JSON 檔案</p>
                <p><strong>主要類別：</strong><code>KnowledgeBase</code></p>
                <p><strong>主要方法：</strong></p>
                <ul>
                    <li><code>load(baseUrl?)</code>: 載入所有知識庫檔案
                        <ul>
                            <li>使用 <code>fetch</code> 動態載入 JSON 檔案</li>
                            <li>驗證 baseUrl 格式（防止 SSRF）</li>
                            <li>並行載入所有檔案以提高效率</li>
                        </ul>
                    </li>
                    <li><code>getService(id)</code>: 取得特定服務資訊</li>
                    <li><code>getAllServices()</code>: 取得所有服務列表</li>
                    <li><code>getPersona(id)</code>: 取得客戶角色資訊</li>
                    <li><code>searchFAQ(query)</code>: 搜尋 FAQ（關鍵字匹配，返回 <code>policies.json</code> 中的結果）</li>
                    <li><code>searchFAQDetailed(query)</code>: 詳細 FAQ 搜尋（優化版，返回 <code>faq_detailed.json</code> 中的結果）
                        <ul>
                            <li>使用多層評分機制（精確匹配、關鍵字匹配、詞彙匹配等）</li>
                            <li>返回分數最高的前 5 個問題</li>
                        </ul>
                    </li>
                    <li><code>getContactInfo()</code>: 取得聯絡資訊</li>
                    <li><code>getResponseTemplate(intent)</code>: 取得回覆模板</li>
                    <li><code>getServiceSummary(serviceId)</code>: 取得服務摘要</li>
                    <li><code>findEmotionTemplateByKeywords(message)</code>: 根據關鍵字搜尋情緒模板</li>
                    <li><code>getNextBestActions(intent)</code>: 取得意圖對應的下一步動作</li>
                </ul>
            </div>
            
            <div class="code-module">
                <h3>3. llm.ts - LLM 服務封裝</h3>
                <p><strong>檔案位置：</strong><code>functions/api/lib/llm.ts</code></p>
                <p><strong>功能：</strong>整合 Google Gemini API，生成自然語言回覆</p>
                <p><strong>主要類別：</strong><code>LLMService</code></p>
                <p><strong>主要方法：</strong></p>
                <ul>
                    <li><code>constructor(apiKey)</code>: 初始化 Gemini API 客戶端
                        <ul>
                            <li>使用 <code>gemini-2.0-flash</code> 模型</li>
                        </ul>
                    </li>
                    <li><code>generateReply(params)</code>: 生成回覆
                        <ul>
                            <li>構建 System Prompt（包含品牌定位、約束條件、知識庫資料）</li>
                            <li>構建 User Message（包含用戶訊息和對話歷史）</li>
                            <li>調用 Gemini API</li>
                            <li>清理回覆內容（移除 JSON、程式碼區塊等）</li>
                        </ul>
                    </li>
                    <li><code>buildSystemPrompt()</code>: 構建 System Prompt
                        <ul>
                            <li>包含品牌定位與語氣要求</li>
                            <li>包含關鍵約束（禁止編造服務、價格必須出自 JSON 等）</li>
                            <li>根據意圖和實體動態加入相關知識庫資料</li>
                            <li>包含回覆格式要求（三段式結構）</li>
                        </ul>
                    </li>
                    <li><code>cleanReply(reply)</code>: 清理回覆內容
                        <ul>
                            <li>移除 JSON 程式碼區塊</li>
                            <li>移除資料結構片段</li>
                            <li>合併多餘空行</li>
                        </ul>
                    </li>
                </ul>
            </div>
            
            <div class="code-module">
                <h3>4. contextManager.ts - 對話上下文管理器</h3>
                <p><strong>檔案位置：</strong><code>functions/api/lib/contextManager.ts</code></p>
                <p><strong>功能：</strong>管理對話上下文，追蹤對話狀態和歷史</p>
                <p><strong>主要類別：</strong><code>ContextManager</code></p>
                <p><strong>主要資料結構：</strong><code>ConversationContext</code></p>
                <ul>
                    <li><code>conversationId</code>: 對話 ID（格式：<code>conv_timestamp_random</code>）</li>
                    <li><code>last_intent</code>: 上次意圖</li>
                    <li><code>slots</code>: 已收集的實體資訊（service_type、use_case、persona 等）</li>
                    <li><code>history</code>: 對話歷史（最近 20 條）</li>
                    <li><code>state</code>: 對話狀態（INIT、COLLECTING_INFO、RECOMMENDING 等）</li>
                    <li><code>createdAt</code>: 建立時間</li>
                    <li><code>lastActivityAt</code>: 最後活動時間</li>
                </ul>
                <p><strong>主要方法：</strong></p>
                <ul>
                    <li><code>getContext(conversationId)</code>: 取得現有上下文（如果存在且未過期）</li>
                    <li><code>createContext(conversationId?)</code>: 建立新上下文</li>
                    <li><code>updateContext(conversationId, updates)</code>: 更新上下文
                        <ul>
                            <li>更新意圖、實體、狀態</li>
                            <li>添加對話歷史</li>
                            <li>限制歷史記錄長度</li>
                        </ul>
                    </li>
                    <li><code>cleanupExpiredContexts()</code>: 清理過期上下文（TTL: 30 分鐘）</li>
                </ul>
                <p><strong>注意：</strong>目前使用內存存儲，在 Cloudflare Pages Functions 中可能不會持久化。建議後續升級為 Cloudflare KV。</p>
            </div>
            
            <div class="code-module">
                <h3>5. responseTemplates.ts - 回應模板</h3>
                <p><strong>檔案位置：</strong><code>functions/api/lib/responseTemplates.ts</code></p>
                <p><strong>功能：</strong>提供標準化的錯誤和特殊情況回應模板</p>
                <p><strong>主要函數：</strong></p>
                <ul>
                    <li><code>getComplaintTemplate()</code>: 投訴處理模板
                        <ul>
                            <li>展現同理心</li>
                            <li>提供真人聯絡方式</li>
                            <li>強調補償決策由真人處理</li>
                        </ul>
                    </li>
                    <li><code>getHandoffTemplate(reason?)</code>: 轉真人模板
                        <ul>
                            <li>說明轉真人的原因（可選）</li>
                            <li>提供多種聯絡方式</li>
                        </ul>
                    </li>
                    <li><code>getDontUnderstandFirst()</code>: 無法理解模板（第一次）</li>
                    <li><code>getDontUnderstandSecond()</code>: 無法理解模板（第二次，建議轉真人）</li>
                    <li><code>getApiErrorTemplate()</code>: API 錯誤模板</li>
                    <li><code>getTimeoutTemplate()</code>: 超時模板（10 秒超時）</li>
                    <li><code>getLineInquiryTemplate()</code>: Line 官方帳號回應模板</li>
                </ul>
                <p><strong>注意：</strong>這些模板會從 <code>contact_info.json</code> 中讀取聯絡資訊，確保資訊一致性。</p>
            </div>
        </div>
        
        <div class="section">
            <h2>🔄 流程步驟詳細說明</h2>
            
            <div class="flow-step">
                <h3>步驟 1: Webhook 接收</h3>
                <p><strong>節點類型：</strong>Webhook（觸發節點）</p>
                <p><strong>功能：</strong>接收來自前端聊天 Widget 的 POST 請求</p>
                <p><strong>請求格式：</strong></p>
                <div class="code-block">
{
  "message": "我想拍形象照",
  "source": "input",  // 或 "menu"
  "mode": "auto",  // 或 "decision_recommendation" / "faq_flow_price"
  "pageType": "home",  // 或 "qa"
  "conversationId": "conv_1234567890_abc123",  // 可選
  "context": {  // 可選
    "last_intent": "service_inquiry",
    "slots": {
      "service_type": "portrait_pro"
    }
  }
}
                </div>
            </div>
            
            <div class="flow-step">
                <h3>步驟 2: 請求驗證</h3>
                <p><strong>節點類型：</strong>Code（JavaScript）</p>
                <p><strong>功能：</strong>驗證請求格式和安全性</p>
                <p><strong>驗證項目：</strong></p>
                <ul>
                    <li>Content-Type 必須為 <code>application/json</code></li>
                    <li>CORS 檢查（允許的來源列表）</li>
                    <li><code>message</code> 欄位必填且不能為空</li>
                    <li><code>message</code> 長度不能超過 1000 字元</li>
                    <li><code>conversationId</code> 格式驗證（如果提供）</li>
                    <li><code>mode</code>、<code>source</code>、<code>pageType</code> 值驗證</li>
                </ul>
                <p><strong>失敗處理：</strong>返回 400 錯誤</p>
            </div>
            
            <div class="flow-step">
                <h3>步驟 3: 載入知識庫</h3>
                <p><strong>節點類型：</strong>Code（JavaScript）</p>
                <p><strong>功能：</strong>動態載入所有知識庫 JSON 檔案</p>
                <p><strong>載入檔案：</strong></p>
                <ul>
                    <li><code>services.json</code></li>
                    <li><code>personas.json</code></li>
                    <li><code>policies.json</code></li>
                    <li><code>contact_info.json</code></li>
                    <li><code>faq_detailed.json</code></li>
                    <li><code>response_templates.json</code></li>
                    <li><code>service_summaries.json</code></li>
                    <li><code>emotion_templates.json</code></li>
                    <li><code>intent_nba_mapping.json</code></li>
                </ul>
                <p><strong>實現方式：</strong>使用 <code>fetch</code> 並行載入所有檔案</p>
                <p><strong>失敗處理：</strong>返回 500 錯誤</p>
            </div>
            
            <div class="flow-step">
                <h3>步驟 4: 初始化服務</h3>
                <p><strong>節點類型：</strong>Code（JavaScript）</p>
                <p><strong>功能：</strong>初始化 LLM 服務和上下文管理器</p>
                <p><strong>初始化項目：</strong></p>
                <ul>
                    <li><code>LLMService</code>: 使用環境變數 <code>GEMINI_API_KEY</code></li>
                    <li><code>ContextManager</code>: 建立實例</li>
                </ul>
                <p><strong>失敗處理：</strong>如果 LLM 不可用，返回 503 錯誤（使用 API Error Template）</p>
            </div>
            
            <div class="flow-step">
                <h3>步驟 5: 取得/建立對話上下文</h3>
                <p><strong>節點類型：</strong>Code（JavaScript）</p>
                <p><strong>功能：</strong>根據 <code>conversationId</code> 取得現有上下文，或建立新上下文</p>
                <p><strong>邏輯：</strong></p>
                <ul>
                    <li>如果提供 <code>conversationId</code>，嘗試取得現有上下文</li>
                    <li>如果上下文不存在或已過期（30 分鐘），建立新上下文</li>
                    <li>如果沒有提供 <code>conversationId</code>，自動生成新的 ID</li>
                </ul>
            </div>
            
            <div class="flow-step">
                <h3>步驟 6: 意圖分類</h3>
                <p><strong>節點類型：</strong>Code（JavaScript）</p>
                <p><strong>功能：</strong>使用規則基礎的方法分類用戶意圖</p>
                <p><strong>分類邏輯：</strong></p>
                <ul>
                    <li>檢查關鍵字匹配（投訴、轉真人、價格、地址等）</li>
                    <li>考慮上下文中的 <code>last_intent</code></li>
                    <li>返回意圖 ID（如 <code>price_inquiry</code>、<code>location_inquiry</code>）</li>
                </ul>
                <p><strong>支援的意圖：</strong></p>
                <ul>
                    <li><code>greeting</code>: 打招呼</li>
                    <li><code>service_inquiry</code>: 服務諮詢</li>
                    <li><code>price_inquiry</code>: 價格詢問</li>
                    <li><code>booking_inquiry</code>: 預約相關</li>
                    <li><code>location_inquiry</code>: 地址/地點詢問</li>
                    <li><code>delivery_inquiry</code>: 交件時間詢問</li>
                    <li><code>makeup_inquiry</code>: 妝髮詢問</li>
                    <li><code>comparison</code>: 方案比較</li>
                    <li><code>complaint</code>: 抱怨/投訴</li>
                    <li><code>handoff_to_human</code>: 轉真人</li>
                    <li><code>goodbye</code>: 結束對話</li>
                </ul>
            </div>
            
            <div class="flow-step">
                <h3>步驟 7: 實體提取</h3>
                <p><strong>節點類型：</strong>Code（JavaScript）</p>
                <p><strong>功能：</strong>從用戶訊息中提取結構化資訊</p>
                <p><strong>提取的實體：</strong></p>
                <ul>
                    <li><code>service_type</code>: 服務類型（如 <code>headshot_korean</code>、<code>portrait_pro</code>）</li>
                    <li><code>use_case</code>: 使用場景（如 <code>linkedin_resume</code>、<code>official_document</code>）</li>
                    <li><code>persona</code>: 客戶角色（如 <code>student_graduating</code>、<code>pro_switching_job</code>）</li>
                    <li><code>branch</code>: 分店（<code>zhongshan</code> 或 <code>gongguan</code>）</li>
                    <li><code>booking_action</code>: 預約動作（<code>book</code>、<code>reschedule</code>、<code>cancel</code>）</li>
                </ul>
                <p><strong>實現方式：</strong>使用關鍵字匹配和模式識別</p>
            </div>
            
            <div class="flow-step">
                <h3>步驟 8: 特殊情況檢查</h3>
                <p><strong>節點類型：</strong>Switch（條件分支）</p>
                <p><strong>功能：</strong>檢查是否需要使用特殊模板回應</p>
                <p><strong>特殊情況：</strong></p>
                <ul>
                    <li><strong>Line 詢問：</strong>如果訊息包含 "line"、"Line" 或 "LINE"，使用 Line 回應模板</li>
                    <li><strong>投訴：</strong>如果意圖為 <code>complaint</code>，使用投訴處理模板</li>
                    <li><strong>轉真人：</strong>如果意圖為 <code>handoff_to_human</code>，使用轉真人模板</li>
                </ul>
                <p><strong>處理方式：</strong>直接返回模板內容，不調用 LLM</p>
            </div>
            
            <div class="flow-step">
                <h3>步驟 9: FAQ 匹配</h3>
                <p><strong>節點類型：</strong>Switch（條件分支）</p>
                <p><strong>功能：</strong>根據不同情況嘗試匹配 FAQ</p>
                <p><strong>匹配邏輯：</strong></p>
                <ul>
                    <li><strong>菜單選擇（source=menu）：</strong>優先使用 <code>searchFAQDetailed</code> 進行精確匹配，匹配成功直接返回，不調用 LLM</li>
                    <li><strong>地址詢問：</strong>使用 <code>searchFAQ</code> 搜尋關鍵 FAQ，如果找到 <code>critical</code> 標記的 FAQ，直接返回</li>
                    <li><strong>價格政策詢問：</strong>只有明確問到「可以跟我說到多細」等政策問題時，才使用 FAQ</li>
                    <li><strong>預約改期/取消：</strong>只有明確問到「改期」或「取消」時，才使用 FAQ</li>
                </ul>
                <p><strong>匹配失敗：</strong>繼續執行 LLM 處理流程</p>
            </div>
            
            <div class="flow-step">
                <h3>步驟 10: LLM 處理流程</h3>
                <p><strong>節點類型：</strong>HTTP Request（調用 Gemini API）</p>
                <p><strong>功能：</strong>使用 Google Gemini API 生成自然語言回覆</p>
                <p><strong>處理步驟：</strong></p>
                <ol>
                    <li><strong>構建 System Prompt：</strong>
                        <ul>
                            <li>品牌定位與語氣要求</li>
                            <li>關鍵約束（禁止編造服務、價格必須出自 JSON 等）</li>
                            <li>根據意圖和實體動態加入相關知識庫資料</li>
                            <li>回覆格式要求（三段式結構）</li>
                        </ul>
                    </li>
                    <li><strong>構建 User Message：</strong>
                        <ul>
                            <li>用戶當前訊息</li>
                            <li>對話歷史（最近 3-5 條）</li>
                        </ul>
                    </li>
                    <li><strong>調用 Gemini API：</strong>
                        <ul>
                            <li>模型：<code>gemini-2.0-flash</code></li>
                            <li>超時設定：10 秒</li>
                        </ul>
                    </li>
                    <li><strong>清理回覆：</strong>
                        <ul>
                            <li>移除 JSON 程式碼區塊</li>
                            <li>移除資料結構片段</li>
                            <li>合併多餘空行</li>
                        </ul>
                    </li>
                </ol>
                <p><strong>錯誤處理：</strong></p>
                <ul>
                    <li>超時（10 秒）：返回超時模板</li>
                    <li>API 錯誤：返回 API 錯誤模板</li>
                </ul>
            </div>
            
            <div class="flow-step">
                <h3>步驟 11: 更新對話上下文</h3>
                <p><strong>節點類型：</strong>Code（JavaScript）</p>
                <p><strong>功能：</strong>將當前對話記錄到上下文中</p>
                <p><strong>更新內容：</strong></p>
                <ul>
                    <li><code>last_intent</code>: 當前意圖</li>
                    <li><code>slots</code>: 合併後的實體資訊</li>
                    <li><code>history</code>: 添加用戶訊息和 AI 回覆</li>
                    <li><code>lastActivityAt</code>: 更新最後活動時間</li>
                </ul>
            </div>
            
            <div class="flow-step">
                <h3>步驟 12: 取得快速回覆建議</h3>
                <p><strong>節點類型：</strong>Code（JavaScript）</p>
                <p><strong>功能：</strong>根據意圖和上下文，生成快速回覆按鈕選項</p>
                <p><strong>優先順序：</strong></p>
                <ol>
                    <li>使用 <code>intent_nba_mapping.json</code> 中的定義</li>
                    <li>使用 <code>response_templates.json</code> 中的 <code>next_best_actions</code></li>
                    <li>使用 fallback 邏輯（根據意圖和狀態）</li>
                </ol>
            </div>
            
            <div class="flow-step">
                <h3>步驟 13: 構建最終回應</h3>
                <p><strong>節點類型：</strong>Code（JavaScript）</p>
                <p><strong>功能：</strong>構建標準化的 JSON 回應</p>
                <p><strong>回應格式：</strong></p>
                <div class="code-block">
{
  "reply": "回覆內容（自然語言）",
  "intent": "price_inquiry",
  "conversationId": "conv_1234567890_abc123",
  "updatedContext": {
    "last_intent": "price_inquiry",
    "slots": {
      "service_type": "portrait_pro",
      "use_case": "linkedin_resume"
    }
  },
  "suggestedQuickReplies": [
    "拍攝流程",
    "妝髮建議",
    "交件時間",
    "線上預約"
  ]
}
                </div>
            </div>
            
            <div class="flow-step">
                <h3>步驟 14: 返回回應</h3>
                <p><strong>節點類型：</strong>Respond to Webhook</p>
                <p><strong>功能：</strong>將 JSON 回應返回給前端</p>
                <p><strong>HTTP 狀態碼：</strong></p>
                <ul>
                    <li><code>200</code>: 成功</li>
                    <li><code>400</code>: 請求格式錯誤</li>
                    <li><code>500</code>: 伺服器錯誤（知識庫載入失敗等）</li>
                    <li><code>503</code>: 服務不可用（LLM 不可用）</li>
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h2>🎯 關鍵設計決策</h2>
            
            <h3>1. 知識庫優先原則</h3>
            <ul>
                <li>所有服務、價格、聯絡資訊必須出自 JSON 檔案，嚴禁 LLM 編造</li>
                <li>FAQ 匹配優先於 LLM 生成，確保政策類問題的一致性</li>
                <li>菜單選擇（<code>source=menu</code>）優先使用 FAQ 匹配，不調用 LLM</li>
            </ul>
            
            <h3>2. 三段式回覆結構</h3>
            <ul>
                <li><strong>主回答：</strong>直接回答問題，清楚、完整</li>
                <li><strong>補充資訊：</strong>只補充最關鍵的 1-2 點細節</li>
                <li><strong>智慧預測選單：</strong>提供 2-4 個常見下一步選項</li>
            </ul>
            
            <h3>3. 錯誤處理策略</h3>
            <ul>
                <li>所有錯誤情況都有對應的模板，確保用戶體驗一致</li>
                <li>超時設定為 10 秒，避免用戶等待過久</li>
                <li>LLM 不可用時，建議轉真人，不返回空白或錯誤訊息</li>
            </ul>
            
            <h3>4. 上下文管理</h3>
            <ul>
                <li>使用 <code>conversationId</code> 追蹤對話狀態</li>
                <li>上下文 TTL 為 30 分鐘，自動清理過期上下文</li>
                <li>限制歷史記錄長度（最近 20 條），避免 prompt 過長</li>
            </ul>
            
            <h3>5. 意圖分類策略</h3>
            <ul>
                <li>目前使用規則基礎的方法（關鍵字匹配）</li>
                <li>未來可升級為 LLM 分類，提高準確性</li>
                <li>考慮上下文中的 <code>last_intent</code>，處理簡短回覆</li>
            </ul>
        </div>
        
        <div class="section">
            <h2>📝 n8n 節點配置建議</h2>
            
            <h3>Webhook 節點</h3>
            <ul>
                <li><strong>HTTP Method：</strong>POST</li>
                <li><strong>Path：</strong><code>/api/chat</code></li>
                <li><strong>Response Mode：</strong>Respond to Webhook</li>
            </ul>
            
            <h3>Code 節點（JavaScript）</h3>
            <p>每個 Code 節點對應一個處理步驟，建議將程式碼模組化，使用 <code>require</code> 或直接內嵌。</p>
            
            <h3>HTTP Request 節點（調用 Gemini API）</h3>
            <ul>
                <li><strong>Method：</strong>POST</li>
                <li><strong>URL：</strong><code>https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent</code></li>
                <li><strong>Authentication：</strong>Query Auth（<code>key</code> 參數）</li>
                <li><strong>Timeout：</strong>10000ms（10 秒）</li>
            </ul>
            
            <h3>Switch 節點</h3>
            <p>用於條件分支，例如：檢查特殊情況、FAQ 匹配結果等。</p>
            
            <h3>Set 節點</h3>
            <p>用於設置變數和構建回應格式。</p>
        </div>
        
        <div class="section">
            <h2>🔧 環境變數設定</h2>
            <p>在 n8n 中需要設定以下環境變數：</p>
            <ul>
                <li><code>GEMINI_API_KEY</code>: Google Gemini API 金鑰</li>
                <li><code>KNOWLEDGE_BASE_URL</code>: 知識庫 JSON 檔案的基礎 URL（可選，預設為相對路徑）</li>
            </ul>
        </div>
        
        <div class="section">
            <h2>📚 相關文檔</h2>
            <ul>
                <li><code>好時有影chatbot/README.md</code> - 專案說明</li>
                <li><code>好時有影chatbot/QUICK_START.md</code> - 快速啟動指南</li>
                <li><code>好時有影chatbot/knowledge/README.md</code> - 知識庫說明</li>
                <li><code>好時有影chatbot/functions/README.md</code> - Functions 說明</li>
            </ul>
        </div>
        
        <div style="margin-top: 50px; padding-top: 20px; border-top: 2px solid #e0e0e0; text-align: center; color: #7f8c8d;">
            <p>好時有影 AI 客服機器人 - n8n 流程圖文檔</p>
            <p>最後更新：2025-01-XX</p>
        </div>
    </div>
    
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
